# ============================
# Tab 1: 基本信息
# ============================
basicInfo:
  tableName: pm_project_approval
  tableComment: 项目审核表
  className: ProjectApproval
  functionAuthor: ruoyi
  remark: "项目审核记录表，记录每次审核的历史"

# ============================
# Tab 2: 字段信息
# ============================
columns:
  approval_id:
    columnComment: 审核主键ID
    javaType: Long
    javaField: approvalId
    isInsert: false
    isEdit: false
    isList: true
    isQuery: false
    queryType: EQ
    isRequired: false
    htmlType: input
    dictType: ""

  project_id:
    columnComment: 项目ID
    javaType: Long
    javaField: projectId
    isInsert: true
    isEdit: true
    isList: true
    isQuery: true
    queryType: EQ
    isRequired: true
    htmlType: input
    dictType: ""

  approval_status:
    columnComment: 审核状态
    javaType: String
    javaField: approvalStatus
    isInsert: true
    isEdit: true
    isList: true
    isQuery: true
    queryType: EQ
    isRequired: true
    htmlType: select
    dictType: sys_spzt

  approval_reason:
    columnComment: 审核原因/意见
    javaType: String
    javaField: approvalReason
    isInsert: true
    isEdit: true
    isList: true
    isQuery: false
    queryType: EQ
    isRequired: false
    htmlType: textarea
    dictType: ""

  approver_id:
    columnComment: 审核人ID
    javaType: Long
    javaField: approverId
    isInsert: true
    isEdit: true
    isList: true
    isQuery: true
    queryType: EQ
    isRequired: false
    htmlType: input
    dictType: ""

  approval_time:
    columnComment: 审核时间
    javaType: Date
    javaField: approvalTime
    isInsert: true
    isEdit: true
    isList: true
    isQuery: true
    queryType: BETWEEN
    isRequired: false
    htmlType: datetime
    dictType: ""

  del_flag:
    columnComment: 删除标志
    javaType: String
    javaField: delFlag
    isInsert: false
    isEdit: false
    isList: false
    isQuery: false
    queryType: EQ
    isRequired: false
    htmlType: input
    dictType: ""

  create_by:
    columnComment: 创建者
    javaType: String
    javaField: createBy
    isInsert: false
    isEdit: false
    isList: false
    isQuery: false
    queryType: EQ
    isRequired: false
    htmlType: input
    dictType: ""

  create_time:
    columnComment: 创建时间
    javaType: Date
    javaField: createTime
    isInsert: false
    isEdit: false
    isList: true
    isQuery: true
    queryType: BETWEEN
    isRequired: false
    htmlType: datetime
    dictType: ""

  update_by:
    columnComment: 更新者
    javaType: String
    javaField: updateBy
    isInsert: false
    isEdit: false
    isList: false
    isQuery: false
    queryType: EQ
    isRequired: false
    htmlType: input
    dictType: ""

  update_time:
    columnComment: 更新时间
    javaType: Date
    javaField: updateTime
    isInsert: false
    isEdit: false
    isList: false
    isQuery: false
    queryType: EQ
    isRequired: false
    htmlType: datetime
    dictType: ""

  remark:
    columnComment: 备注
    javaType: String
    javaField: remark
    isInsert: true
    isEdit: true
    isList: false
    isQuery: false
    queryType: EQ
    isRequired: false
    htmlType: textarea
    dictType: ""

# ============================
# Tab 3: 生成信息
# ============================
genInfo:
  tplCategory: crud
  tplWebType: element-plus
  packageName: com.ruoyi.project
  moduleName: project
  businessName: approval
  functionName: 项目审核
  parentMenuId: 2059

# ============================
# 定制需求（超出标准模板的组件/交互/接口需求）
# ============================
customizations:
  # ============================
  # 立项审核功能定制需求
  # ============================

  review_drawer_style:
    intent: "立项审核页面使用抽屉样式而非对话框，从右侧滑出，宽度80%，底部按钮固定"
    component:
      type: el-drawer
      props:
        direction: "rtl"
        size: "80%"
        closeOnClickModal: true
        closeOnPressEscape: false
        title: "动态显示项目名称"
    bindTo: page
    service: null
    notes: |
      实现位置：ruoyi-ui/src/views/project/review/index.vue

      抽屉配置：
      - 从右侧滑出，占据80%屏幕宽度
      - 标题动态显示：'审核项目 - ' + reviewForm.projectName
      - 关闭方式：点击遮罩层、右上角X按钮、取消按钮

      内容区域：
      - 7个折叠面板（基本信息、人员信息、预算信息、工作量信息、时间信息、项目描述、客户信息）
      - 审核意见表单放在折叠面板下方，用 el-divider 分隔
      - 内容区域可滚动

      底部按钮：
      - 固定在底部，右对齐
      - 通过按钮（绿色）、拒绝按钮（红色）、取消按钮（默认）
      - 样式：display: flex; justify-content: flex-end; gap: 10px;

      交互行为：
      - 审核成功后自动关闭抽屉并刷新列表
      - 拒绝时必须填写审核意见（前端校验）

      设计文档：docs/plans/2026-02-08-review-drawer-design.md

  review_approval_status_filter:
    intent: "立项审核查询条件支持审核状态筛选，默认显示待审核（0），可切换查看已通过（1）或已拒绝（2）"
    component:
      type: el-select
      props:
        dictType: "sys_spzt"
        defaultValue: "0"
        clearable: true
        placeholder: "请选择审核状态"
    bindTo: approval_status
    service:
      endpoint: "GET /project/review/list?approvalStatus={status}"
      source: "复用 ProjectReviewService.selectReviewList，ProjectMapper.xml - selectReviewList"
      returns: "分页列表数据"
      newApi: false
    notes: |
      实现位置：
      - 后端：ruoyi-project/src/main/resources/mapper/project/ProjectMapper.xml
      - 前端：ruoyi-ui/src/views/project/review/index.vue

      后端实现：
      - SQL 支持动态审核状态查询，不硬编码 approval_status='0'
      - WHERE 条件：<if test="approvalStatus != null and approvalStatus != ''">AND p.approval_status = #{approvalStatus}</if>
      - 移除原有的硬编码：WHERE p.approval_status = '0' AND p.del_flag = '0'
      - 改为：WHERE p.del_flag = '0' + 动态条件

      前端实现：
      - 查询参数：approvalStatus: '0'（默认值）
      - 字典类型：sys_spzt（审核状态字典）
      - 重置按钮后保持默认值：queryParams.value.approvalStatus = '0'

      功能增强：
      - 支持查询所有审核状态（待审核/已通过/已拒绝）
      - 默认显示待审核项目（最常用场景）
      - 可以查看审核历史和统计

  review_project_detail_collapse:
    intent: "审核抽屉中展示完整项目信息，使用折叠面板分7个模块展示，默认全部展开"
    component:
      type: el-collapse
      props:
        modelValue: "['1', '2', '3', '4', '5', '6', '7']"
    bindTo: page
    service:
      endpoint: "GET /project/review/{projectId}"
      source: "复用 ProjectReviewService.selectProjectById → ProjectMapper.selectProjectByProjectId"
      returns: "项目完整信息"
      newApi: false
    notes: |
      实现位置：ruoyi-ui/src/views/project/review/index.vue

      折叠面板模块（使用 el-descriptions 展示）：
      1. 基本信息（name="1"）：
         - 项目名称、项目编码、项目全称、项目部门
         - 项目分类（字典）、项目阶段（字典）
         - 一级区域（字典）、二级区域

      2. 人员信息（name="2"）：
         - 项目经理、市场经理、销售经理、团队负责人
         - 参与人员（跨2列显示）

      3. 预算信息（name="3"）：
         - 项目预算、成本预算
         - 人工成本、采购成本

      4. 工作量信息（name="4"）：
         - 预估工作量（人天）
         - 实际工作量（人天）

      5. 时间信息（name="5"）：
         - 启动日期、结束日期
         - 上线日期、验收日期
         - 日期格式：parseTime(date, '{y}-{m}-{d}')

      6. 项目描述（name="6"）：
         - 项目地址、项目计划、项目描述
         - 单列显示（:column="1"）

      7. 客户信息（name="7"）：
         - 客户名称、客户联系人
         - 商户联系人、商户电话

      数据加载：
      - 点击"审核"按钮时调用 getReview(projectId)
      - 数据存储在 reviewForm.value
      - 默认展开所有面板：activeNames.value = ['1', '2', '3', '4', '5', '6', '7']

  review_approval_action:
    intent: "审核操作支持通过和拒绝，拒绝时必须填写审核意见，审核后发送邮件通知"
    component:
      type: custom
      spec: |
        - 通过按钮：type="success"，绿色，审核意见可选
        - 拒绝按钮：type="danger"，红色，审核意见必填（前端校验）
        - 取消按钮：默认样式，关闭抽屉
        - 审核前弹出确认框：proxy.$modal.confirm()
        - 审核成功后提示并刷新列表：proxy.$modal.msgSuccess()
    bindTo: page
    service:
      endpoint: "POST /project/review/approve"
      source: "ProjectReviewService.approveProject"
      returns: "操作结果"
      newApi: false
    notes: |
      实现位置：
      - 后端 Service：ruoyi-project/.../service/impl/ProjectReviewServiceImpl.java
      - 后端 Controller：ruoyi-project/.../controller/ProjectReviewController.java
      - 前端：ruoyi-ui/src/views/project/review/index.vue

      后端实现：
      - Service 方法：approveProject(projectId, approvalStatus, approvalReason)
      - 更新字段：approval_status、approval_reason、approver_id、approval_time
      - 审核人ID：SecurityUtils.getUserId() 转 String
      - 审核时间：DateUtils.getNowDate()
      - 事务控制：@Transactional
      - 邮件通知：审核成功后调用 projectEmailService.sendApprovalNotification()（异步）

      前端实现：
      - submitApprove(approvalStatus) 方法
      - 拒绝时校验：if (approvalStatus === '2' && !approvalReason) { 提示错误 }
      - 确认框：'是否确认' + statusText + '该项目立项申请？'
      - 提交数据：{ projectId, approvalStatus, approvalReason }
      - 成功后：关闭抽屉 + 刷新列表

      邮件通知（可选功能）：
      - Service：IProjectEmailService.sendApprovalNotification()
      - 实现：ProjectEmailServiceImpl（@Async 异步）
      - 当前状态：仅日志记录，需配置 Spring Mail 才能实际发送
      - 邮件内容：项目名称、项目编码、审核结果、审核意见
      - 收件人：项目创建人（从 pm_project.create_by 查询用户邮箱）

  review_data_scope_control:
    intent: "团队负责人只能审核自己部门的项目，使用 @DataScope 注解实现数据权限控制"
    component: null
    bindTo: null
    service:
      endpoint: "GET /project/review/list"
      source: "ProjectReviewService.selectReviewList 使用 @DataScope(deptAlias='d', userAlias='u1')"
      returns: "过滤后的项目列表"
      newApi: false
    notes: |
      实现位置：
      - Service：ruoyi-project/.../service/impl/ProjectReviewServiceImpl.java
      - Mapper XML：ruoyi-project/.../mapper/project/ProjectMapper.xml

      后端实现：
      - Service 方法添加注解：@DataScope(deptAlias = "d", userAlias = "u1")
      - Mapper XML 使用占位符：${params.dataScope}
      - SQL 示例：
        WHERE p.del_flag = '0'
        ${params.dataScope}
        AND ...

      权限范围（根据角色配置）：
      - 1=全部数据权限：可以看到所有项目
      - 2=自定义数据权限：可以看到指定部门的项目
      - 3=本部门数据权限：只能看到本部门的项目
      - 4=本部门及以下数据权限：可以看到本部门及下级部门的项目
      - 5=仅本人数据权限：只能看到自己创建的项目

      岗位权限：
      - project:review:query - 项目审核查询权限
      - project:review:approve - 项目审核操作权限

      菜单配置：
      - 菜单名称：立项审核
      - 路由路径：/project/review
      - 组件路径：project/review/index
      - 父级菜单：项目管理（menu_id: 2059）
      - 菜单 SQL：pm-sql/init/02_menu_data.sql

  review_secondary_region_join:
    intent: "审核列表关联二级区域表显示省份名称，修复表名错误（pm_province → pm_secondary_region）"
    component: null
    bindTo: provinceName
    service:
      endpoint: "GET /project/review/list"
      source: "ProjectMapper.xml - selectReviewList"
      returns: "列表数据包含 provinceName"
      newApi: false
    notes: |
      实现位置：ruoyi-project/.../mapper/project/ProjectMapper.xml

      问题修复：
      - 原错误：LEFT JOIN pm_province pr ON p.province_id = pr.province_id
      - 修复后：LEFT JOIN pm_secondary_region pr ON p.province_id = pr.province_id
      - 原因：数据库中实际表名是 pm_secondary_region，不是 pm_province

      SQL 实现：
      SELECT
        p.project_id,
        p.project_name,
        ...
        pr.province_name
      FROM pm_project p
      LEFT JOIN pm_secondary_region pr ON p.province_id = pr.province_id
      WHERE p.del_flag = '0'

      前端显示：
      - 列表列：<el-table-column label="二级区域" prop="provinceName" />
      - 审核抽屉：<el-descriptions-item label="二级区域">{{ reviewForm.provinceName }}</el-descriptions-item>

  review_query_conditions:
    intent: "立项审核查询条件包含8个字段，支持多条件组合查询"
    component:
      type: el-form
      props:
        inline: true
        labelWidth: "100px"
    bindTo: page
    service:
      endpoint: "GET /project/review/list"
      source: "ProjectReviewService.selectReviewList"
      returns: "分页列表数据"
      newApi: false
    notes: |
      实现位置：ruoyi-ui/src/views/project/review/index.vue

      查询条件（8个）：
      1. 项目名称（projectName）：
         - 类型：el-input
         - 查询方式：LIKE（模糊查询）
         - 宽度：200px

      2. 项目部门（projectDept）：
         - 类型：el-tree-select
         - 数据源：/system/dept/treeselect
         - 查询方式：EQ
         - 宽度：200px

      3. 项目分类（projectCategory）：
         - 类型：el-select
         - 字典：sys_xmfl
         - 查询方式：EQ
         - 宽度：200px

      4. 一级区域（region）：
         - 类型：el-select
         - 字典：sys_yjqy
         - 查询方式：EQ
         - 宽度：200px
         - 联动：选择后加载二级区域

      5. 二级区域（provinceId）：
         - 类型：el-select
         - 数据源：/project/secondaryRegion/list?regionCode={region}
         - 查询方式：EQ
         - 宽度：200px
         - 依赖：一级区域

      6. 项目经理（projectManagerId）：
         - 类型：el-select
         - 数据源：/system/user/listByPost?postCode=xmjl
         - 查询方式：EQ
         - 宽度：200px
         - 可搜索：filterable

      7. 市场经理（marketManagerId）：
         - 类型：el-select
         - 数据源：/system/user/listByPost?postCode=scjl
         - 查询方式：EQ
         - 宽度：200px
         - 可搜索：filterable

      8. 审核状态（approvalStatus）：
         - 类型：el-select
         - 字典：sys_spzt
         - 查询方式：EQ
         - 宽度：200px
         - 默认值：'0'（待审核）

      操作按钮：
      - 搜索：type="primary"，icon="Search"
      - 重置：icon="Refresh"，重置后保持 approvalStatus='0'

  review_list_display:
    intent: "立项审核列表展示11个列，包含项目基本信息和操作按钮"
    component:
      type: el-table
      props:
        loading: true
        data: "reviewList"
    bindTo: page
    service:
      endpoint: "GET /project/review/list"
      source: "ProjectReviewService.selectReviewList"
      returns: "分页列表数据"
      newApi: false
    notes: |
      实现位置：ruoyi-ui/src/views/project/review/index.vue

      列表列（11个）：
      1. 序号：type="index"，width="55"
      2. 项目名称：prop="projectName"，min-width="150"，show-overflow-tooltip
      3. 项目编码：prop="projectCode"，min-width="150"，show-overflow-tooltip
      4. 项目部门：prop="deptName"，min-width="120"，show-overflow-tooltip
      5. 项目经理：prop="projectManagerName"，min-width="100"
      6. 市场经理：prop="marketManagerName"，min-width="100"
      7. 项目分类：prop="projectCategory"，width="100"，使用 dict-tag
      8. 一级区域：prop="region"，width="100"，使用 dict-tag
      9. 二级区域：prop="provinceName"，width="100"
      10. 项目阶段：prop="projectStatus"，width="100"，使用 dict-tag
      11. 创建时间：prop="createTime"，width="160"，使用 parseTime 格式化

      操作列：
      - 宽度：120px
      - 固定：fixed="right"
      - 审核按钮：link type="primary" icon="Edit"
      - 权限：v-hasPermi="['project:review:approve']"

      分页组件：
      - 组件：<pagination>
      - 绑定：total、pageNum、pageSize
      - 事件：@pagination="getList"
