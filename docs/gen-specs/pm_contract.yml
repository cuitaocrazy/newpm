# ============================
# Tab 1: 基本信息
# ============================
basicInfo:
  tableName: pm_contract
  tableComment: 合同管理表
  className: Contract
  functionAuthor: ruoyi
  remark: |
    功能更新记录：

    1. 从项目列表添加合同功能 (2026-02-13完成)
       - 功能描述：在项目管理列表的操作列添加"添加合同"按钮，点击后跳转到合同新增页面并自动填充项目信息
       - 路由跳转：
         * 跳转URL：/contract/contract/add?projectId={projectId}
         * 路由参数：通过 query 参数传递 projectId
         * 目标页面：ruoyi-ui/src/views/contract/contract/add.vue
       - 自动填充逻辑：
         * 在 onMounted 中检测 route.query.projectId
         * 如果存在 projectId，则调用后端接口获取项目详情
         * 自动填充字段：
           - form.projectId = project.projectId（用于提交）
           - form.projectName = project.projectName（用于显示）
           - form.deptId = project.projectDept（项目部门ID）
           - form.customerId = project.customerId（客户ID）
       - 项目信息展示区域：
         * 位置：合同基本信息模块的第一个字段区域
         * 显示内容：只读展示项目名称和项目部门
         * 显示条件：v-if="form.projectId"（仅当从项目列表跳转时显示）
         * 布局：使用 el-alert 组件，类型为 info，不可关闭
         * 内容格式："关联项目：{projectName} | 项目部门：{deptName}"
       - 实现文件：
         * 前端：ruoyi-ui/src/views/contract/contract/add.vue
         * 后端API：GET /project/project/{projectId}（复用现有接口）
       - 用户体验优化：
         * 避免手动选择项目和客户，减少操作步骤
         * 自动关联项目和合同，确保数据一致性
         * 明确展示关联的项目信息，提高信息透明度

    2. 合同编号唯一性校验功能 (2026-02-13实现)
       - 功能描述：在合同新增和编辑页面，对合同编号进行唯一性校验
       - 校验时机：
         * 用户输入合同编号后失去焦点时触发（@blur事件）
         * 实时校验，无需等待表单提交
       - 校验逻辑：
         * 前端：调用 checkContractCodeUnique API
         * 后端：ContractServiceImpl.checkContractCodeUnique 方法
         * 编辑模式：排除当前合同自身（传入 contractId）
         * 新增模式：检查所有合同（contractId 为 null）
       - 校验提示：
         * 重复提示：显示红色错误提示"合同编号已存在"
         * 可用提示：显示绿色成功提示"合同编号可用"
         * 清空提示：清空合同编号时，清除所有提示
       - 表单验证：
         * 集成到 el-form 验证规则中
         * 阻止提交：如果合同编号重复，表单提交时会阻止
       - 实现文件：
         * 前端：ruoyi-ui/src/views/contract/contract/add.vue, edit.vue
         * 后端API：GET /project/contract/checkContractCodeUnique
         * 后端Service：ContractServiceImpl.checkContractCodeUnique
       - 注意事项：
         * 虽然数据库没有唯一约束，但通过应用层校验保证唯一性
         * 校验是精确匹配（EQ），不是模糊匹配（LIKE）
         * 支持编辑模式下排除自身的逻辑

    3. Element Plus 按钮类型废弃警告修复 (2026-02-13完成)
       - 问题描述：控制台出现警告 "[Element Warn][ElButton] type 'link' is deprecated, use 'text' instead."
       - 废弃原因：Element Plus 升级后，按钮类型 type="link" 已被废弃，推荐使用 type="text"
       - 修复内容：
         * 文件：ruoyi-ui/src/views/contract/contract/index.vue
         * 修改位置：操作列的所有按钮
         * 修改前：<el-button type="link">
         * 修改后：<el-button type="text" link>
       - 注意事项：
         * 新语法需要两个属性：type="text" + link
         * type="text"：定义按钮为文本按钮
         * link：应用链接样式（颜色和悬停效果）
       - 影响范围：
         * 合同列表页面的所有操作按钮
         * 详情、编辑、款项、附件、删除按钮
       - 视觉效果：
         * 外观和交互效果与之前完全一致
         * 仅修复了底层实现，消除了废弃警告

# ============================
# Tab 2: 字段信息
# ============================
columns:
  contract_id:
    columnComment: 合同主键ID
    columnType: bigint
    javaType: Long
    javaField: contractId
    isInsert: true
    isEdit: false
    isList: false
    isQuery: false
    queryType: EQ
    isRequired: false
    htmlType: input
    dictType: ""
  contract_code:
    columnComment: 合同编号
    columnType: varchar(100)
    javaType: String
    javaField: contractCode
    isInsert: true
    isEdit: true
    isList: false
    isQuery: true
    queryType: EQ
    isRequired: false
    htmlType: input
    dictType: ""
    excelConfig:
      export: true
      name: 合同编号
      sort: 0
    notes: |
      合同编号不做唯一性校验：
      - 数据库层面删除了 UNIQUE KEY uk_contract_code 约束
      - 添加了普通索引 idx_contract_code 以提高查询性能
      - 允许重复的合同编号
  contract_name:
    columnComment: 合同名称
    columnType: varchar(200)
    javaType: String
    javaField: contractName
    isInsert: true
    isEdit: true
    isList: true
    isQuery: true
    queryType: LIKE
    isRequired: true
    htmlType: input
    dictType: ""
    excelConfig:
      export: true
      name: 合同名称
      sort: 1
    notes: |
      合同名称唯一性校验：
      - 新增和编辑时校验合同名称唯一性
      - 校验方式：精确匹配（EQ），不使用模糊匹配（LIKE）
      - 避免误判：例如"测试合同"和"测试合同1"不会被误判为重复
      - 前端失去焦点时触发校验
      - 后端 Service 层实现唯一性检查逻辑
  customer_id:
    columnComment: 关联客户ID
    columnType: bigint
    javaType: Long
    javaField: customerId
    isInsert: true
    isEdit: true
    isList: true
    isQuery: true
    queryType: EQ
    isRequired: true
    htmlType: input
    dictType: ""
  dept_id:
    columnComment: 部门ID
    columnType: bigint
    javaType: Long
    javaField: deptId
    isInsert: true
    isEdit: true
    isList: true
    isQuery: true
    queryType: EQ
    isRequired: true
    htmlType: input
    dictType: ""
  contract_type:
    columnComment: 合同类型
    columnType: varchar(50)
    javaType: String
    javaField: contractType
    isInsert: true
    isEdit: true
    isList: true
    isQuery: true
    queryType: EQ
    isRequired: true
    htmlType: select
    dictType: sys_htlx
    excelConfig:
      export: true
      name: 合同类型
      sort: 4
      dictType: sys_htlx
  contract_status:
    columnComment: 合同状态
    columnType: varchar(50)
    javaType: String
    javaField: contractStatus
    isInsert: true
    isEdit: true
    isList: true
    isQuery: true
    queryType: EQ
    isRequired: false
    htmlType: select
    dictType: sys_htzt
    excelConfig:
      export: true
      name: 合同状态
      sort: 5
      dictType: sys_htzt
    notes: |
      合同状态字典值及颜色标识：
      - 1-已签：success (绿色) - 合同已正式签订，状态正常
      - 2-未签：warning (橙色) - 合同尚未签订，需要关注
      - 3-待变更：info (蓝色) - 合同需要变更，处于待处理状态
      - 4-已变更：primary (深蓝色) - 合同已完成变更
      - 5-合同作废：danger (红色) - 合同已作废，需要特别注意

      颜色配置：
      - 数据库字段：sys_dict_data.list_class
      - 前端组件：<dict-tag> 自动根据 list_class 显示对应颜色
      - SQL脚本：pm-sql/fix_contract_status_color.sql

  contract_sign_date:
    columnComment: 合同签订日期
    columnType: date
    javaType: Date
    javaField: contractSignDate
    isInsert: true
    isEdit: true
    isList: true
    isQuery: false
    queryType: EQ
    isRequired: true
    htmlType: datetime
    dictType: ""
    excelConfig:
      export: true
      name: 合同签订日期
      sort: 6
      width: 30
      dateFormat: yyyy-MM-dd
  contract_period:
    columnComment: 合同周期(月)
    columnType: int
    javaType: Integer
    javaField: contractPeriod
    isInsert: true
    isEdit: true
    isList: true
    isQuery: false
    queryType: EQ
    isRequired: false
    htmlType: input
    dictType: ""
    excelConfig:
      export: true
      name: 合同周期(月)
      sort: 7
  contract_amount:
    columnComment: 合同金额(含税)
    columnType: decimal(15,2)
    javaType: BigDecimal
    javaField: contractAmount
    isInsert: true
    isEdit: true
    isList: true
    isQuery: false
    queryType: EQ
    isRequired: true
    htmlType: input
    dictType: ""
    excelConfig:
      export: true
      name: 合同金额(含税)
      sort: 8
  tax_rate:
    columnComment: 税率(%)
    columnType: decimal(5,2)
    javaType: BigDecimal
    javaField: taxRate
    isInsert: true
    isEdit: true
    isList: false
    isQuery: false
    queryType: EQ
    isRequired: false
    htmlType: input
    dictType: ""
    excelConfig:
      export: true
      name: 税率(%)
      sort: 9
    notes: |
      税率字段说明：
      - 前端表单不设置默认值，由用户自行填写
      - 用于自动计算不含税金额和税金
      - 计算公式：不含税金额 = 合同金额 / (1 + 税率/100)
  amount_no_tax:
    columnComment: 不含税金额
    columnType: decimal(15,2)
    javaType: BigDecimal
    javaField: amountNoTax
    isInsert: true
    isEdit: true
    isList: true
    isQuery: false
    queryType: EQ
    isRequired: false
    htmlType: input
    dictType: ""
    excelConfig:
      export: true
      name: 不含税金额
      sort: 10
  tax_amount:
    columnComment: 税金
    columnType: decimal(15,2)
    javaType: BigDecimal
    javaField: taxAmount
    isInsert: true
    isEdit: true
    isList: false
    isQuery: false
    queryType: EQ
    isRequired: false
    htmlType: input
    dictType: ""
    excelConfig:
      export: true
      name: 税金
      sort: 11
  confirm_amount:
    columnComment: 合同确认金额
    columnType: decimal(15,2)
    javaType: BigDecimal
    javaField: confirmAmount
    isInsert: true
    isEdit: true
    isList: false
    isQuery: false
    queryType: EQ
    isRequired: false
    htmlType: input
    dictType: ""
    excelConfig:
      export: true
      name: 合同确认金额
      sort: 12
  confirm_year:
    columnComment: 确认年份
    columnType: varchar(10)
    javaType: String
    javaField: confirmYear
    isInsert: true
    isEdit: true
    isList: false
    isQuery: true
    queryType: EQ
    isRequired: false
    htmlType: select
    dictType: sys_ndgl
    excelConfig:
      export: true
      name: 确认年份
      sort: 13
      dictType: sys_ndgl
  free_maintenance_period:
    columnComment: 免维期(月)
    columnType: int
    javaType: Integer
    javaField: freeMaintenancePeriod
    isInsert: true
    isEdit: true
    isList: true
    isQuery: false
    queryType: EQ
    isRequired: false
    htmlType: input
    dictType: ""
    excelConfig:
      export: true
      name: 免维期(月)
      sort: 14
  del_flag:
    columnComment: 删除标志
    columnType: char(1)
    javaType: String
    javaField: delFlag
    isInsert: true
    isEdit: true
    isList: false
    isQuery: false
    queryType: EQ
    isRequired: false
    htmlType: input
    dictType: ""
  create_by:
    columnComment: 创建者
    columnType: varchar(64)
    javaType: String
    javaField: createBy
    isInsert: true
    isEdit: false
    isList: false
    isQuery: false
    queryType: EQ
    isRequired: false
    htmlType: input
    dictType: ""
  create_time:
    columnComment: 创建时间
    columnType: datetime
    javaType: Date
    javaField: createTime
    isInsert: true
    isEdit: false
    isList: false
    isQuery: false
    queryType: EQ
    isRequired: false
    htmlType: datetime
    dictType: ""
  update_by:
    columnComment: 更新者
    columnType: varchar(64)
    javaType: String
    javaField: updateBy
    isInsert: false
    isEdit: false
    isList: false
    isQuery: false
    queryType: EQ
    isRequired: false
    htmlType: input
    dictType: ""
    notes: |
      更新人字段说明：
      - 后端自动填充：contract.setUpdateBy(SecurityUtils.getUsername())
      - 编辑页面展示：通过 updateByName 字段显示用户姓名
      - Service 层查询时关联 sys_user 表获取用户姓名
  update_time:
    columnComment: 更新时间
    columnType: datetime
    javaType: Date
    javaField: updateTime
    isInsert: false
    isEdit: false
    isList: false
    isQuery: false
    queryType: EQ
    isRequired: false
    htmlType: datetime
    dictType: ""
    notes: |
      更新时间字段说明：
      - 后端自动填充：contract.setUpdateTime(DateUtils.getNowDate())
      - 编辑页面展示更新时间
  remark:
    columnComment: 备注
    columnType: varchar(500)
    javaType: String
    javaField: remark
    isInsert: true
    isEdit: true
    isList: true
    isQuery: false
    queryType: EQ
    isRequired: false
    htmlType: textarea
    dictType: ""
  reserved_field1:
    columnComment: 备用域1
    columnType: varchar(64)
    javaType: String
    javaField: reservedField1
    isInsert: false
    isEdit: false
    isList: false
    isQuery: false
    queryType: EQ
    isRequired: false
    htmlType: input
    dictType: ""
  reserved_field2:
    columnComment: 备用域2
    columnType: varchar(64)
    javaType: String
    javaField: reservedField2
    isInsert: false
    isEdit: false
    isList: false
    isQuery: false
    queryType: EQ
    isRequired: false
    htmlType: input
    dictType: ""
  reserved_field3:
    columnComment: 备用域3
    columnType: varchar(64)
    javaType: String
    javaField: reservedField3
    isInsert: false
    isEdit: false
    isList: false
    isQuery: false
    queryType: EQ
    isRequired: false
    htmlType: input
    dictType: ""
  reserved_field4:
    columnComment: 备用域4
    columnType: varchar(64)
    javaType: String
    javaField: reservedField4
    isInsert: false
    isEdit: false
    isList: false
    isQuery: false
    queryType: EQ
    isRequired: false
    htmlType: input
    dictType: ""
  reserved_field5:
    columnComment: 备用域5
    columnType: varchar(64)
    javaType: String
    javaField: reservedField5
    isInsert: false
    isEdit: false
    isList: false
    isQuery: false
    queryType: EQ
    isRequired: false
    htmlType: input
    dictType: ""

# ============================
# 扩展字段（关联查询字段，不在数据库表中）
# ============================
extendedFields:
  customerName:
    columnComment: 客户名称（关联查询）
    javaType: String
    javaField: customerName
    source: pm_customer.customer_simple_name
    description: 用于列表页显示和导出
    excelConfig:
      export: true
      name: 客户名称
      sort: 3

  deptName:
    columnComment: 部门名称（关联查询）
    javaType: String
    javaField: deptName
    source: sys_dept.dept_name
    description: 用于列表页显示和导出
    excelConfig:
      export: true
      name: 部门名称
      sort: 2

  contractTypeName:
    columnComment: 合同类型名称（关联查询）
    javaType: String
    javaField: contractTypeName
    source: sys_dict_data.dict_label
    description: 用于列表页显示

  contractStatusName:
    columnComment: 合同状态名称（关联查询）
    javaType: String
    javaField: contractStatusName
    source: sys_dict_data.dict_label
    description: 用于列表页显示

  createByName:
    columnComment: 创建人姓名（关联查询）
    javaType: String
    javaField: createByName
    source: sys_user.nick_name
    description: 用于列表页显示

  updateByName:
    columnComment: 更新人姓名（关联查询）
    javaType: String
    javaField: updateByName
    source: sys_user.nick_name
    description: 用于列表页显示

  paymentList:
    columnComment: 付款里程碑列表（主子表关联）
    javaType: List<Payment>
    javaField: paymentList
    source: pm_payment
    description: 用于主子表模式，一个合同包含多个付款里程碑

# ============================
# Tab 3: 生成信息
# ============================
genInfo:
  tplCategory: crud
  tplWebType: element-plus
  packageName: com.ruoyi.project
  moduleName: project
  businessName: contract
  functionName: 合同管理
  parentMenuId: 3

# ============================
# 定制需求
# ============================
customizations:
  # ==================
  # 列表页定制
  # ==================
  list_query_form:
    intent: "查询表单字段配置和顺序"
    component:
      type: el-form
      props:
        inline: true
        labelWidth: "100px"
    bindTo: query_form
    service: null
    notes: |
      查询表单字段顺序（从左到右）：

      基础字段（默认显示）：
      1. 合同名称 - 输入框，支持模糊查询
      2. 部门 - 树形选择器，从第三级开始展示
      3. 客户 - 下拉选择器，支持筛选
      4. 合同类型 - 下拉选择器，字典 sys_htlx
      5. 合同状态 - 下拉选择器，字典 sys_htzt

      高级字段（点击"更多"展开）：
      1. 合同编号 - 输入框，精确查询
      2. 合同签订日期 - 日期选择器
      3. 合同确认金额 - 输入框
      4. 确认年份 - 下拉选择器，字典 sys_ndgl

      字段顺序优化说明：
      - 合同名称作为最常用的模糊查询条件，放在第一位
      - 部门作为重要的组织维度查询条件，放在第二位
      - 合同编号为精确查询，使用频率相对较低，移到"更多"中
      - 基础查询条件保持5个，界面简洁易用

  list_toolbar_buttons:
    intent: "工具栏只保留查询、重置、新增、导出4个按钮"
    component:
      type: custom
      spec: "保留查询、重置、新增、导出按钮"
    bindTo: toolbar
    service: null
    notes: |
      纯前端修改

      导出功能配置：
      1. 导出文件名格式：合同管理_yyyyMMddHHmmss.xlsx
         - 示例：合同管理_20260209153045.xlsx
         - 使用中文名称，便于识别
         - 时间戳格式：年月日时分秒（yyyyMMddHHmmss）

      2. 导出字段配置：
         - 客户ID改为客户名称（导出 customerName 字段）
         - 部门ID改为部门名称（导出 deptName 字段）
         - 合同类型展示字典标签（使用 dictType = "sys_htlx"）
         - 合同状态展示字典标签（使用 dictType = "sys_htzt"）
         - 不导出备用域1-5字段

      3. 导出列顺序：
         1. 合同编号
         2. 合同名称
         3. 部门名称（紧跟合同名称）
         4. 客户名称（紧跟部门名称）
         5. 合同类型
         6. 合同状态
         7. 合同签订日期
         8. 合同周期(月)
         9. 合同金额(含税)
         10. 税率(%)
         11. 不含税金额
         12. 税金
         13. 合同确认金额
         14. 确认年份
         15. 免维期(月)

         说明：部门名称和客户名称放在合同名称之后、合同类型之前，
         更符合业务逻辑（先看合同基本信息，再看合同属性）

      4. 后端实体类配置（Contract.java）：
         - customerId：不添加 @Excel 注解（不导出ID）
         - deptId：不添加 @Excel 注解（不导出ID）
         - customerName：添加 @Excel(name = "客户名称", sort = 3)
         - deptName：添加 @Excel(name = "部门名称", sort = 2)
         - contractType：添加 @Excel(name = "合同类型", sort = 4, dictType = "sys_htlx")
         - contractStatus：添加 @Excel(name = "合同状态", sort = 5, dictType = "sys_htzt")
         - reservedField1~5：不添加 @Excel 注解（不导出备用域）

      5. 前端导出方法实现（index.vue）：
         ```javascript
         function handleExport() {
           const timestamp = proxy.parseTime(new Date(), '{y}{m}{d}{h}{i}{s}')
           proxy.download('project/contract/export', {
             ...queryParams.value
           }, `合同管理_${timestamp}.xlsx`)
         }
         ```
         说明：必须传递第三个参数（文件名）给 proxy.download 方法

      6. 导出效果：
         - Excel 文件包含可读的名称字段，不再是ID
         - 字典字段显示标签名，不再是字典值
         - 文件名清晰易识别，包含时间戳
         - 去除无用的备用域字段
         - 列顺序符合业务逻辑，便于阅读

  list_operation_buttons:
    intent: "操作列包含编辑、删除、详情、附件按钮"
    component:
      type: custom
      spec: "操作列显示编辑、删除、详情、附件按钮"
    bindTo: table_operations
    service: null
    notes: "删除按钮需要确认提示"

  list_dept_tree_select:
    intent: "部门选择，树形结构，任意层级可选"
    component:
      type: el-tree-select
      props:
        data: "部门树数据"
        checkStrictly: true
        valueKey: "id"
        renderAfterExpand: false
    bindTo: dept_id
    service:
      endpoint: "GET /system/dept/treeselect"
      source: "复用 SysDeptService，RuoYi 自带"
      returns: "部门树结构数据"
      newApi: false
    notes: |
      查询表单使用部门树选择

      部门展示层级优化：
      - 部门选择器从第三级开始展示，过滤掉第一级和第二级部门
      - 第三级及以下的部门保留完整的层级结构
      - 第三级部门会被提升到根层级显示（扁平化展示）

      前端实现：
      - 使用 filterDeptFromLevel3 函数进行过滤处理
      - 递归遍历部门树，level < 3 的节点不保留，但继续处理其子节点
      - level >= 3 的节点及其所有子节点都会被保留

      实现代码（index.vue）：
      ```javascript
      function filterDeptFromLevel3(deptTree, level = 1) {
        if (!deptTree || !Array.isArray(deptTree)) return []
        const result = []
        for (const dept of deptTree) {
          if (level >= 3) {
            // 第三级及以下，保留该节点
            const newDept = { ...dept }
            if (dept.children && dept.children.length > 0) {
              newDept.children = filterDeptFromLevel3(dept.children, level + 1)
            }
            result.push(newDept)
          } else {
            // 第一级和第二级，只递归处理子节点
            if (dept.children && dept.children.length > 0) {
              const childrenResult = filterDeptFromLevel3(dept.children, level + 1)
              result.push(...childrenResult)
            }
          }
        }
        return result
      }
      ```

  list_customer_select:
    intent: "客户选择，显示客户简称，提交客户ID"
    component:
      type: el-select
      props:
        filterable: true
        clearable: true
        placeholder: "请选择客户"
    bindTo: customer_id
    service:
      endpoint: "GET /project/customer/listAll"
      source: "复用 PmCustomerService，需新增轻量接口返回 customerId + customerSimpleName"
      returns: "[{ customerId, customerSimpleName }]"
      newApi: true
    notes: "查询表单使用客户下拉选择"

  list_table_index_column:
    intent: "列表第一列增加序号列"
    component:
      type: el-table-column
      props:
        type: "index"
        label: "序号"
        width: "60"
    bindTo: table
    service: null
    notes: "纯前端修改"

  list_column_order_and_width:
    intent: "列表展示列的顺序和列宽"
    component:
      type: custom
      spec: |
        列展示顺序（从左到右）：
        1. 序号 (60px)
        2. 合同名称 (200px)
        3. 关联项目 (180px) - 分行展示，每个项目占一行
        4. 客户名称 (150px)
        5. 部门 (120px)
        6. 合同类型 (100px)
        7. 合同状态 (100px)
        8. 合同签订日期 (120px)
        9. 合同周期（月）(110px)
        10. 合同金额（元）(130px)
        11. 不含税金额（元）(140px)
        12. 免维期（月）(110px)
        13. 备注 (150px)
        14. 创建日期 (180px)
        15. 创建人 (100px)
        16. 最后更新日期 (180px)
        17. 最后更新人 (100px)
        18. 操作 (280px, fixed right)
    bindTo: table
    service: null
    notes: |
      - 删除了"合同编号"和"税金(元)"列
      - 新增了"关联项目"、"合同状态"、"合同签订日期"、"合同周期（月）"、"免维期（月）"、"备注"列
      - 新增了审计信息列："创建日期"、"创建人"、"最后更新日期"、"最后更新人"
      - 所有列都添加 show-overflow-tooltip 属性
      - 审计信息列显示在备注列之后、操作列之前
      - 创建日期和最后更新日期显示格式：yyyy-MM-dd HH:mm:ss
      - 创建人和最后更新人显示用户姓名（createByName/updateByName），如果姓名为空则显示用户名（createBy/updateBy）

      合同名称列交互优化（2026-02-09）：
      - 合同名称显示为蓝色链接（el-link 组件）
      - 左键点击：在当前页面跳转到合同详情页
      - 右键点击：浏览器显示"在新标签页打开"选项，可在新标签页打开详情页
      - 实现方式：
        * 使用 @click 事件处理左键点击
        * 使用 @contextmenu.prevent 事件处理右键点击
        * 右键点击调用 window.open(url, '_blank') 在新标签页打开
      - 优化原因：提升用户体验，提供更灵活的导航方式
      - 修改文件：ruoyi-ui/src/views/project/contract/index.vue:141-151

      关联项目列显示优化（2026-02-09）：
      - 多个项目时每个项目占一行显示（使用 div 标签换行）
      - 项目名称左对齐（align="left"）
      - 每个项目前添加序号标识（格式：1、项目名称）
      - 显示效果示例：
        ```
        1、项目A
        2、项目B
        3、项目C
        ```
      - 优化原因：
        * 左对齐更符合阅读习惯
        * 序号标识清晰区分多个项目
        * 换行显示避免项目名称过长时显示不全
      - 修改文件：ruoyi-ui/src/views/project/contract/index.vue:152-163


  list_display_names:
    intent: "列表中部门、客户、合同类型、关联项目、创建人、更新人展示名称而非ID"
    component:
      type: custom
      spec: "列表查询时关联查询名称字段，前端展示名称"
    bindTo: [dept_id, customer_id, contract_type, project_list, create_by, update_by]
    service:
      endpoint: "GET /project/contract/list (修改)"
      source: "修改 ContractServiceImpl.selectContractList，关联查询名称和项目列表"
      returns: "列表数据包含 deptName, customerName, contractTypeName, projectList, createByName, updateByName"
      newApi: false
    notes: |
      后端修改：
      - deptName: LEFT JOIN sys_dept ON pm_contract.dept_id = sys_dept.dept_id
      - customerName: LEFT JOIN pm_customer ON pm_contract.customer_id = pm_customer.customer_id (取customer_simple_name)
      - contractTypeName: 字典翻译 sys_htlx
      - projectList: 为每个合同查询关联项目列表（通过 pm_project_contract_rel 关联表）
      - createByName: LEFT JOIN sys_user u1 ON pm_contract.create_by = u1.user_name (取u1.nick_name)
      - updateByName: LEFT JOIN sys_user u2 ON pm_contract.update_by = u2.user_name (取u2.nick_name)

      实现代码（ContractServiceImpl.selectContractList）：
      ```java
      List<Contract> contractList = contractMapper.selectContractList(contract);
      // 为每个合同查询关联项目列表
      for (Contract c : contractList) {
          List<Project> projectList = projectMapper.selectProjectListByContractId(c.getContractId());
          c.setProjectList(projectList);
      }
      return contractList;
      ```

      前端显示逻辑：
      - 创建人和更新人优先显示姓名（createByName/updateByName）
      - 如果姓名为空，降级显示用户名（createBy/updateBy）
      - 显示代码：{{ scope.row.createByName || scope.row.createBy }}

  list_table_summary:
    intent: "列表首行显示合同金额、不含税金额的总计（所有查询结果的总计，非当前页）"
    component:
      type: custom
      spec: |
        合计行作为表格第一行数据显示：
        - 合同名称列显示"合计"（粗体）
        - 序号列显示"-"
        - 合同金额、不含税金额显示总计值（粗体）
        - 其他列为空
        - 操作列为空
    bindTo: table
    service:
      endpoint: "GET /project/contract/list (修改)"
      source: "修改查询接口，返回总计数据"
      returns: "{ rows: [...], total: 100, extra: { summary: { contractAmountSum, amountNoTaxSum } } }"
      newApi: false
    notes: |
      后端实现：
      1. Controller 层（ContractController.list）：
         ```java
         TableDataInfo dataInfo = getDataTable(list);
         // 添加金额总计
         Map<String, BigDecimal> summary = contractService.selectContractSummary(contract);
         dataInfo.put("summary", summary);
         return dataInfo;
         ```

      2. Mapper 层（ContractMapper.xml - selectContractSummary）：
         ```sql
         select
             IFNULL(SUM(c.contract_amount), 0) as contractAmountSum,
             IFNULL(SUM(c.amount_no_tax), 0) as amountNoTaxSum
         from pm_contract c
         <where>
             c.del_flag = '0'
             -- 与列表查询相同的条件（支持按部门、客户、合同类型等过滤）
         </where>
         ```

      前端实现：
      1. 定义响应式变量存储总计数据：const summaryData = ref({})
      2. 从 response.extra.summary 获取后端返回的总计数据
      3. 使用 computed 计算属性构建带合计行的表格数据
      4. 通过 v-if="scope.row.isSummary" 判断是否为合计行，控制显示内容

      关键特性：
      - 计算的是所有查询结果的总计，不是当前页的总计
      - 支持查询条件过滤（部门、客户、合同类型、合同状态、确认年份等）
      - 总计金额以粗体显示，并保留两位小数

      前端数据获取（index.vue - getList）：
      ```javascript
      function getList() {
        loading.value = true
        listContract(queryParams.value).then(response => {
          console.log('合同列表响应数据:', response)
          contractList.value = response.rows
          total.value = response.total
          // 从 extra.summary 中获取总计数据
          summaryData.value = (response.extra && response.extra.summary) || {}
          console.log('总计数据:', summaryData.value)
          loading.value = false
        })
      }
      ```

      前端合计行构建（index.vue - tableDataWithSummary）：
      ```javascript
      const summaryData = ref({})
      const tableDataWithSummary = computed(() => {
        if (contractList.value.length === 0) {
          return []
        }
        // 使用后端返回的总计数据
        const summary = {
          isSummary: true,
          contractAmount: Number(summaryData.value.contractAmountSum || 0).toFixed(2),
          amountNoTax: Number(summaryData.value.amountNoTaxSum || 0).toFixed(2)
        }
        // 将合计行放在第一行
        return [summary, ...contractList.value]
      })
      ```

      数据结构说明：
      - 后端通过 TableDataInfo.put("summary", summary) 将总计数据放入 extra 中
      - 前端从 response.extra.summary 获取，而不是 response.summary
      - summary 对象包含：contractAmountSum（合同金额总计）、amountNoTaxSum（不含税金额总计）

      调试说明：
      - 已添加 console.log 输出，可在浏览器控制台查看返回数据结构
      - 检查 response.extra.summary 是否包含 contractAmountSum 和 amountNoTaxSum
      - 如果数据为空，检查后端 selectContractSummary 方法是否正确执行
      - 测试完成后可删除 console.log 调试代码

  list_delete_confirm:
    intent: "删除合同时弹出确认提示，显示合同名称；检查关联款项和附件，不允许删除"
    component:
      type: el-message-box
      props:
        message: "确认删除【{contract_name}】吗？"
        type: "warning"
    bindTo: delete_button
    service:
      endpoint: "DELETE /project/contract/:contractId"
      source: "修改 ContractServiceImpl.deleteContractByIds，检查款项和附件，逻辑删除合同及关联数据"
      returns: "{ code: 200, msg: '删除成功' } 或 { code: 500, msg: '错误提示' }"
      newApi: false
    notes: |
      删除业务规则（2026-02-06优化）：

      1. 前端确认提示：
         - 显示合同名称：确认删除【{合同名称}】吗？
         - 用户点击确认后，调用后端删除接口

      2. 后端检查逻辑（按顺序执行）：
         a. 检查是否有关联款项：
            - SQL: SELECT COUNT(*) FROM pm_payment WHERE contract_id = ? AND del_flag = '0'
            - 如果有款项（count > 0）：返回错误提示
              "【{合同名称}】下已有款项里程碑信息，不可进行删除操作！"
            - 如果无款项：继续下一步检查

         b. 检查是否有关联附件：
            - SQL: SELECT COUNT(*) FROM pm_attachment WHERE business_type = 'contract' AND business_id = ? AND del_flag = '0'
            - 如果有附件（count > 0）：返回错误提示
              "【{合同名称}】已上传附件信息，不可进行删除操作！"
            - 如果无附件：继续删除操作

      3. 删除操作（通过所有检查后）：
         a. 物理删除项目关联关系：
            - DELETE FROM pm_project_contract_rel WHERE contract_id = ?
            - 采用物理删除，不保留历史记录

         b. 逻辑删除合同：
            - UPDATE pm_contract SET del_flag = '1', update_by = ?, update_time = ? WHERE contract_id = ?
            - 保留合同数据，仅标记为已删除

      4. 前端提示：
         - 删除成功：显示"删除成功"
         - 删除失败：显示后端返回的错误信息

      后端实现（ContractServiceImpl.deleteContractByContractIds）：
      ```java
      @Override
      @Transactional
      public int deleteContractByContractIds(Long[] contractIds) {
          for (Long contractId : contractIds) {
              Contract contract = contractMapper.selectContractByContractId(contractId);
              if (contract == null) {
                  throw new ServiceException("合同不存在");
              }

              String contractName = contract.getContractName();

              // 检查是否有关联款项
              int paymentCount = paymentMapper.countPaymentByContractId(contractId);
              if (paymentCount > 0) {
                  throw new ServiceException("【" + contractName + "】下已有款项里程碑信息，不可进行删除操作！");
              }

              // 检查是否有关联附件
              int attachmentCount = attachmentMapper.countAttachmentByBusiness("contract", contractId);
              if (attachmentCount > 0) {
                  throw new ServiceException("【" + contractName + "】已上传附件信息，不可进行删除操作！");
              }

              // 物理删除项目关联关系
              projectContractRelMapper.deleteProjectContractRelByContractId(contractId);

              // 逻辑删除合同
              contract.setDelFlag("1");
              contract.setUpdateBy(SecurityUtils.getUsername());
              contract.setUpdateTime(DateUtils.getNowDate());
              contractMapper.updateContract(contract);
          }
          return contractIds.length;
      }
      ```

      前端实现（index.vue - handleDelete）：
      ```javascript
      function handleDelete(row) {
        const contractName = row.contractName || '该合同'
        proxy.$modal.confirm(`确认删除【${contractName}】吗？`).then(function() {
          return delContract(row.contractId)
        }).then(() => {
          getList()
          proxy.$modal.msgSuccess("删除成功")
        }).catch((error) => {
          // 后端返回的错误信息会自动显示
          if (error !== 'cancel') {
            console.error('删除失败:', error)
          }
        })
      }
      ```

      新增 Mapper 方法：
      1. PaymentMapper.countPaymentByContractId(Long contractId)
         - 统计合同下的有效款项数量
         - SQL: SELECT COUNT(*) FROM pm_payment WHERE contract_id = ? AND del_flag = '0'

      2. AttachmentMapper.countAttachmentByBusiness(String businessType, Long businessId)
         - 统计业务附件数量（别名方法，复用 countByBusinessTypeAndId）

      删除流程图：
      ```
      用户点击删除
          ↓
      前端确认：确认删除【合同名】吗？
          ↓
      后端检查1：是否有款项？
          ├─ 有 → 提示：【合同名】下已有款项里程碑信息，不可进行删除操作！
          └─ 无 → 继续
          ↓
      后端检查2：是否有附件？
          ├─ 有 → 提示：【合同名】已上传附件信息，不可进行删除操作！
          └─ 无 → 继续
          ↓
      删除操作：
          1. 物理删除项目关联关系（pm_project_contract_rel）
          2. 逻辑删除合同（pm_contract.del_flag = '1'）
          ↓
      前端提示：删除成功
      ```

      项目-合同关联表删除策略：
      - 采用物理删除（DELETE），不是逻辑删除（UPDATE del_flag='1'）
      - 原因：中间表不需要保留历史记录，物理删除避免唯一键冲突
      - 相关文件：ProjectContractRelMapper.xml - deleteProjectContractRelByContractId

      优化日期：2026-02-06

  # ==================
  # 新增合同页面
  # ==================
  add_page_layout:
    intent: "新增合同页面，独立路由页面，包含4个部分"
    component:
      type: custom
      spec: |
        路由: /project/contract/add

        页面布局：
        - 删除页面顶部的标题和描述信息（无需显示"新增合同"标题和说明文字）
        - 使用折叠面板组织表单内容
        - 所有面板默认展开

        第一部分：合同基本信息
        - 合同名称（单独一行，必填）
        - 合同编号、部门（部门树，从第三级开始展示，必填）、关联客户（客户下拉，必填）
        - 合同类型（字典sys_htlx，必填）、合同状态（字典sys_htzt）
        - 关联项目（下拉模糊查询选择，选择后自动添加到下方列表，列表展示项目详情）

        第二部分：合同时间与周期
        - 合同签订日期（必填）、合同周期（月）、免维期（月）

        第三部分：合同金额
        - 合同金额（含税，必填）、税率（%）
        - 不含税金额（自动计算）、税金（自动计算）

        第四部分：备注
        - 备注信息（文本域）
    bindTo: page
    service:
      endpoint: "POST /project/contract"
      source: "修改 ContractServiceImpl.insertContract，保存合同及关联项目"
      returns: "{ code: 200, msg: '新增成功' }"
      newApi: false
    notes: |
      UI优化：
      1. 删除了页面顶部的"新增合同"标题和"填写合同信息，保存后将创建新的合同记录"描述
      2. 删除了每个部分前面的序号（一、二、三、四）
      3. 折叠面板标题简洁明了：合同基本信息、合同时间与周期、合同金额、备注
      4. 税率字段不设置默认值，由用户自行填写

      必填项验证（前端 rules 配置）：
      - 合同名称（contractName）- 必填，且必须唯一
      - 部门（deptId）- 必填
      - 关联客户（customerId）- 必填
      - 合同类型（contractType）- 必填
      - 合同签订日期（contractSignDate）- 必填
      - 合同金额（contractAmount）- 必填，且必须为有效数字

      合同名称唯一性校验：
      - 校验时机：失去焦点时（blur）触发
      - 校验方式：调用后端接口 /project/contract/checkContractNameUnique
      - 新增模式：检查数据库中是否存在同名合同
      - 编辑模式：排除当前合同，检查是否存在其他同名合同
      - 错误提示：合同名称已存在，请使用其他名称
      - 自动去除首尾空格，避免因空格导致的重复

      前端校验实现（form.vue）：
      ```javascript
      /** 合同名称唯一性校验 */
      async function validateContractName(rule, value, callback) {
        if (!value || value.trim() === '') {
          callback()
          return
        }

        try {
          const response = await checkContractNameUnique(value.trim(), form.value.contractId)
          if (response.data === true) {
            callback()
          } else {
            callback(new Error('合同名称已存在，请使用其他名称'))
          }
        } catch (error) {
          console.error('校验合同名称唯一性失败:', error)
          callback()
        }
      }

      // 在 rules 中配置
      rules: {
        contractName: [
          { required: true, message: "合同名称不能为空", trigger: "blur" },
          { validator: validateContractName, trigger: "blur" }
        ]
      }
      ```

      后端校验实现（ContractServiceImpl.java）：
      ```java
      @Override
      public boolean checkContractNameUnique(String contractName, Long contractId) {
          if (contractName == null || contractName.trim().isEmpty()) {
              return false;
          }

          Contract contract = new Contract();
          contract.setContractName(contractName.trim());
          List<Contract> list = contractMapper.selectContractList(contract);

          // 如果没有找到同名合同，则唯一
          if (list == null || list.isEmpty()) {
              return true;
          }

          // 如果是编辑模式，排除自己
          if (contractId != null) {
              for (Contract c : list) {
                  if (!contractId.equals(c.getContractId())) {
                      // 找到其他同名合同，不唯一
                      return false;
                  }
              }
              // 只找到自己，唯一
              return true;
          }

          // 新增模式，找到同名合同，不唯一
          return false;
      }
      ```

      API 接口（contract.js）：
      ```javascript
      // 检查合同名称是否唯一
      export function checkContractNameUnique(contractName, contractId) {
        return request({
          url: '/project/contract/checkContractNameUnique',
          method: 'get',
          params: {
            contractName,
            contractId
          }
        })
      }
      ```

      合同编号：
      - 不做唯一性校验
      - 数据库层面删除了 UNIQUE KEY uk_contract_code 约束
      - 添加了普通索引 idx_contract_code 以提高查询性能

      保存和取消逻辑：
      - 保存成功后：跳转到 /htkx/contract?t={timestamp}，触发列表页面刷新
      - 取消操作后：跳转到 /htkx/contract?t={timestamp}，触发列表页面刷新
      - 列表页面通过 watch 监听 route.query.t 参数变化，自动刷新数据

      路由配置（ruoyi-ui/src/router/index.ts）：
      - 合同管理列表页面：/htkx/contract（后端菜单配置的路径）
      - 新增合同页面：/project/contract/add（动态路由，hidden: true）
      - 编辑合同页面：/project/contract/edit/:contractId（动态路由，使用路径参数）
      - 详情页面：/project/contract/detail/:contractId（动态路由，使用路径参数）
      - 附件页面：/project/contract/attachment/:contractId（动态路由，使用路径参数）

      路由跳转方式：
      - 新增：router.push({ path: '/project/contract/add' })
      - 编辑：router.push({ path: `/project/contract/edit/${contractId}` })
      - 详情：router.push({ path: `/project/contract/detail/${contractId}` })
      - 返回列表：router.push({ path: '/htkx/contract', query: { t: Date.now() } })

      参数获取方式：
      - 新增页面：无需获取参数
      - 编辑/详情页面：const contractId = route.params.contractId（使用路径参数，不是 query 参数）

      路由配置代码：
      ```typescript
      {
        path: '/project/contract',
        component: Layout,
        hidden: true,
        children: [
          {
            path: 'add',
            component: () => import('@/views/project/contract/form.vue'),
            name: 'ContractAdd',
            meta: { title: '新增合同', activeMenu: '/project/contract' }
          },
          {
            path: 'edit/:contractId(\\d+)',
            component: () => import('@/views/project/contract/form.vue'),
            name: 'ContractEdit',
            meta: { title: '编辑合同', activeMenu: '/project/contract' }
          },
          {
            path: 'detail/:contractId(\\d+)',
            component: () => import('@/views/project/contract/detail.vue'),
            name: 'ContractDetail',
            meta: { title: '合同详情', activeMenu: '/project/contract' }
          }
        ]
      }
      ```

      动态路由优势：
      - URL更简洁美观：/project/contract/edit/123 比 /project/contract/form?contractId=123 更清晰
      - SEO友好：路径参数对搜索引擎更友好
      - 类型安全：路由配置中使用正则 \\d+ 确保参数是数字
      - 面包屑导航：自动高亮对应的菜单项（通过 activeMenu 配置）
      - 符合RESTful规范：资源路径更符合REST API设计原则

      菜单高亮配置：
      - 所有合同相关页面（新增、编辑、详情、附件）都配置了 activeMenu: '/project/contract'
      - 确保在这些页面时，左侧合同管理菜单保持高亮状态
      - 用户可以清楚地知道当前在哪个模块下操作

      部门选择器优化：
      - 部门树从第三级开始展示，过滤掉第一级和第二级部门
      - 使用 filterDeptFromLevel3 函数进行过滤处理
      - 第三级及以下的部门保留完整的层级结构
      - 第三级部门会被提升到根层级显示（扁平化展示）

      部门过滤实现代码（form.vue）：
      ```javascript
      /** 过滤部门树，只保留第三级及以下部门 */
      function filterDeptFromLevel3(deptTree, level = 1) {
        if (!deptTree || !Array.isArray(deptTree)) return []
        const result = []
        for (const dept of deptTree) {
          if (level >= 3) {
            // 第三级及以下，保留该节点
            const newDept = { ...dept }
            if (dept.children && dept.children.length > 0) {
              newDept.children = filterDeptFromLevel3(dept.children, level + 1)
            }
            result.push(newDept)
          } else {
            // 第一、二级，只递归处理子节点
            if (dept.children && dept.children.length > 0) {
              const childrenResult = filterDeptFromLevel3(dept.children, level + 1)
              result.push(...childrenResult)
            }
          }
        }
        return result
      }

      /** 查询部门下拉树结构 */
      function getDeptTree() {
        deptTreeSelect().then(response => {
          deptOptions.value = response.data
          // 过滤出第三级及以下部门
          filteredDeptOptions.value = filterDeptFromLevel3(response.data)
        })
      }
      ```

      计算规则：
      - 不含税金额 = 合同金额 / (1 + 税率/100)
      - 税金 = 合同金额 - 不含税金额

  add_project_selector:
    intent: "关联项目组件，根据部门查询项目（包含该部门及其所有子部门），支持模糊查询选择，确保项目关联唯一性"
    component:
      type: custom
      spec: "下拉模糊查询选择项目，选择后自动添加到下方列表，已选项目以表格形式展示，可删除"
    bindTo: project_ids
    service:
      endpoint: "GET /project/project/listByDept?deptId={deptId}&excludeContractId={contractId}"
      source: "ProjectController.listByDept，根据部门查询项目（包含子部门），排除已关联的项目"
      returns: "[{ projectId, projectName, projectBudget, estimatedWorkload, actualWorkload }]"
      newApi: false
    notes: |
      业务规则：
      - 一个项目只能被一个合同关联
      - 一个合同可以关联多个项目
      - 新增合同时：排除所有已被其他合同关联的项目
      - 编辑合同时：排除已被其他合同关联的项目，但保留当前合同已关联的项目

      功能说明：
      - 监听部门变化，动态查询项目列表
      - 查询范围：该部门及其所有下级部门的项目
      - 自动过滤已被关联的项目，确保唯一性约束

      前端交互优化：
      1. 下拉框支持模糊查询（filterable 属性）
      2. 选择项目后自动添加到下方列表
      3. 下拉框自动清空，可以继续选择其他项目
      4. 已选项目不在下拉框中重复显示
      5. 已选项目列表以表格形式展示，包含详细信息
      6. 支持移除已选项目

      前端实现代码（form.vue）：
      ```javascript
      // 响应式变量
      const selectedProjectId = ref(null)  // 当前选择的项目ID
      const selectedProjects = ref([])     // 已选项目列表
      const availableProjectOptions = ref([])  // 可选项目列表（排除已选）

      /** 项目选择变化时自动添加到列表 */
      function handleProjectSelect(projectId) {
        if (!projectId) return
        const project = filteredProjectOptions.value.find(p => p.projectId === projectId)
        if (project) {
          selectedProjects.value.push({ ...project })
          // 清空选择，允许继续选择其他项目
          selectedProjectId.value = null
          updateAvailableProjects()
        }
      }

      /** 更新可选项目列表（排除已选项目） */
      function updateAvailableProjects() {
        const selectedIds = selectedProjects.value.map(p => p.projectId)
        availableProjectOptions.value = filteredProjectOptions.value.filter(project => {
          return !selectedIds.includes(project.projectId)
        })
      }

      /** 从已选列表移除项目 */
      function handleRemoveProject(index) {
        selectedProjects.value.splice(index, 1)
        updateAvailableProjects()
      }

      /** 提交时将已选项目ID列表赋值给form */
      function submitForm() {
        form.value.projectIds = selectedProjects.value.map(p => p.projectId)
        // ... 提交逻辑
      }
      ```

      已选项目列表展示：
      - 使用 el-table 组件展示
      - 列：序号、项目名称、预算金额（元）、预估工作量（人天）、实际工作量（人天）、操作
      - 金额和工作量保留两位小数
      - 操作列包含"移除"按钮

      已选项目表格代码（form.vue）：
      ```vue
      <el-row :gutter="20" v-if="selectedProjects.length > 0">
        <el-col :span="24">
          <el-form-item label=" " label-width="140px">
            <el-table :data="selectedProjects" border style="width: 100%">
              <el-table-column type="index" label="序号" width="60" align="center" />
              <el-table-column prop="projectName" label="项目名称" min-width="200" />
              <el-table-column prop="projectBudget" label="预算金额（元）" width="150" align="right">
                <template #default="scope">
                  {{ scope.row.projectBudget ? Number(scope.row.projectBudget).toFixed(2) : '0.00' }}
                </template>
              </el-table-column>
              <el-table-column prop="estimatedWorkload" label="预估工作量（人天）" width="160" align="right">
                <template #default="scope">
                  {{ scope.row.estimatedWorkload ? Number(scope.row.estimatedWorkload).toFixed(2) : '0.00' }}
                </template>
              </el-table-column>
              <el-table-column prop="actualWorkload" label="实际工作量（人天）" width="160" align="right">
                <template #default="scope">
                  {{ scope.row.actualWorkload ? Number(scope.row.actualWorkload).toFixed(2) : '0.00' }}
                </template>
              </el-table-column>
              <el-table-column label="操作" width="80" align="center">
                <template #default="scope">
                  <el-button type="text" icon="Delete" @click="handleRemoveProject(scope.$index)">移除</el-button>
                </template>
              </el-table-column>
            </el-table>
          </el-form-item>
        </el-col>
      </el-row>
      ```

      后端实现（ProjectServiceImpl.selectProjectListByDept）：
      ```java
      @Override
      public List<Project> selectProjectListByDept(Long deptId, Long excludeContractId) {
          if (deptId == null) {
              return new ArrayList<>();
          }
          return projectMapper.selectProjectListByDeptAndChildren(deptId, excludeContractId);
      }
      ```

      SQL查询逻辑（ProjectMapper.xml - selectProjectListByDeptAndChildren）：
      ```sql
      SELECT p.* FROM pm_project p
      WHERE p.del_flag = '0'
      AND (
          p.project_dept = #{deptId}  -- 该部门的项目
          OR p.project_dept IN (
              SELECT dept_id FROM sys_dept
              WHERE del_flag = '0'
              AND FIND_IN_SET(#{deptId}, ancestors)  -- 所有子部门
          )
      )
      -- 排除已被其他合同关联的项目，但允许显示当前合同已关联的项目
      AND (
          p.project_id NOT IN (
              SELECT project_id FROM pm_project_contract_rel
              WHERE del_flag = '0'
          )
          <if test="excludeContractId != null">
              -- 编辑时：允许显示当前合同已关联的项目
              OR p.project_id IN (
                  SELECT project_id FROM pm_project_contract_rel
                  WHERE del_flag = '0'
                  AND contract_id = #{excludeContractId}
              )
          </if>
      )
      ORDER BY p.create_time DESC
      ```

      SQL逻辑说明：
      - 新增场景（excludeContractId 为 null）：
        只显示未被任何合同关联的项目
      - 编辑场景（excludeContractId 不为 null）：
        显示未被关联的项目 OR 被当前合同关联的项目
        确保不会显示被其他合同关联的项目

      前端调用：
      - 新增页面：listProjectByDept(deptId, null)
        排除所有已关联的项目
      - 编辑页面：listProjectByDept(deptId, contractId)
        排除其他合同已关联的项目，保留当前合同的关联

      数据库约束：
      - pm_project_contract_rel 表的唯一键约束：
        UNIQUE KEY `uk_project_contract` (`project_id`,`contract_id`,`del_flag`)
      - 确保同一项目和合同的组合只能存在一条有效记录

      查询原理：
      - 使用 sys_dept.ancestors 字段（存储祖先部门ID列表，如 "0,100,101"）
      - FIND_IN_SET 函数查找所有包含该部门ID的子部门
      - 查询结果包含该部门及其所有下级部门的项目

      示例：
      部门结构：技术部(100) -> 开发组(101) -> 前端组(102)
      - 选择"技术部"：返回技术部、开发组、前端组的所有项目
      - 选择"开发组"：返回开发组、前端组的项目
      - 选择"前端组"：只返回前端组的项目

      测试场景：
      1. 新增合同：
         - 项目P1未被关联 -> 可选
         - 项目P2被合同A关联 -> 不可选
      2. 编辑合同A（已关联P1）：
         - 项目P1（当前合同的） -> 可选（允许保留）
         - 项目P2被合同B关联 -> 不可选
         - 项目P3未被关联 -> 可选

      相关文件：
      - ProjectServiceImpl.java
      - ProjectMapper.java
      - ProjectMapper.xml
      - 详细文档：docs/contract-project-unique-constraint.md

  add_form_defaults:
    intent: "新增合同表单字段默认值设置"
    component:
      type: custom
      spec: |
        表单初始化时的默认值：
        - contractCode: '' (空字符串，无默认值)
        - contractName: '' (空字符串，无默认值)
        - customerId: '' (空字符串，无默认值)
        - deptId: '' (空字符串，无默认值)
        - contractType: '' (空字符串，无默认值)
        - contractStatus: '' (空字符串，无默认值)
        - contractSignDate: '' (空字符串，无默认值)
        - contractPeriod: '' (空字符串，无默认值)
        - contractAmount: '' (空字符串，无默认值)
        - taxRate: '' (空字符串，无默认值，之前为 '13')
        - amountNoTax: '' (空字符串，自动计算)
        - taxAmount: '' (空字符串，自动计算)
        - freeMaintenancePeriod: '' (空字符串，无默认值)
        - projectIds: [] (空数组，无默认值)
        - remark: '' (空字符串，无默认值)
    bindTo: form
    service: null
    notes: |
      重要变更：
      1. 税率字段（taxRate）不再设置默认值 '13'，改为空字符串
      2. 所有字段都由用户手动填写，不预设任何默认值
      3. 不含税金额和税金字段会根据合同金额和税率自动计算

  # ==================
  # 编辑合同页面
  # ==================
  edit_page_layout:
    intent: "编辑合同页面，独立路由页面，包含5个部分"
    component:
      type: custom
      spec: |
        路由: /project/contract/edit/:contractId

        页面布局：
        - 删除页面顶部的标题和描述信息（无需显示"编辑合同"标题和说明文字）
        - 使用折叠面板组织表单内容
        - 所有面板默认展开

        前4部分与新增页面一致：
        - 第一部分：合同基本信息
        - 第二部分：合同时间与周期
        - 第三部分：合同金额
        - 第四部分：备注

        第五部分：审计信息（只读，横向排列）
        - 创建人（显示用户姓名）、创建时间 | 更新人（显示用户姓名）、更新时间
    bindTo: page
    service:
      endpoint: "PUT /project/contract"
      source: "修改 ContractServiceImpl.updateContract，更新合同及关联项目"
      returns: "{ code: 200, msg: '修改成功' }"
      newApi: false
    notes: |
      UI优化：
      1. 删除了页面顶部的"编辑合同"标题和"修改合同信息，保存后将更新合同数据"描述
      2. 页面布局与新增页面保持一致

      必填项验证（前端 rules 配置）：
      - 合同名称（contractName）- 必填，且必须唯一（排除自己）
      - 部门（deptId）- 必填
      - 关联客户（customerId）- 必填
      - 合同类型（contractType）- 必填
      - 合同签订日期（contractSignDate）- 必填
      - 合同金额（contractAmount）- 必填，且必须为有效数字

      合同名称唯一性校验：
      - 编辑模式下，校验时会排除当前合同自己
      - 只检查是否存在其他同名合同
      - 校验逻辑与新增页面相同，详见 add_page_layout 定制需求

      数据回显：
      - 所有字段回显
      - 关联项目列表回显（自动展示已关联的项目，包含项目名称、预算金额、预估工作量、实际工作量）
      - 计算字段回显（不含税金额、税金）
      - 审计信息回显（创建人姓名、创建时间、更新人姓名、更新时间）

      项目回显实现：
      - 后端查询合同详情时，同时查询关联的项目列表（projectList）
      - 后端从 projectList 提取项目ID列表（projectIds），用于前端回显
      - 前端根据 projectIds 过滤出已选项目，填充到 selectedProjects 列表
      - 已选项目以表格形式展示在"关联项目"下拉框下方

      后端实现（ContractServiceImpl.selectContractByContractId）：
      ```java
      // 查询关联项目列表
      List<Project> projectList = projectMapper.selectProjectListByContractId(contractId);
      contract.setProjectList(projectList);

      // 提取项目ID列表（用于编辑页面回显）
      if (projectList != null && !projectList.isEmpty()) {
          List<Long> projectIds = new java.util.ArrayList<>();
          for (Project project : projectList) {
              projectIds.add(project.getProjectId());
          }
          contract.setProjectIds(projectIds);
      }
      ```

      前端实现（form.vue - init 方法）：
      ```javascript
      getContract(contractId).then(response => {
        form.value = response.data
        if (form.value.deptId) {
          setTimeout(() => {
            // 查询该部门的项目（包含当前合同已关联的项目）
            listProjectByDept(form.value.deptId, contractId).then(projectResponse => {
              filteredProjectOptions.value = projectResponse.data || []

              // 恢复已选项目列表
              const projectIds = response.data.projectIds || []
              selectedProjects.value = filteredProjectOptions.value.filter(project => {
                return projectIds.includes(project.projectId)
              })

              // 更新可选项目列表
              updateAvailableProjects()
            })
          }, 100)
        }
      })
      ```

      审计信息显示逻辑：
      - 创建人和更新人优先显示姓名（createByName/updateByName）
      - 如果姓名为空，降级显示用户名（createBy/updateBy）
      - 审计信息字段为只读，横向排列（4列）
      - 后端查询时关联 sys_user 表获取用户姓名（nick_name）

      项目关联唯一性约束：
      - 编辑时查询项目列表，排除已被其他合同关联的项目
      - 保留当前合同已关联的项目，允许用户保持或取消关联
      - 前端调用：listProjectByDept(deptId, contractId)
      - 详细说明：参见 add_project_selector 定制需求

      更新人信息处理：
      - 后端自动填充：contract.setUpdateBy(SecurityUtils.getUsername())
      - 后端自动填充：contract.setUpdateTime(DateUtils.getNowDate())
      - 查询时关联 sys_user 表获取用户姓名：updateByName
      - 前端展示：updateByName（用户姓名）、updateTime（更新时间）

      保存和取消逻辑：
      - 保存成功后：跳转到 /htkx/contract?t={timestamp}，触发列表页面刷新
      - 取消操作后：跳转到 /htkx/contract?t={timestamp}，触发列表页面刷新
      - 加载失败时：跳转到 /htkx/contract?t={timestamp}，触发列表页面刷新
      - 列表页面通过 watch 监听 route.query.t 参数变化，自动刷新数据

      路由配置（ruoyi-ui/src/router/index.ts）：
      - 合同管理列表页面：/htkx/contract（后端菜单配置的路径）
      - 新增合同页面：/project/contract/add（动态路由，hidden: true）
      - 编辑合同页面：/project/contract/edit/:contractId（动态路由，使用路径参数）
      - 详情页面：/project/contract/detail/:contractId（动态路由，使用路径参数）
      - 附件页面：/project/contract/attachment/:contractId（动态路由，使用路径参数）

      路由跳转方式：
      - 新增：router.push({ path: '/project/contract/add' })
      - 编辑：router.push({ path: `/project/contract/edit/${contractId}` })
      - 详情：router.push({ path: `/project/contract/detail/${contractId}` })
      - 返回列表：router.push({ path: '/htkx/contract', query: { t: Date.now() } })

      参数获取方式：
      - 编辑页面：const contractId = route.params.contractId（使用路径参数，不是 query 参数）
      - 监听参数变化：watch(() => route.params.contractId, ...)

      路由配置代码：
      ```typescript
      {
        path: '/project/contract',
        component: Layout,
        hidden: true,
        children: [
          {
            path: 'add',
            component: () => import('@/views/project/contract/form.vue'),
            name: 'ContractAdd',
            meta: { title: '新增合同', activeMenu: '/project/contract' }
          },
          {
            path: 'edit/:contractId(\\d+)',
            component: () => import('@/views/project/contract/form.vue'),
            name: 'ContractEdit',
            meta: { title: '编辑合同', activeMenu: '/project/contract' }
          },
          {
            path: 'detail/:contractId(\\d+)',
            component: () => import('@/views/project/contract/detail.vue'),
            name: 'ContractDetail',
            meta: { title: '合同详情', activeMenu: '/project/contract' }
          }
        ]
      }
      ```

      动态路由优势：
      - URL更简洁美观：/project/contract/edit/123 比 /project/contract/form?contractId=123 更清晰
      - SEO友好：路径参数对搜索引擎更友好
      - 类型安全：路由配置中使用正则 \\d+ 确保参数是数字
      - 面包屑导航：自动高亮对应的菜单项（通过 activeMenu 配置）
      - 符合RESTful规范：资源路径更符合REST API设计原则

      后端实现要点：
      1. ContractServiceImpl.updateContract 方法：
         - 自动填充 updateBy 和 updateTime
         - 计算不含税金额和税金
         - 更新合同基本信息
         - 物理删除旧的项目关联关系（DELETE，避免唯一键冲突）
         - 保存新的项目关联关系

      2. ContractServiceImpl.selectContractByContractId 方法：
         - 查询合同基本信息
         - 查询关联项目列表
         - 查询创建人和更新人姓名（关联 sys_user 表获取 nick_name）
         - 返回字段包含：createByName, updateByName

      3. 项目关联删除策略：
         - 采用物理删除（DELETE），不是逻辑删除
         - 原因：中间表不需要保留历史记录，避免唯一键冲突
         - 详细说明：docs/contract-edit-save-fix.md

  # ==================
  # 合同详情页面
  # ==================
  detail_page_layout:
    intent: "合同详情页面，独立路由页面，包含7个部分"
    component:
      type: custom
      spec: |
        路由: /project/contract/detail/:contractId

        页面布局：
        第一部分：合同基本信息（只读）
        - 合同名称（单独一行，:span="2"）
        - 合同编号、部门
        - 关联客户、合同类型
        - 合同状态（单独一行，:span="2"）

        第二部分：合同时间与周期（只读）
        - 合同签订日期、合同周期
        - 免维期、（空白）

        第三部分：合同金额（只读）
        - 合同金额（含税）、税率
        - 不含税金额、税金

        第四部分：付款里程碑信息（表格形式，首行合计）
        - 序号、里程碑名称、付款金额（元）、付款状态
        - 预计回款季度、实际回款季度、实际回款日期
        - 确认年份、是否违约扣款、扣款金额（元）、备注

        第五部分：合同附件列表（表格形式，下载按钮）
        - 序号、文档类型、文件名称、文件说明
        - 上传人员、上传时间、操作（下载）

        第六部分：关联项目列表（表格形式，项目名称可点击跳转）
        - 序号、项目名称、预算金额（元）
        - 预估工作量（人天）、实际人天

        第七部分：备注与审计信息（只读）
        - 备注（单独一行，:span="2"）
        - 创建人、创建时间
        - 更新人、更新时间
    bindTo: page
    service:
      endpoint: "GET /project/contract/:contractId"
      source: "修改 ContractServiceImpl.selectContractById，返回完整详情"
      returns: "{ contract: {...}, projects: [...], payments: [...], attachments: [...] }"
      newApi: false
    notes: |
      展示规则：
      - 所有字段只读
      - 部门、客户、合同类型展示名称
      - 金额保留2位小数
      - 项目名称可点击跳转到 /project/project/detail/:projectId
      - 创建人和更新人显示姓名（createByName/updateByName），如果姓名为空则显示用户名（createBy/updateBy）

      UI优化：
      1. 去掉底部编辑按钮：
         - 删除了操作按钮卡片（包含编辑和返回按钮）
         - 只在页面头部保留返回按钮
         - 简化页面操作，避免重复按钮

      2. 模块顺序调整：
         - 按业务逻辑重新组织展示顺序
         - 基本信息 → 时间周期 → 金额 → 付款里程碑 → 附件 → 关联项目 → 备注审计
         - 将付款里程碑和附件信息前置，更符合查看习惯

      3. 字段布局优化：
         - 合同名称单独占一行（:span="2"），突出显示
         - 合同状态单独占一行（:span="2"），便于查看
         - 免维期与合同签订日期在同一行，保持左右列对齐
         - 所有字段采用2列布局，左右对齐
         - 右列字段对齐：部门、合同类型、合同周期、税率、税金

      4. 标签格式统一：
         - 所有单位放在数值后面，与数值之间有空格
         - 金额单位：数值 + 空格 + "元"（如：1000.00 元）
         - 周期单位：数值 + 空格 + "月"（如：12 月）
         - 税率单位：数值 + 空格 + "%"（如：13 %）
         - 标签中不包含单位，单位显示在内容中
         - 示例：
           * 标签："合同周期"，内容："12 月"
           * 标签："税率"，内容："13 %"
           * 标签："合同金额（含税）"，内容："100000.00 元"

      审计信息显示：
      - 后端查询时关联 sys_user 表获取用户姓名（nick_name）
      - 前端优先显示姓名，降级显示用户名
      - 显示代码：{{ detailData.createByName || detailData.createBy }}

      路由配置（ruoyi-ui/src/router/index.ts）：
      - 合同管理列表页面：/htkx/contract（后端菜单配置的路径）
      - 新增合同页面：/project/contract/add（动态路由，hidden: true）
      - 编辑合同页面：/project/contract/edit/:contractId（动态路由，使用路径参数）
      - 详情页面：/project/contract/detail/:contractId（动态路由，使用路径参数）
      - 附件页面：/project/contract/attachment/:contractId（动态路由，使用路径参数）

      路由跳转方式：
      - 从列表跳转详情：router.push({ path: `/project/contract/detail/${contractId}` })
      - 从详情跳转编辑：router.push({ path: `/project/contract/edit/${contractId}` })
      - 返回列表：router.back() 或 router.push({ path: '/htkx/contract' })

      参数获取方式：
      - 详情页面：const contractId = route.params.contractId（使用路径参数，不是 query 参数）

      路由配置代码：
      ```typescript
      {
        path: '/project/contract',
        component: Layout,
        hidden: true,
        children: [
          {
            path: 'add',
            component: () => import('@/views/project/contract/form.vue'),
            name: 'ContractAdd',
            meta: { title: '新增合同', activeMenu: '/project/contract' }
          },
          {
            path: 'edit/:contractId(\\d+)',
            component: () => import('@/views/project/contract/form.vue'),
            name: 'ContractEdit',
            meta: { title: '编辑合同', activeMenu: '/project/contract' }
          },
          {
            path: 'detail/:contractId(\\d+)',
            component: () => import('@/views/project/contract/detail.vue'),
            name: 'ContractDetail',
            meta: { title: '合同详情', activeMenu: '/project/contract' }
          }
        ]
      }
      ```

      动态路由优势：
      - URL更简洁美观：/project/contract/detail/123 比 /project/contract/detail?contractId=123 更清晰
      - SEO友好：路径参数对搜索引擎更友好
      - 类型安全：路由配置中使用正则 \\d+ 确保参数是数字
      - 面包屑导航：自动高亮对应的菜单项（通过 activeMenu 配置）
      - 符合RESTful规范：资源路径更符合REST API设计原则

  detail_payment_milestone:
    intent: "付款里程碑信息表格，首行显示总计"
    component:
      type: el-table
      props:
        showSummary: true
        data: "付款里程碑列表"
    bindTo: payment_milestone
    service:
      endpoint: "GET /project/payment/listByContract?contractId={contractId}"
      source: "查询 pm_payment 表"
      returns: "[{ milestoneName, paymentAmount, paymentStatus, ... }]"
      newApi: true
    notes: |
      表格列：
      - 序号
      - 里程碑名称（原"付款方式名称"）
      - 付款金额（元）
      - 付款状态
      - 预计回款季度
      - 实际回款季度
      - 实际回款日期
      - 确认年份
      - 是否违约扣款
      - 扣款金额（元）
      - 备注

      首行合计：
      - 付款金额总计
      - 扣款金额总计

      标签格式统一：
      - 所有单位使用中文括号：（元）
      - 列名从"付款方式名称"改为"里程碑名称"，更准确反映业务含义


  detail_attachment_list:
    intent: "合同附件列表表格"
    component:
      type: el-table
      props:
        data: "附件列表"
    bindTo: attachment_list
    service:
      endpoint: "GET /project/attachment/list?businessType=contract&businessId={contractId}"
      source: "查询 pm_attachment 表"
      returns: "[{ attachmentId, documentType, fileName, fileDescription, createBy, createTime }]"
      newApi: true
    notes: |
      表格列：序号、文档类型、文件名称、文件说明、上传人员、上传时间、操作（下载）

      交互优化（2026-02-09）：
      - 文件名称列改为可点击链接
      - 点击文件名称即可下载附件
      - 使用 el-link 组件，显示为蓝色链接样式
      - 提供两种下载方式：
        * 点击文件名称下载
        * 点击操作列的"下载"按钮
      - 优化原因：提升用户体验，符合常见文件列表交互习惯
      - 修改文件：ruoyi-ui/src/views/project/contract/detail.vue:157-163

  detail_project_list:
    intent: "关联项目列表表格，项目名称可点击"
    component:
      type: el-table
      props:
        data: "项目列表"
    bindTo: project_list
    service:
      endpoint: "GET /project/contract/:contractId (包含项目列表)"
      source: "查询 pm_project_contract_rel + pm_project"
      returns: "[{ projectId, projectName, projectBudget, estimatedWorkload, actualWorkload }]"
      newApi: false
    notes: |
      表格列：
      - 序号
      - 项目名称（超链接，可点击跳转到项目详情）
      - 预算金额（元）
      - 预估工作量（人天）
      - 实际人天

      标签格式统一：
      - 所有单位使用中文括号：（元）、（人天）
      - 提升视觉一致性


  # ==================
  # 附件管理页面
  # ==================
  attachment_page_layout:
    intent: "附件管理页面，独立路由页面"
    component:
      type: custom
      spec: |
        路由: /project/contract/attachment/:contractId

        页面布局：
        - 删除页面顶部的标题和描述信息（无需显示"合同附件管理"标题和"管理合同相关附件文档"描述）

        第一部分：合同基本信息（只读，2列布局）
        - 第1行：合同名称（占满整行）
        - 第2行：所属部门、合同编号
        - 第3行：客户名称、合同类型
        - 第4行：合同金额（元）、合同签订日期

        第二部分：附件上传表单
        - 文档类型（下拉必填，字典sys_wdlx）
        - 选择文件（支持doc、docx、xls、xlsx、pdf、csv、png、jpg、gif、txt、7z、zip、gz格式，单个文件不超过30MB，每次只能选择一个文件上传）
        - 文件说明（文本域，选填）
        - 按钮：上传、重置、日志

        第三部分：附件列表（表格形式）
        - 序号、文档类型、文件名称、文件大小、文件说明、上传时间、操作（下载、删除）
    bindTo: page
    service:
      endpoint: "POST /project/attachment"
      source: "新增 AttachmentController.upload，上传附件"
      returns: "{ code: 200, msg: '上传成功' }"
      newApi: true
    notes: |
      数据库表结构：
      - pm_attachment：附件表，存储附件基本信息
      - pm_attachment_log：附件操作日志表，记录上传、删除、下载操作
      - 表结构定义：pm-sql/init/00_tables_ddl.sql

      路由配置（2026-02-09新增）：
      - 路由路径：/project/contract/attachment/:contractId
      - 组件文件：ruoyi-ui/src/views/project/contract/attachment.vue
      - 路由名称：ContractAttachment
      - 页面标题：合同附件
      - 激活菜单：/htkx/contract
      - 配置文件：ruoyi-ui/src/router/index.ts

      路由配置代码：
      ```typescript
      {
        path: 'attachment/:contractId(\\d+)',
        component: () => import('@/views/project/contract/attachment.vue'),
        name: 'ContractAttachment',
        meta: { title: '合同附件', activeMenu: '/htkx/contract' }
      }
      ```

      访问方式变更（2026-02-09）：
      - 原方式：合同列表点击"附件"按钮 → 打开对话框（Dialog）
      - 新方式：合同列表点击"附件"按钮 → 跳转到独立页面
      - 跳转代码：router.push({ path: `/project/contract/attachment/${contractId}` })
      - 优化原因：
        * 独立页面提供更大的操作空间
        * 避免对话框层级过深的问题
        * 提升用户体验和操作便利性
        * 与详情页面、编辑页面保持一致的交互方式

      UI优化（2026-02-09）：
      1. 第一部分字段顺序调整：
         - 原顺序：合同名称 → 合同编号、客户名称 → 合同类型、合同金额 → 合同签订日期、所属部门
         - 新顺序：合同名称 → 所属部门、合同编号 → 客户名称、合同类型 → 合同金额、合同签订日期
         - 优化原因：将所属部门前置，与其他页面保持一致

      2. 第二部分按钮调整：
         - 原按钮：上传附件、重置
         - 新按钮：上传、重置、日志
         - 优化原因：
           * 简化按钮文字（"上传附件"改为"上传"）
           * 将"日志"按钮从列表头部移到上传表单，统一操作区域
           * 提升用户操作便利性

      3. 第三部分列表字段调整：
         - 新增字段：
           * 文件类型：显示文件扩展名（如 PDF、DOCX、XLS），通过 getFileExtension 函数提取
           * 文件大小：格式化显示文件大小（如 1.25 MB、256.50 KB），通过 formatFileSize 函数格式化
         - 删除字段：
           * 上传人员：移除该列，简化列表展示
         - 列顺序：序号 → 文档类型 → 文件类型 → 文件名称 → 文件大小 → 文件说明 → 上传时间 → 操作
         - 优化原因：
           * 文件类型和文件大小是用户关注的重要信息
           * 上传人员信息可通过操作日志查看，列表中不必展示

      文件格式：doc、docx、xls、xlsx、pdf、csv、png、jpg、gif、txt、7z、zip、gz
      文件大小：单个不超过30MB
      文件路径：{部署路径}/合同/{contract_id}_{contract_name}/{yyyyMMdd}/{文件名}

      文件格式更新记录：
      - 2026-02-04：新增 gif 格式支持（图片类型）


  attachment_upload:
    intent: "附件上传功能"
    component:
      type: el-upload
      props:
        limit: 1
        accept: ".doc,.docx,.xls,.xlsx,.pdf,.csv,.png,.jpg,.gif,.txt,.7z,.zip,.gz"
    bindTo: file_upload
    service:
      endpoint: "POST /project/attachment"
      source: "AttachmentServiceImpl.uploadAttachment"
      returns: "{ code: 200, msg: '上传成功', data: { attachmentId } }"
      newApi: true
    notes: |
      系统配置（application.yml）：
      - spring.servlet.multipart.max-file-size: 30MB（单个文件大小限制）
      - spring.servlet.multipart.max-request-size: 30MB（总上传请求大小限制）
      - 配置文件位置：ruoyi-admin/src/main/resources/application.yml
      - 修改后需要重启后端服务生效

      Spring Boot 文件上传配置：
      - 配置文件：ruoyi-admin/src/main/resources/application.yml
      - max-file-size: 30MB（单个文件最大大小）
      - max-request-size: 30MB（单次请求最大大小）
      - 影响范围：所有文件上传功能（合同附件、款项附件等）

      后端文件格式校验：
      - AttachmentServiceImpl.ALLOWED_EXTENSIONS 常量定义允许的文件扩展名
      - 支持格式：.doc, .docx, .xls, .xlsx, .pdf, .csv, .png, .jpg, .gif, .txt, .7z, .zip, .gz
      - 文件大小限制：30MB（MAX_FILE_SIZE = 30 * 1024 * 1024）
      - 校验位置：AttachmentServiceImpl.uploadAttachment:111-114

      上传成功后：
      1. 保存文件到服务器
      2. 记录到 pm_attachment 表
      3. 记录日志到 pm_attachment_log（操作描述：【上传文件】：{文件名}）
      4. 刷新附件列表

  attachment_delete:
    intent: "附件删除功能"
    component:
      type: el-button
      props:
        type: "danger"
        text: "删除"
    bindTo: delete_button
    service:
      endpoint: "DELETE /project/attachment/:attachmentId"
      source: "AttachmentServiceImpl.deleteAttachment"
      returns: "{ code: 200, msg: '删除成功' }"
      newApi: true
    notes: |
      删除操作：
      1. 逻辑删除：pm_attachment.del_flag = '1'
      2. 记录日志到 pm_attachment_log（操作描述：【删除文件】：{文件名}）
      3. 刷新附件列表

  attachment_download:
    intent: "附件下载功能"
    component:
      type: el-button
      props:
        type: "primary"
        text: "下载"
    bindTo: download_button
    service:
      endpoint: "GET /project/attachment/download/:attachmentId"
      source: "AttachmentController.download"
      returns: "文件流"
      newApi: true
    notes: "下载文件"

  attachment_log:
    intent: "附件操作日志弹窗"
    component:
      type: el-dialog
      props:
        title: "合同附件操作日志"
        width: "80%"
    bindTo: log_dialog
    service:
      endpoint: "GET /project/attachment/log?businessType=contract&businessId={contractId}"
      source: "查询 pm_attachment_log 表，关联 sys_dict_data 表获取字典标签"
      returns: "[{ logId, operationDesc, documentTypeName, operatorName, createTime }]"
      newApi: true
    notes: |
      日志表格列：序号、调整说明、文档类型、调整人、调整时间
      调整说明格式：【上传文件】：测试文件.pdf 或 【删除文件】：测试文件.pdf

      字段映射说明：
      - 前端字段 documentTypeName ← 后端字段 documentTypeName（字典标签）
      - 前端字段 createTime ← 后端字段 operationTime（操作时间）
      - 后端同时返回 operationTime 和 createTime，两者值相同

      后端实现（AttachmentLogMapper.xml）：
      - SQL 查询关联 sys_dict_data 表获取文档类型字典标签
      - LEFT JOIN sys_dict_data ON document_type = dict_value AND dict_type = 'sys_wdlx'
      - 查询结果包含 document_type_name（字典标签）
      - resultMap 中将 operation_time 同时映射到 operationTime 和 createTime

      实体类字段（AttachmentLog.java）：
      - documentType: 文档类型字典值（如 "1"）
      - documentTypeName: 文档类型字典标签（如 "1-合同扫描件"）
      - operationTime: 操作时间
      - createTime: 前端兼容字段，映射到 operationTime

  column_visibility:
    intent: "列表显隐列功能"
    component:
      type: right-toolbar
      props:
        columns: columns
    bindTo: table_columns
    service: null
    notes: |
      显隐列功能配置（2026-02-10新增）：

      功能说明：
      - 用户可通过右侧工具栏的"显隐列"按钮控制表格列的显示/隐藏
      - 所有列默认显示（visible: true）
      - 用户的显隐设置会保存在浏览器本地存储中

      可控制的列（共18列）：
      1. index - 序号
      2. contractName - 合同名称（固定在左侧）
      3. projectList - 关联项目
      4. customerId - 客户名称
      5. deptId - 部门
      6. contractType - 合同类型
      7. contractStatus - 合同状态
      8. contractSignDate - 合同签订日期
      9. contractPeriod - 合同周期
      10. contractAmount - 合同金额
      11. amountNoTax - 不含税金额
      12. freeMaintenancePeriod - 免维期
      13. remark - 备注
      14. createTime - 创建日期
      15. createByName - 创建人
      16. updateTime - 最后更新日期
      17. updateByName - 最后更新人
      18. actions - 操作（固定在右侧）

      实现方式：
      - 前端定义 columns 响应式对象，包含所有列的配置
      - 每个列配置包含：key（列标识）、label（列名）、visible（是否可见）
      - 每个 el-table-column 添加 v-if="columns.xxx.visible" 条件
      - right-toolbar 组件通过 :columns="columns" 绑定列配置

      代码位置：
      - ruoyi-ui/src/views/project/contract/index.vue
      - 第391-411行：columns 对象定义
      - 第135-238行：表格列添加 v-if 条件

# ============================
# 实现说明
# ============================
implementation:
  description: 本规格文件定义了合同管理模块的完整功能配置，包括CRUD操作、附件管理、导出功能、列显隐等

  keyFeatures:
    - 合同名称唯一性校验：新增和编辑时校验合同名称唯一性（精确匹配）
    - 合同编号不做唯一性校验：允许重复的合同编号
    - 部门树选择：从第三级开始展示，过滤掉第一级和第二级部门
    - 客户选择：支持模糊搜索，显示客户简称
    - 金额自动计算：根据合同金额和税率自动计算不含税金额和税金
    - 税率字段：不设置默认值，由用户自行填写
    - 合同状态颜色标识：已签(绿)、未签(橙)、待变更(蓝)、已变更(深蓝)、合同作废(红)
    - 附件管理：
        - 支持格式：doc、docx、xls、xlsx、pdf、csv、png、jpg、gif、txt、7z、zip、gz
        - 文件大小：单个不超过30MB
        - 文件路径：{部署路径}/合同/{contract_id}_{contract_name}/{yyyyMMdd}/{文件名}
        - 附件操作日志：记录上传、下载、删除操作
    - 导出功能：
        - 文件名格式：合同管理_yyyyMMddHHmmss.xlsx（中文前缀+时间戳）
        - 导出字段：15个字段，包含客户名称、部门名称（不导出ID）
        - 字典转换：合同类型、合同状态自动转换为标签
        - 列顺序：合同编号、合同名称、部门名称、客户名称、合同类型等
        - 前端实现：必须传递文件名参数给 proxy.download 方法
    - 列显隐功能：用户可自定义18个列的显示/隐藏，设置保存在浏览器本地存储
    - 详情页面：三部分卡片式布局（合同基本信息、关联项目信息、附件列表）
    - 删除业务规则：有附件时禁止删除，确保数据完整性

  technicalStack:
    backend:
      - Java 17 / Spring Boot 3.5.8
      - MyBatis（多表关联查询）
      - 多表JOIN查询（pm_contract, pm_customer, sys_dept, sys_user, sys_dict_data）
      - Spring Boot 文件上传配置：max-file-size: 30MB, max-request-size: 30MB
    frontend:
      - Vue 3.5 / TypeScript 5.6
      - Element Plus 2.13
      - 部门树过滤（filterDeptTree）
      - 金额自动计算（watchEffect）
      - 列显隐控制（columns 响应式对象）

  codeLocations:
    backend:
      - ruoyi-project/src/main/java/com/ruoyi/project/domain/Contract.java（合同实体，包含 @Excel 注解）
      - ruoyi-project/src/main/java/com/ruoyi/project/controller/ContractController.java（控制器，包含 export 方法）
      - ruoyi-project/src/main/java/com/ruoyi/project/service/IContractService.java（服务接口）
      - ruoyi-project/src/main/java/com/ruoyi/project/service/impl/ContractServiceImpl.java（服务实现，包含唯一性校验）
      - ruoyi-project/src/main/java/com/ruoyi/project/mapper/ContractMapper.java（Mapper）
      - ruoyi-project/src/main/resources/mapper/project/ContractMapper.xml（SQL 查询）
      - ruoyi-admin/src/main/resources/application.yml（文件上传配置）
    frontend:
      - ruoyi-ui/src/views/project/contract/index.vue（列表页，包含 handleExport 方法和列显隐功能）
      - ruoyi-ui/src/views/project/contract/form.vue（新增/编辑页，包含唯一性校验和金额计算）
      - ruoyi-ui/src/views/project/contract/detail.vue（详情页）
      - ruoyi-ui/src/views/project/contract/attachment.vue（附件页）
      - ruoyi-ui/src/api/project/contract.js（API 函数）
      - ruoyi-ui/src/router/index.ts（路由配置）
      - ruoyi-ui/src/utils/request.ts（download 方法实现）

  databaseSchema:
    mainTable: pm_contract
    relatedTables:
      - pm_customer: 客户信息（LEFT JOIN）
      - sys_dept: 部门信息（LEFT JOIN）
      - sys_dict_data: 字典数据（LEFT JOIN，合同类型和合同状态）
      - sys_user: 用户信息（LEFT JOIN，创建人和更新人）
      - pm_attachment: 附件信息（业务关联，business_type='contract'）
      - pm_attachment_log: 附件操作日志（业务关联）
      - pm_project_contract_rel: 项目合同关联表（多对多关系）

  dictDependencies:
    - sys_htlx: 合同类型
    - sys_htzt: 合同状态
    - sys_ndgl: 年度管理
    - sys_wdlx: 文档类型（附件）
    - sys_yjqy: 区域分类（客户）
    - industry: 行业分类（客户）

  excelExportConfig:
    fields:
      - sort: 0, name: 合同编号, field: contractCode
      - sort: 1, name: 合同名称, field: contractName
      - sort: 2, name: 部门名称, field: deptName (关联查询)
      - sort: 3, name: 客户名称, field: customerName (关联查询)
      - sort: 4, name: 合同类型, field: contractType, dictType: sys_htlx
      - sort: 5, name: 合同状态, field: contractStatus, dictType: sys_htzt
      - sort: 6, name: 合同签订日期, field: contractSignDate, dateFormat: yyyy-MM-dd
      - sort: 7, name: 合同周期(月), field: contractPeriod
      - sort: 8, name: 合同金额(含税), field: contractAmount
      - sort: 9, name: 税率(%), field: taxRate
      - sort: 10, name: 不含税金额, field: amountNoTax
      - sort: 11, name: 税金, field: taxAmount
      - sort: 12, name: 合同确认金额, field: confirmAmount
      - sort: 13, name: 确认年份, field: confirmYear, dictType: sys_ndgl
      - sort: 14, name: 免维期(月), field: freeMaintenancePeriod
    excludedFields:
      - customerId: 不导出ID，导出 customerName
      - deptId: 不导出ID，导出 deptName
      - reservedField1~5: 不导出备用域字段

