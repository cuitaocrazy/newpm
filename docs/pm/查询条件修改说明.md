# 查询条件修改说明

## 修改日期
2026-02-05

## 修改内容

### 1. 查询条件精简

将原有的 40+ 个查询条件精简为 **12 个常用查询条件**：

| 序号 | 字段名 | 标签 | 组件类型 | 数据源 |
|------|--------|------|----------|--------|
| 1 | project_name | 项目名称 | el-autocomplete | 项目表 pm_project |
| 2 | project_dept | 项目部门 | el-tree-select | 部门表 sys_dept（树形） |
| 3 | revenue_confirm_year | 收入确认年度 | el-select | 字典 sys_ndgl |
| 4 | project_category | 项目分类 | el-select | 字典 sys_xmfl |
| 5 | region | 一级区域 | el-select | 字典 region |
| 6 | region_code | 二级区域 | el-select（级联） | 省级区域表 pm_secondary_region |
| 7 | project_manager_id | 项目经理 | el-select | 用户表（岗位 pm） |
| 8 | market_manager_id | 市场经理 | el-select | 用户表（岗位 scjl） |
| 9 | established_year | 立项年度 | el-select | 字典 sys_ndgl |
| 10 | project_status | 项目阶段 | el-select | 字典 sys_xmjd |
| 11 | approval_status | 审核状态 | el-select | 字典 sys_spzt |
| 12 | acceptance_status | 验收状态 | el-select | 字典 sys_yszt |

### 2. 字典类型修正

**修改前**：
- 项目状态使用字典类型 `sys_xmzt`

**修改后**：
- 项目阶段使用字典类型 `sys_xmjd`

**原因**：
- `sys_xmzt` 表示项目状态（如：进行中、已完成、已暂停）
- `sys_xmjd` 表示项目阶段（如：立项、实施、验收、结项）
- 根据业务需求，查询条件应该使用项目阶段而不是项目状态

### 3. 移除的字典类型

以下字典类型不再在查询条件中使用：
- `sys_yjqy` - 已废弃，使用 `region` 代替
- `industry` - 行业字典，已从查询条件中移除

### 4. 新增功能

#### 4.1 项目名称自动补全
- 组件：`el-autocomplete`
- 实现：页面加载时获取所有项目名称，前端过滤匹配
- 方法：`queryProjectNames(queryString, cb)`

#### 4.2 二级区域级联选择
- 监听一级区域变化
- 动态加载对应的省份列表
- 方法：`handleRegionChange(value)`

#### 4.3 项目经理/市场经理下拉
- 按岗位编码过滤用户
- 支持搜索过滤
- 方法：`loadProjectManagers()`, `loadMarketManagers()`

#### 4.4 部门树形选择
- 支持多级部门结构
- 任意层级可选
- 方法：`loadDeptTree()`

## 修改的文件

### 前端文件
- `ruoyi-ui/src/views/project/project/index.vue`
  - 精简查询条件表单
  - 修改字典类型引用
  - 添加数据加载方法
  - 添加级联选择处理

### 配置文件
- `docs/gen-specs/pm_project.yml`
  - 添加查询条件数据源配置
  - 记录字典类型映射
  - 记录岗位编码要求

## 依赖配置

### 字典类型（需在系统管理中配置）

| 字典类型 | 字典名称 | 说明 | 示例值 |
|---------|---------|------|--------|
| sys_ndgl | 年度管理 | 年份选择 | 2024, 2025, 2026 |
| sys_xmfl | 项目分类 | 项目类型 | 软件开发、系统集成、技术服务 |
| region | 一级区域 | 大区划分 | 华北、华东、华南、华中 |
| sys_xmjd | 项目阶段 | 项目生命周期 | 立项、实施、验收、结项 |
| sys_spzt | 审批状态 | 审核流程状态 | 待审核、已通过、已驳回 |
| sys_yszt | 验收状态 | 验收结果 | 未验收、已验收、验收不通过 |

### 岗位编码（需在系统管理中配置）

| 岗位编码 | 岗位名称 | 说明 |
|---------|---------|------|
| pm | 项目经理 | 用于项目经理下拉选择 |
| scjl | 市场经理 | 用于市场经理下拉选择 |

## 接口依赖

| 接口 | 说明 | 返回字段 |
|------|------|----------|
| GET /system/user/listByPost | 按岗位查询用户 | userId, nickName |
| GET /system/dept/treeselect | 部门树 | id, label, children |
| GET /project/secondaryRegion/listByRegion | 二级区域 | provinceCode, provinceName |
| GET /project/project/list | 项目列表（用于自动补全） | projectName |

## 验证清单

- [ ] 确认所有字典类型已在系统中配置
- [ ] 确认岗位编码 pm 和 scjl 已配置
- [ ] 测试项目名称自动补全功能
- [ ] 测试二级区域级联选择
- [ ] 测试项目经理/市场经理下拉
- [ ] 测试部门树形选择
- [ ] 验证查询功能正常

## 注意事项

1. **字典类型必须配置**：如果字典类型未配置，对应的下拉框将为空
2. **岗位编码必须存在**：如果岗位编码不存在，项目经理/市场经理下拉框将为空
3. **接口依赖**：确保所有依赖的接口都已实现并可访问
4. **数据初始化**：页面加载时会自动调用数据加载方法，确保接口响应正常

## 后续优化建议

1. **缓存优化**：项目名称列表可以考虑缓存，避免每次加载页面都请求
2. **分页加载**：如果项目数量很大，自动补全可以考虑改为远程搜索
3. **性能优化**：部门树和用户列表可以考虑懒加载
4. **用户体验**：可以添加加载状态提示

---

**文档版本**：v1.0
**创建日期**：2026-02-05
**最后更新**：2026-02-05
