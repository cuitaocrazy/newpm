# 前端实现指南 - 项目管理模块

本文档提供项目管理模块前端的详细实现方案，基于现有的 `ruoyi-ui/src/views/project/project/index.vue` 文件进行改造。

## 目录

1. [查询条件改造](#查询条件改造)
2. [列表字段改造](#列表字段改造)
3. [汇总行实现](#汇总行实现)
4. [操作按钮改造](#操作按钮改造)
5. [收入确认功能](#收入确认功能)

---

## 查询条件改造

### 1. 添加数据定义（在 script setup 部分）

在现有的 `data` reactive 对象之后添加：

```javascript
// 项目经理列表
const projectManagerList = ref([])
// 市场经理列表
const marketManagerList = ref([])
// 部门树数据
const deptOptions = ref([])
// 省份列表（二级区域）
const provinceList = ref([])
// 汇总数据
const summaryData = ref({
  totalProjectBudget: 0,
  totalEstimatedWorkload: 0,
  totalActualWorkload: 0,
  totalContractAmount: 0,
  totalConfirmAmount: 0
})
```

### 2. 添加加载方法

```javascript
// 加载项目经理列表
async function loadProjectManagers() {
  const res = await request({
    url: '/system/user/listByPost',
    method: 'get',
    params: { postCode: 'pm' }
  })
  projectManagerList.value = res.data || []
}

// 加载市场经理列表
async function loadMarketManagers() {
  const res = await request({
    url: '/system/user/listByPost',
    method: 'get',
    params: { postCode: 'scjl' }
  })
  marketManagerList.value = res.data || []
}

// 加载部门树
async function loadDeptTree() {
  const res = await request({
    url: '/system/dept/treeselect',
    method: 'get'
  })
  deptOptions.value = res.data || []
}

// 一级区域变化时加载二级区域
async function handleRegionChange(value) {
  queryParams.value.regionCode = null
  provinceList.value = []

  if (value) {
    const res = await request({
      url: '/project/secondaryRegion/listByRegion',
      method: 'get',
      params: { regionDictValue: value }
    })
    provinceList.value = res.data || []
  }
}

// 加载汇总数据
async function loadSummary() {
  const res = await request({
    url: '/project/project/summary',
    method: 'get',
    params: queryParams.value
  })
  summaryData.value = res.data || {}
}
```

### 3. 修改 getList 方法

在现有的 `getList` 方法中添加汇总数据加载：

```javascript
async function getList() {
  loading.value = true
  // 处理日期范围参数...（保留原有代码）

  try {
    // 获取列表数据
    const res = await listProject(queryParams.value)
    projectList.value = res.rows
    total.value = res.total

    // 获取汇总数据
    await loadSummary()
  } finally {
    loading.value = false
  }
}
```

### 4. 在 onMounted 中调用加载方法

```javascript
onMounted(() => {
  getList()
  loadProjectManagers()
  loadMarketManagers()
  loadDeptTree()
})
```

### 5. 替换查询条件表单项

将现有的查询条件中的以下字段替换为：

**项目经理（替换原有的 projectManagerId 输入框）：**

```vue
<el-form-item label="项目经理" prop="projectManagerId">
  <el-select
    v-model="queryParams.projectManagerId"
    placeholder="请选择项目经理"
    filterable
    clearable
  >
    <el-option
      v-for="user in projectManagerList"
      :key="user.userId"
      :label="user.nickName"
      :value="user.userId"
    />
  </el-select>
</el-form-item>
```

**市场经理（替换原有的 marketManagerId 输入框）：**

```vue
<el-form-item label="市场经理" prop="marketManagerId">
  <el-select
    v-model="queryParams.marketManagerId"
    placeholder="请选择市场经理"
    filterable
    clearable
  >
    <el-option
      v-for="user in marketManagerList"
      :key="user.userId"
      :label="user.nickName"
      :value="user.userId"
    />
  </el-select>
</el-form-item>
```

**项目部门（替换原有的 projectDept 输入框）：**

```vue
<el-form-item label="项目部门" prop="projectDept">
  <el-tree-select
    v-model="queryParams.projectDept"
    :data="deptOptions"
    :props="{ value: 'id', label: 'label', children: 'children' }"
    check-strictly
    :render-after-expand="false"
    placeholder="请选择项目部门"
    clearable
  />
</el-form-item>
```

**二级区域（在一级区域后添加）：**

```vue
<el-form-item label="一级区域" prop="region">
  <el-select
    v-model="queryParams.region"
    placeholder="请选择一级区域"
    @change="handleRegionChange"
    clearable
  >
    <el-option
      v-for="dict in region"
      :key="dict.value"
      :label="dict.label"
      :value="dict.value"
    />
  </el-select>
</el-form-item>

<el-form-item label="二级区域" prop="regionCode">
  <el-select
    v-model="queryParams.regionCode"
    placeholder="请选择二级区域"
    filterable
    clearable
  >
    <el-option
      v-for="province in provinceList"
      :key="province.provinceCode"
      :label="province.provinceName"
      :value="province.provinceCode"
    />
  </el-select>
</el-form-item>
```

**收入确认年度（添加新查询条件）：**

```vue
<el-form-item label="收入确认年度" prop="revenueConfirmYear">
  <el-select v-model="queryParams.revenueConfirmYear" placeholder="请选择收入确认年度" clearable>
    <el-option
      v-for="dict in sys_ndgl"
      :key="dict.value"
      :label="dict.label"
      :value="dict.value"
    />
  </el-select>
</el-form-item>
```

**审批状态（添加新查询条件）：**

```vue
<el-form-item label="审批状态" prop="approvalStatus">
  <el-select v-model="queryParams.approvalStatus" placeholder="请选择审批状态" clearable>
    <el-option
      v-for="dict in sys_spzt"
      :key="dict.value"
      :label="dict.label"
      :value="dict.value"
    />
  </el-select>
</el-form-item>
```

---

## 列表字段改造

### 1. 添加格式化方法

```javascript
// 格式化金额
function formatMoney(value) {
  if (!value) return '0.00'
  return parseFloat(value).toLocaleString('zh-CN', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  })
}
```

### 2. 替换表格列定义

将现有的 `<el-table>` 标签修改为：

```vue
<el-table
  v-loading="loading"
  :data="projectList"
  @selection-change="handleSelectionChange"
  :summary-method="getSummaries"
  show-summary
>
  <el-table-column type="selection" width="55" align="center" />
  <el-table-column label="序号" type="index" width="55" align="center" />
  <el-table-column label="项目名称" prop="projectName" min-width="150" show-overflow-tooltip />
  <el-table-column label="项目部门" prop="projectDeptName" min-width="120" show-overflow-tooltip />
  <el-table-column label="项目经理" prop="projectManagerName" width="100" />
  <el-table-column label="项目分类" prop="projectCategory" width="100">
    <template #default="scope">
      <dict-tag :options="sys_xmfl" :value="scope.row.projectCategory" />
    </template>
  </el-table-column>
  <el-table-column label="项目预算" prop="projectBudget" width="120" align="right">
    <template #default="scope">
      {{ formatMoney(scope.row.projectBudget) }}
    </template>
  </el-table-column>
  <el-table-column label="预估工作量(人天)" prop="estimatedWorkload" width="140" align="right" />
  <el-table-column label="实际人天" prop="actualWorkload" width="100" align="right" />
  <el-table-column label="合同金额(元)" prop="contractAmount" width="120" align="right">
    <template #default="scope">
      {{ formatMoney(scope.row.contractAmount) }}
    </template>
  </el-table-column>
  <el-table-column label="收入确认年度" prop="revenueConfirmYear" width="120" />
  <el-table-column label="收入确认状态" prop="revenueConfirmStatus" width="120">
    <template #default="scope">
      <el-tag v-if="scope.row.revenueConfirmStatus === '1'" type="success">已确认</el-tag>
      <el-tag v-else type="info">未确认</el-tag>
    </template>
  </el-table-column>
  <el-table-column label="确认金额(元)" prop="confirmAmount" width="120" align="right">
    <template #default="scope">
      {{ formatMoney(scope.row.confirmAmount) }}
    </template>
  </el-table-column>
  <el-table-column label="参与人员" prop="participantsNames" min-width="150" show-overflow-tooltip />
  <el-table-column label="启动日期" prop="startDate" width="100" />
  <el-table-column label="结束日期" prop="endDate" width="100" />
  <el-table-column label="验收日期" prop="acceptanceDate" width="100" />
  <el-table-column label="审核状态" prop="approvalStatus" width="100">
    <template #default="scope">
      <dict-tag :options="sys_spzt" :value="scope.row.approvalStatus" />
    </template>
  </el-table-column>
  <el-table-column label="项目状态" prop="projectStatus" width="100">
    <template #default="scope">
      <dict-tag :options="sys_xmzt" :value="scope.row.projectStatus" />
    </template>
  </el-table-column>
  <el-table-column label="验收状态" prop="acceptanceStatus" width="100">
    <template #default="scope">
      <dict-tag :options="sys_yszt" :value="scope.row.acceptanceStatus" />
    </template>
  </el-table-column>
  <el-table-column label="更新人" prop="updateBy" width="100" />
  <el-table-column label="更新时间" prop="updateTime" width="160" />
  <el-table-column label="操作" fixed="right" width="300" align="center" class-name="small-padding fixed-width">
    <template #default="scope">
      <el-button link type="primary" @click="handleDetail(scope.row)" v-hasPermi="['project:project:query']">查看详情</el-button>
      <el-button link type="primary" @click="handleUpdate(scope.row)" v-hasPermi="['project:project:edit']">编辑</el-button>
      <el-button link type="primary" @click="handleConfirmRevenue(scope.row)" v-hasPermi="['project:project:edit']">收入确认</el-button>
      <el-button link type="danger" @click="handleDelete(scope.row)" v-hasPermi="['project:project:remove']">删除</el-button>
    </template>
  </el-table-column>
</el-table>
```

---

## 汇总行实现

### 添加汇总方法

```javascript
// 自定义汇总行
function getSummaries(param) {
  const { columns } = param
  const sums = []

  columns.forEach((column, index) => {
    if (index === 0) {
      sums[index] = '合计'
      return
    }
    if (index === 1) {
      sums[index] = ''
      return
    }

    switch (column.property) {
      case 'projectBudget':
        sums[index] = formatMoney(summaryData.value.totalProjectBudget)
        break
      case 'estimatedWorkload':
        sums[index] = summaryData.value.totalEstimatedWorkload
        break
      case 'actualWorkload':
        sums[index] = summaryData.value.totalActualWorkload
        break
      case 'contractAmount':
        sums[index] = formatMoney(summaryData.value.totalContractAmount)
        break
      case 'confirmAmount':
        sums[index] = formatMoney(summaryData.value.totalConfirmAmount)
        break
      default:
        sums[index] = ''
    }
  })

  return sums
}
```

---

## 操作按钮改造

### 1. 查看详情（只读模式）

```javascript
// 查看详情
function handleDetail(row) {
  reset()
  open.value = true
  title.value = '项目详情'
  readonly.value = true  // 需要添加 readonly ref

  getProject(row.projectId).then(response => {
    form.value = response.data
  })
}
```

在 data 部分添加：

```javascript
const readonly = ref(false)
```

在表单对话框中添加 `:disabled="readonly"` 到所有表单项。

### 2. 编辑

保持原有的 `handleUpdate` 方法，确保设置 `readonly.value = false`。

### 3. 删除

保持原有的 `handleDelete` 方法。

---

## 收入确认功能

### 1. 添加数据定义

```javascript
// 收入确认弹窗
const revenueDialog = ref(false)
const revenueForm = ref({})
const revenueRules = {
  taxRate: [{ required: true, message: '请选择税率', trigger: 'change' }],
  confirmAmount: [{ required: true, message: '请输入确认金额', trigger: 'blur' }],
  revenueConfirmYear: [{ required: true, message: '请选择收入确认年度', trigger: 'change' }],
  revenueConfirmStatus: [{ required: true, message: '请选择收入确认状态', trigger: 'change' }]
}
```

### 2. 添加计算属性

```javascript
// 合同不含税金额
const contractAmountNoTax = computed(() => {
  if (!revenueForm.value.contractAmount || !revenueForm.value.taxRate) {
    return '0.00'
  }
  const amount = parseFloat(revenueForm.value.contractAmount)
  const rate = parseFloat(revenueForm.value.taxRate) / 100
  return (amount / (1 + rate)).toFixed(2)
})

// 税后金额
const afterTaxAmount = computed(() => {
  if (!revenueForm.value.confirmAmount || !revenueForm.value.taxRate) {
    return '0.00'
  }
  const amount = parseFloat(revenueForm.value.confirmAmount)
  const rate = parseFloat(revenueForm.value.taxRate) / 100
  return (amount / (1 + rate)).toFixed(2)
})
```

### 3. 添加方法

```javascript
// 打开收入确认弹窗
function handleConfirmRevenue(row) {
  revenueDialog.value = true

  // 获取项目详情
  getProject(row.projectId).then(response => {
    revenueForm.value = { ...response.data }

    // 如果没有税率，默认设置为6%
    if (!revenueForm.value.taxRate) {
      revenueForm.value.taxRate = 6
    }
  })
}

// 提交收入确认
function submitRevenueConfirm() {
  proxy.$refs.revenueFormRef.validate(valid => {
    if (valid) {
      // 计算税后金额并保存
      revenueForm.value.afterTaxAmount = afterTaxAmount.value

      confirmRevenue(revenueForm.value).then(() => {
        proxy.$modal.msgSuccess('收入确认成功')
        revenueDialog.value = false
        getList()
      })
    }
  })
}
```

### 4. 添加收入确认弹窗（在 template 中）

```vue
<!-- 收入确认弹窗 -->
<el-dialog
  v-model="revenueDialog"
  title="收入确认"
  width="1200px"
  :close-on-click-modal="false"
>
  <el-row :gutter="20">
    <!-- 左侧：项目信息 -->
    <el-col :span="12">
      <el-card header="项目信息">
        <el-descriptions :column="1" border>
          <el-descriptions-item label="项目编号">{{ revenueForm.projectCode }}</el-descriptions-item>
          <el-descriptions-item label="项目名称">{{ revenueForm.projectName }}</el-descriptions-item>
          <el-descriptions-item label="项目分类">
            <dict-tag :options="sys_xmfl" :value="revenueForm.projectCategory" />
          </el-descriptions-item>
          <el-descriptions-item label="项目预算">{{ formatMoney(revenueForm.projectBudget) }}</el-descriptions-item>
          <el-descriptions-item label="项目经理">{{ revenueForm.projectManagerName }}</el-descriptions-item>
          <el-descriptions-item label="市场经理">{{ revenueForm.marketManagerName }}</el-descriptions-item>
          <el-descriptions-item label="启动日期">{{ revenueForm.startDate }}</el-descriptions-item>
          <el-descriptions-item label="结束日期">{{ revenueForm.endDate }}</el-descriptions-item>
        </el-descriptions>
      </el-card>
    </el-col>

    <!-- 右侧：收入确认信息 -->
    <el-col :span="12">
      <el-card header="收入确认信息">
        <el-form ref="revenueFormRef" :model="revenueForm" :rules="revenueRules" label-width="140px">
          <el-form-item label="合同金额" prop="contractAmount">
            <el-input v-model="revenueForm.contractAmount" disabled>
              <template #append>元</template>
            </el-input>
          </el-form-item>

          <el-form-item label="税率" prop="taxRate">
            <el-select v-model="revenueForm.taxRate" placeholder="请选择税率">
              <el-option label="6% (软件开发类)" :value="6" />
              <el-option label="13% (硬件类)" :value="13" />
            </el-select>
          </el-form-item>

          <el-form-item label="不含税金额">
            <el-input v-model="contractAmountNoTax" disabled>
              <template #append>元</template>
            </el-input>
            <div style="color: #909399; font-size: 12px; margin-top: 4px;">
              计算公式：合同金额 / (1 + 税率)
            </div>
          </el-form-item>

          <el-form-item label="收入确认年度" prop="revenueConfirmYear">
            <el-select v-model="revenueForm.revenueConfirmYear" placeholder="请选择年度">
              <el-option
                v-for="dict in sys_ndgl"
                :key="dict.value"
                :label="dict.label"
                :value="dict.value"
              />
            </el-select>
          </el-form-item>

          <el-form-item label="确认金额(含税)" prop="confirmAmount">
            <el-input v-model="revenueForm.confirmAmount">
              <template #append>元</template>
            </el-input>
          </el-form-item>

          <el-form-item label="税后金额">
            <el-input v-model="afterTaxAmount" disabled>
              <template #append>元</template>
            </el-input>
            <div style="color: #909399; font-size: 12px; margin-top: 4px;">
              计算公式：确认金额 / (1 + 税率)
            </div>
          </el-form-item>

          <el-form-item label="收入确认状态" prop="revenueConfirmStatus">
            <el-radio-group v-model="revenueForm.revenueConfirmStatus">
              <el-radio label="0">未确认</el-radio>
              <el-radio label="1">已确认</el-radio>
            </el-radio-group>
          </el-form-item>

          <el-form-item label="确认人姓名" prop="companyRevenueConfirmedByName">
            <el-input v-model="revenueForm.companyRevenueConfirmedByName" placeholder="请输入确认人姓名" />
          </el-form-item>

          <el-form-item label="确认时间" prop="confirmTime">
            <el-date-picker
              v-model="revenueForm.confirmTime"
              type="datetime"
              placeholder="选择确认时间"
              value-format="YYYY-MM-DD HH:mm:ss"
            />
          </el-form-item>
        </el-form>
      </el-card>
    </el-col>
  </el-row>

  <template #footer>
    <el-button @click="revenueDialog = false">取消</el-button>
    <el-button type="primary" @click="submitRevenueConfirm">确定</el-button>
  </template>
</el-dialog>
```

---

## 导入语句

确保在 script setup 顶部添加必要的导入：

```javascript
import { listProject, getProject, delProject, addProject, updateProject, getProjectSummary, confirmRevenue } from "@/api/project/project"
import request from '@/utils/request'
import { computed } from 'vue'
```

---

## 实施检查清单

### 查询条件
- [ ] 添加数据定义（projectManagerList, marketManagerList, deptOptions, provinceList, summaryData）
- [ ] 添加加载方法（loadProjectManagers, loadMarketManagers, loadDeptTree, handleRegionChange, loadSummary）
- [ ] 修改 getList 方法添加汇总数据加载
- [ ] 在 onMounted 中调用加载方法
- [ ] 替换项目经理查询条件
- [ ] 替换市场经理查询条件
- [ ] 替换项目部门查询条件
- [ ] 添加二级区域查询条件
- [ ] 添加收入确认年度查询条件
- [ ] 添加审批状态查询条件

### 列表字段
- [ ] 添加 formatMoney 方法
- [ ] 替换表格列定义
- [ ] 添加 show-summary 属性
- [ ] 添加 :summary-method 属性

### 汇总行
- [ ] 添加 getSummaries 方法

### 操作按钮
- [ ] 添加 readonly ref
- [ ] 修改 handleDetail 方法
- [ ] 在表单中添加 :disabled="readonly"

### 收入确认
- [ ] 添加数据定义（revenueDialog, revenueForm, revenueRules）
- [ ] 添加计算属性（contractAmountNoTax, afterTaxAmount）
- [ ] 添加方法（handleConfirmRevenue, submitRevenueConfirm）
- [ ] 添加收入确认弹窗模板

---

## 注意事项

1. **导入 request**：确保在 script setup 顶部导入 `request` 工具
2. **字典类型**：确保所有字典类型（sys_xmfl、sys_xmzt、sys_yszt、sys_spzt、sys_ndgl、region）已在字典管理中配置
3. **权限标识**：确保所有权限标识（project:project:list、project:project:query、project:project:edit、project:project:remove）已在菜单管理中配置
4. **合同关联**：确保 pm_project_contract_rel 表中正确维护了项目和合同的关联关系
5. **岗位编码**：确保系统中存在岗位编码 `pm`（项目经理）和 `scjl`（市场经理）

---

**文档版本**：v1.0
**创建日期**：2026-02-05
**最后更新**：2026-02-05
