# 项目管理定制实现指南

本文档提供项目管理模块的详细实现方案，基于 `docs/gen-specs/pm_project.yml` 中的 customizations 配置。

## 目录

1. [后端实现](#后端实现)
   - [实体类扩展](#实体类扩展)
   - [Mapper XML 增强](#mapper-xml-增强)
   - [接口实现](#接口实现)
2. [前端实现](#前端实现)
   - [查询条件定制](#查询条件定制)
   - [列表字段定制](#列表字段定制)
   - [操作按钮定制](#操作按钮定制)
   - [收入确认功能](#收入确认功能)

---

## 后端实现

### 实体类扩展

在 `Project.java` 中添加以下扩展字段（用于列表显示）：

```java
/** 项目经理昵称 */
private String projectManagerName;

/** 市场经理昵称 */
private String marketManagerName;

/** 参与人员昵称列表（逗号分隔） */
private String participantsNames;

/** 项目部门名称（格式化：三级及以下用"-"隔开） */
private String projectDeptName;

/** 合同金额 */
private BigDecimal contractAmount;

/** 合同状态 */
private String contractStatus;

// 添加对应的 getter 和 setter 方法
```

### Mapper XML 增强

修改 `ProjectMapper.xml` 中的 `selectProjectList` 查询：

#### 1. 更新 resultMap

```xml
<resultMap type="Project" id="ProjectResult">
    <!-- 原有字段映射 -->
    ...
    
    <!-- 新增扩展字段映射 -->
    <result property="projectManagerName" column="project_manager_name" />
    <result property="marketManagerName" column="market_manager_name" />
    <result property="participantsNames" column="participants_names" />
    <result property="projectDeptName" column="project_dept_name" />
    <result property="contractAmount" column="contract_amount" />
    <result property="contractStatus" column="contract_status" />
</resultMap>
```

#### 2. 增强查询 SQL

```xml
<select id="selectProjectList" parameterType="Project" resultMap="ProjectResult">
    select 
        p.project_id,
        p.project_code,
        p.project_name,
        p.project_category,
        p.project_budget,
        p.estimated_workload,
        p.actual_workload,
        p.revenue_confirm_year,
        p.revenue_confirm_status,
        p.confirm_amount,
        p.start_date,
        p.end_date,
        p.acceptance_date,
        p.approval_status,
        p.project_status,
        p.acceptance_status,
        p.update_by,
        p.update_time,
        
        <!-- 项目经理昵称 -->
        pm.nick_name as project_manager_name,
        
        <!-- 市场经理昵称 -->
        mm.nick_name as market_manager_name,
        
        <!-- 项目部门格式化（三级及以下用"-"隔开） -->
        CASE 
            WHEN LENGTH(d.ancestors) - LENGTH(REPLACE(d.ancestors, ',', '')) >= 2 
            THEN SUBSTRING_INDEX(
                GROUP_CONCAT(
                    CASE WHEN dd.dept_id IN (
                        SELECT dept_id FROM sys_dept 
                        WHERE FIND_IN_SET(dept_id, d.ancestors) 
                        AND LENGTH(ancestors) - LENGTH(REPLACE(ancestors, ',', '')) >= 2
                    ) OR dd.dept_id = d.dept_id
                    THEN dd.dept_name END 
                    ORDER BY dd.dept_id SEPARATOR '-'
                ), '-', -1)
            ELSE d.dept_name 
        END as project_dept_name,
        
        <!-- 参与人员昵称列表 -->
        (
            SELECT GROUP_CONCAT(u.nick_name SEPARATOR ',')
            FROM sys_user u
            WHERE FIND_IN_SET(u.user_id, p.participants)
        ) as participants_names,
        
        <!-- 合同金额（主合同） -->
        c.contract_amount,
        
        <!-- 合同状态（主合同） -->
        c.contract_status
        
    from pm_project p
    
    <!-- 关联项目经理 -->
    left join sys_user pm on p.project_manager_id = pm.user_id
    
    <!-- 关联市场经理 -->
    left join sys_user mm on p.market_manager_id = mm.user_id
    
    <!-- 关联部门 -->
    left join sys_dept d on p.project_dept = d.dept_id
    left join sys_dept dd on FIND_IN_SET(dd.dept_id, d.ancestors) OR dd.dept_id = d.dept_id
    
    <!-- 关联合同（通过关联表，取主合同） -->
    left join pm_project_contract_rel rel on p.project_id = rel.project_id and rel.is_main = '1'
    left join pm_contract c on rel.contract_id = c.contract_id
    
    <where>
        <if test="projectName != null and projectName != ''">
            and p.project_name like concat('%', #{projectName}, '%')
        </if>
        <if test="projectDept != null and projectDept != ''">
            and p.project_dept = #{projectDept}
        </if>
        <if test="revenueConfirmYear != null and revenueConfirmYear != ''">
            and p.revenue_confirm_year = #{revenueConfirmYear}
        </if>
        <if test="projectCategory != null and projectCategory != ''">
            and p.project_category = #{projectCategory}
        </if>
        <if test="region != null and region != ''">
            and p.region = #{region}
        </if>
        <if test="regionCode != null and regionCode != ''">
            and p.region_code = #{regionCode}
        </if>
        <if test="projectManagerId != null">
            and p.project_manager_id = #{projectManagerId}
        </if>
        <if test="marketManagerId != null">
            and p.market_manager_id = #{marketManagerId}
        </if>
        <if test="establishedYear != null">
            and p.established_year = #{establishedYear}
        </if>
        <if test="projectStatus != null and projectStatus != ''">
            and p.project_status = #{projectStatus}
        </if>
        <if test="approvalStatus != null and approvalStatus != ''">
            and p.approval_status = #{approvalStatus}
        </if>
        <if test="acceptanceStatus != null and acceptanceStatus != ''">
            and p.acceptance_status = #{acceptanceStatus}
        </if>
    </where>
    
    group by p.project_id
    order by p.create_time desc
</select>
```

**⚠️ 重要提示：字符集排序规则问题**

如果遇到 `Illegal mix of collations` 错误，需要在 JOIN 系统表时显式指定排序规则：

```xml
<!-- 错误写法 -->
left join sys_user pm on p.project_manager_id = pm.user_id

<!-- 正确写法 -->
left join sys_user pm on CAST(p.project_manager_id AS CHAR) COLLATE utf8mb4_unicode_ci = CAST(pm.user_id AS CHAR) COLLATE utf8mb4_unicode_ci
```

或者在字符串字段比较时：

```xml
left join sys_dept d on p.project_dept COLLATE utf8mb4_unicode_ci = d.dept_id
```


### 接口实现

#### 1. 已完成的接口

✅ **按客户ID查询联系人**
- 路径：`GET /project/customer/contact/listByCustomer?customerId={customerId}`
- 位置：`CustomerController.java`

✅ **按一级区域查询省份**
- 路径：`GET /project/secondaryRegion/listByRegion?regionDictValue={regionDictValue}`
- 位置：`SecondaryRegionController.java`

✅ **收入确认**
- 路径：`PUT /project/project/confirmRevenue`
- 位置：`ProjectController.java`

#### 2. 需要新增的接口

**汇总统计接口**

在 `ProjectController.java` 中添加：

```java
/**
 * 获取项目列表汇总统计
 */
@GetMapping("/summary")
public AjaxResult getSummary(Project project)
{
    Map<String, Object> summary = projectService.getProjectSummary(project);
    return success(summary);
}
```

在 `IProjectService.java` 中添加：

```java
/**
 * 获取项目列表汇总统计
 * 
 * @param project 查询条件
 * @return 汇总数据
 */
Map<String, Object> getProjectSummary(Project project);
```

在 `ProjectServiceImpl.java` 中实现：

```java
@Override
public Map<String, Object> getProjectSummary(Project project)
{
    return projectMapper.selectProjectSummary(project);
}
```

在 `ProjectMapper.java` 中添加：

```java
/**
 * 查询项目汇总统计
 * 
 * @param project 查询条件
 * @return 汇总数据
 */
Map<String, Object> selectProjectSummary(Project project);
```

在 `ProjectMapper.xml` 中添加：

```xml
<select id="selectProjectSummary" parameterType="Project" resultType="map">
    select 
        IFNULL(SUM(p.project_budget), 0) as totalProjectBudget,
        IFNULL(SUM(p.estimated_workload), 0) as totalEstimatedWorkload,
        IFNULL(SUM(p.actual_workload), 0) as totalActualWorkload,
        IFNULL(SUM(c.contract_amount), 0) as totalContractAmount,
        IFNULL(SUM(p.confirm_amount), 0) as totalConfirmAmount
    from pm_project p
    left join pm_project_contract_rel rel on p.project_id = rel.project_id and rel.is_main = '1'
    left join pm_contract c on rel.contract_id = c.contract_id
    <where>
        <!-- 复用 selectProjectList 的查询条件 -->
        <if test="projectName != null and projectName != ''">
            and p.project_name like concat('%', #{projectName}, '%')
        </if>
        <!-- ... 其他查询条件 ... -->
    </where>
</select>
```

---

## 前端实现

### 查询条件定制

#### 1. 项目经理下拉选择（按岗位pm）

```vue
<el-form-item label="项目经理" prop="projectManagerId">
  <el-select 
    v-model="queryParams.projectManagerId" 
    placeholder="请选择项目经理"
    filterable
    clearable
  >
    <el-option
      v-for="user in projectManagerList"
      :key="user.userId"
      :label="user.nickName"
      :value="user.userId"
    />
  </el-select>
</el-form-item>
```

```javascript
// 数据定义
data() {
  return {
    projectManagerList: [], // 项目经理列表
  }
},

// 加载项目经理列表
methods: {
  async loadProjectManagers() {
    const res = await request({
      url: '/system/user/listByPost',
      method: 'get',
      params: { postCode: 'pm' }
    })
    this.projectManagerList = res.data || []
  }
},

// 页面加载时调用
created() {
  this.loadProjectManagers()
}
```

#### 2. 市场经理下拉选择（按岗位scjl）

```vue
<el-form-item label="市场经理" prop="marketManagerId">
  <el-select 
    v-model="queryParams.marketManagerId" 
    placeholder="请选择市场经理"
    filterable
    clearable
  >
    <el-option
      v-for="user in marketManagerList"
      :key="user.userId"
      :label="user.nickName"
      :value="user.userId"
    />
  </el-select>
</el-form-item>
```

```javascript
// 加载市场经理列表
async loadMarketManagers() {
  const res = await request({
    url: '/system/user/listByPost',
    method: 'get',
    params: { postCode: 'scjl' }
  })
  this.marketManagerList = res.data || []
}
```

#### 3. 项目部门树形选择

```vue
<el-form-item label="项目部门" prop="projectDept">
  <el-tree-select
    v-model="queryParams.projectDept"
    :data="deptOptions"
    :props="{ value: 'id', label: 'label', children: 'children' }"
    check-strictly
    :render-after-expand="false"
    placeholder="请选择项目部门"
    clearable
  />
</el-form-item>
```

```javascript
// 加载部门树
async loadDeptTree() {
  const res = await request({
    url: '/system/dept/treeselect',
    method: 'get'
  })
  this.deptOptions = res.data || []
}
```

#### 4. 二级区域级联选择

```vue
<el-form-item label="一级区域" prop="region">
  <el-select 
    v-model="queryParams.region" 
    placeholder="请选择一级区域"
    @change="handleRegionChange"
    clearable
  >
    <el-option
      v-for="dict in dict.type.region"
      :key="dict.value"
      :label="dict.label"
      :value="dict.value"
    />
  </el-select>
</el-form-item>

<el-form-item label="二级区域" prop="regionCode">
  <el-select 
    v-model="queryParams.regionCode" 
    placeholder="请选择二级区域"
    filterable
    clearable
  >
    <el-option
      v-for="province in provinceList"
      :key="province.provinceCode"
      :label="province.provinceName"
      :value="province.provinceCode"
    />
  </el-select>
</el-form-item>
```

```javascript
// 一级区域变化时加载二级区域
async handleRegionChange(value) {
  this.queryParams.regionCode = null
  this.provinceList = []

  if (value) {
    const res = await request({
      url: '/project/secondaryRegion/listByRegion',
      method: 'get',
      params: { regionDictValue: value }
    })
    this.provinceList = res.data || []
  }
}
```

### 列表字段定制

#### 1. 列表字段配置

```vue
<el-table-column label="序号" type="index" width="55" align="center" />
<el-table-column label="项目名称" prop="projectName" min-width="150" show-overflow-tooltip />
<el-table-column label="项目部门" prop="projectDeptName" min-width="120" show-overflow-tooltip />
<el-table-column label="项目经理" prop="projectManagerName" width="100" />
<el-table-column label="项目分类" prop="projectCategory" width="100">
  <template #default="scope">
    <dict-tag :options="dict.type.sys_xmfl" :value="scope.row.projectCategory" />
  </template>
</el-table-column>
<el-table-column label="项目预算" prop="projectBudget" width="120" align="right">
  <template #default="scope">
    {{ formatMoney(scope.row.projectBudget) }}
  </template>
</el-table-column>
<el-table-column label="预估工作量(人天)" prop="estimatedWorkload" width="140" align="right" />
<el-table-column label="实际人天" prop="actualWorkload" width="100" align="right" />
<el-table-column label="合同金额(元)" prop="contractAmount" width="120" align="right">
  <template #default="scope">
    {{ formatMoney(scope.row.contractAmount) }}
  </template>
</el-table-column>
<el-table-column label="收入确认年度" prop="revenueConfirmYear" width="120" />
<el-table-column label="合同状态" prop="contractStatus" width="100">
  <template #default="scope">
    <dict-tag :options="dict.type.sys_htzt" :value="scope.row.contractStatus" />
  </template>
</el-table-column>
<el-table-column label="收入确认状态" prop="revenueConfirmStatus" width="120">
  <template #default="scope">
    <el-tag v-if="scope.row.revenueConfirmStatus === '1'" type="success">已确认</el-tag>
    <el-tag v-else type="info">未确认</el-tag>
  </template>
</el-table-column>
<el-table-column label="确认金额(元)" prop="confirmAmount" width="120" align="right">
  <template #default="scope">
    {{ formatMoney(scope.row.confirmAmount) }}
  </template>
</el-table-column>
<el-table-column label="参与人员" prop="participantsNames" min-width="150" show-overflow-tooltip />
<el-table-column label="启动日期" prop="startDate" width="100" />
<el-table-column label="结束日期" prop="endDate" width="100" />
<el-table-column label="验收日期" prop="acceptanceDate" width="100" />
<el-table-column label="审核状态" prop="approvalStatus" width="100">
  <template #default="scope">
    <dict-tag :options="dict.type.sys_spzt" :value="scope.row.approvalStatus" />
  </template>
</el-table-column>
<el-table-column label="项目状态" prop="projectStatus" width="100">
  <template #default="scope">
    <dict-tag :options="dict.type.sys_xmzt" :value="scope.row.projectStatus" />
  </template>
</el-table-column>
<el-table-column label="验收状态" prop="acceptanceStatus" width="100">
  <template #default="scope">
    <dict-tag :options="dict.type.sys_yszt" :value="scope.row.acceptanceStatus" />
  </template>
</el-table-column>
<el-table-column label="更新人" prop="updateBy" width="100" />
<el-table-column label="更新时间" prop="updateTime" width="160" />
<el-table-column label="操作" fixed="right" width="300" align="center">
  <template #default="scope">
    <el-button link type="primary" @click="handleDetail(scope.row)">查看详情</el-button>
    <el-button link type="primary" @click="handleUpdate(scope.row)">编辑</el-button>
    <el-button link type="primary" @click="handleConfirmRevenue(scope.row)">收入确认</el-button>
    <el-button link type="primary" @click="handleAttachment(scope.row)">附件</el-button>
    <el-button link type="danger" @click="handleDelete(scope.row)">删除</el-button>
    <el-button link type="warning" @click="handlePrint(scope.row)">打印</el-button>
  </template>
</el-table-column>
```

#### 2. 汇总行实现

```vue
<el-table
  :data="projectList"
  :summary-method="getSummaries"
  show-summary
>
  <!-- 列定义 -->
</el-table>
```

```javascript
// 汇总统计数据
data() {
  return {
    summaryData: {
      totalProjectBudget: 0,
      totalEstimatedWorkload: 0,
      totalActualWorkload: 0,
      totalContractAmount: 0,
      totalConfirmAmount: 0
    }
  }
},

methods: {
  // 获取列表数据
  async getList() {
    this.loading = true
    try {
      // 获取列表数据
      const res = await listProject(this.queryParams)
      this.projectList = res.rows
      this.total = res.total

      // 获取汇总数据
      await this.loadSummary()
    } finally {
      this.loading = false
    }
  },

  // 加载汇总数据
  async loadSummary() {
    const res = await request({
      url: '/project/project/summary',
      method: 'get',
      params: this.queryParams
    })
    this.summaryData = res.data || {}
  },

  // 自定义汇总行
  getSummaries(param) {
    const { columns } = param
    const sums = []

    columns.forEach((column, index) => {
      if (index === 0) {
        sums[index] = '合计'
        return
      }

      switch (column.property) {
        case 'projectBudget':
          sums[index] = this.formatMoney(this.summaryData.totalProjectBudget)
          break
        case 'estimatedWorkload':
          sums[index] = this.summaryData.totalEstimatedWorkload
          break
        case 'actualWorkload':
          sums[index] = this.summaryData.totalActualWorkload
          break
        case 'contractAmount':
          sums[index] = this.formatMoney(this.summaryData.totalContractAmount)
          break
        case 'confirmAmount':
          sums[index] = this.formatMoney(this.summaryData.totalConfirmAmount)
          break
        default:
          sums[index] = ''
      }
    })

    return sums
  },

  // 格式化金额
  formatMoney(value) {
    if (!value) return '0.00'
    return parseFloat(value).toLocaleString('zh-CN', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    })
  }
}
```

### 操作按钮定制

#### 1. 查看详情

```javascript
// 查看详情（只读模式）
handleDetail(row) {
  this.reset()
  this.open = true
  this.title = '项目详情'
  this.readonly = true

  getProject(row.projectId).then(response => {
    this.form = response.data
  })
}
```

#### 2. 编辑

```javascript
// 编辑项目
handleUpdate(row) {
  this.reset()
  this.open = true
  this.title = '修改项目'
  this.readonly = false

  getProject(row.projectId).then(response => {
    this.form = response.data
  })
}
```

#### 3. 附件管理

```javascript
// 附件管理
handleAttachment(row) {
  this.attachmentDialog = true
  this.currentProjectId = row.projectId
  this.currentProjectName = row.projectName

  // 加载附件列表
  this.loadAttachments(row.projectId)
}
```

#### 4. 删除

```javascript
// 删除项目
handleDelete(row) {
  this.$modal.confirm('是否确认删除项目编号为"' + row.projectCode + '"的数据项？').then(() => {
    return delProject(row.projectId)
  }).then(() => {
    this.getList()
    this.$modal.msgSuccess('删除成功')
  }).catch(() => {})
}
```

#### 5. 打印立项申请单

```javascript
// 打印立项申请单
handlePrint(row) {
  // 打开打印预览窗口
  const printWindow = window.open('', '_blank')

  // 获取项目详情
  getProject(row.projectId).then(response => {
    const project = response.data

    // 生成打印HTML
    const printHtml = this.generatePrintHtml(project)

    printWindow.document.write(printHtml)
    printWindow.document.close()

    // 延迟打印，确保内容加载完成
    setTimeout(() => {
      printWindow.print()
    }, 500)
  })
},

// 生成打印HTML
generatePrintHtml(project) {
  return `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <title>项目立项申请单</title>
      <style>
        body { font-family: SimSun, serif; padding: 20px; }
        h1 { text-align: center; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        td, th { border: 1px solid #000; padding: 8px; }
        .label { width: 120px; background-color: #f0f0f0; font-weight: bold; }
        @media print {
          .no-print { display: none; }
        }
      </style>
    </head>
    <body>
      <h1>项目立项申请单</h1>
      <table>
        <tr>
          <td class="label">项目编号</td>
          <td>${project.projectCode || ''}</td>
          <td class="label">项目名称</td>
          <td>${project.projectName || ''}</td>
        </tr>
        <tr>
          <td class="label">立项年度</td>
          <td>${project.establishedYear || ''}</td>
          <td class="label">项目分类</td>
          <td>${project.projectCategory || ''}</td>
        </tr>
        <!-- 更多字段... -->
      </table>
    </body>
    </html>
  `
}
```

### 收入确认功能

#### 1. 收入确认弹窗

```vue
<el-dialog
  v-model="revenueDialog"
  title="收入确认"
  width="1200px"
  :close-on-click-modal="false"
>
  <el-row :gutter="20">
    <!-- 左侧：项目信息 -->
    <el-col :span="12">
      <el-card header="项目信息">
        <el-descriptions :column="1" border>
          <el-descriptions-item label="项目编号">{{ revenueForm.projectCode }}</el-descriptions-item>
          <el-descriptions-item label="项目名称">{{ revenueForm.projectName }}</el-descriptions-item>
          <el-descriptions-item label="项目分类">{{ revenueForm.projectCategory }}</el-descriptions-item>
          <el-descriptions-item label="项目预算">{{ formatMoney(revenueForm.projectBudget) }}</el-descriptions-item>
          <el-descriptions-item label="项目经理">{{ revenueForm.projectManagerName }}</el-descriptions-item>
          <el-descriptions-item label="市场经理">{{ revenueForm.marketManagerName }}</el-descriptions-item>
          <el-descriptions-item label="启动日期">{{ revenueForm.startDate }}</el-descriptions-item>
          <el-descriptions-item label="结束日期">{{ revenueForm.endDate }}</el-descriptions-item>
        </el-descriptions>
      </el-card>
    </el-col>

    <!-- 右侧：收入确认信息 -->
    <el-col :span="12">
      <el-card header="收入确认信息">
        <el-form ref="revenueFormRef" :model="revenueForm" :rules="revenueRules" label-width="140px">
          <el-form-item label="合同金额" prop="contractAmount">
            <el-input v-model="revenueForm.contractAmount" disabled>
              <template #append>元</template>
            </el-input>
          </el-form-item>

          <el-form-item label="税率" prop="taxRate">
            <el-select v-model="revenueForm.taxRate" placeholder="请选择税率" @change="handleTaxRateChange">
              <el-option label="6% (软件开发类)" :value="6" />
              <el-option label="13% (硬件类)" :value="13" />
            </el-select>
          </el-form-item>

          <el-form-item label="不含税金额">
            <el-input v-model="contractAmountNoTax" disabled>
              <template #append>元</template>
            </el-input>
            <div style="color: #909399; font-size: 12px; margin-top: 4px;">
              计算公式：合同金额 / (1 + 税率)
            </div>
          </el-form-item>

          <el-form-item label="收入确认年度" prop="revenueConfirmYear">
            <el-select v-model="revenueForm.revenueConfirmYear" placeholder="请选择年度">
              <el-option
                v-for="dict in dict.type.sys_ndgl"
                :key="dict.value"
                :label="dict.label"
                :value="dict.value"
              />
            </el-select>
          </el-form-item>

          <el-form-item label="确认金额(含税)" prop="confirmAmount">
            <el-input v-model="revenueForm.confirmAmount" @input="handleConfirmAmountChange">
              <template #append>元</template>
            </el-input>
          </el-form-item>

          <el-form-item label="税后金额">
            <el-input v-model="afterTaxAmount" disabled>
              <template #append>元</template>
            </el-input>
            <div style="color: #909399; font-size: 12px; margin-top: 4px;">
              计算公式：确认金额 / (1 + 税率)
            </div>
          </el-form-item>

          <el-form-item label="收入确认状态" prop="revenueConfirmStatus">
            <el-radio-group v-model="revenueForm.revenueConfirmStatus">
              <el-radio label="0">未确认</el-radio>
              <el-radio label="1">已确认</el-radio>
            </el-radio-group>
          </el-form-item>

          <el-form-item label="确认人姓名" prop="companyRevenueConfirmedByName">
            <el-input v-model="revenueForm.companyRevenueConfirmedByName" placeholder="请输入确认人姓名" />
          </el-form-item>

          <el-form-item label="确认时间" prop="confirmTime">
            <el-date-picker
              v-model="revenueForm.confirmTime"
              type="datetime"
              placeholder="选择确认时间"
              value-format="YYYY-MM-DD HH:mm:ss"
            />
          </el-form-item>
        </el-form>
      </el-card>
    </el-col>
  </el-row>

  <template #footer>
    <el-button @click="revenueDialog = false">取消</el-button>
    <el-button type="primary" @click="submitRevenueConfirm">确定</el-button>
  </template>
</el-dialog>
```

#### 2. 收入确认逻辑

```javascript
data() {
  return {
    revenueDialog: false,
    revenueForm: {},
    revenueRules: {
      taxRate: [{ required: true, message: '请选择税率', trigger: 'change' }],
      confirmAmount: [{ required: true, message: '请输入确认金额', trigger: 'blur' }],
      revenueConfirmYear: [{ required: true, message: '请选择收入确认年度', trigger: 'change' }],
      revenueConfirmStatus: [{ required: true, message: '请选择收入确认状态', trigger: 'change' }]
    }
  }
},

computed: {
  // 合同不含税金额
  contractAmountNoTax() {
    if (!this.revenueForm.contractAmount || !this.revenueForm.taxRate) {
      return '0.00'
    }
    const amount = parseFloat(this.revenueForm.contractAmount)
    const rate = parseFloat(this.revenueForm.taxRate) / 100
    return (amount / (1 + rate)).toFixed(2)
  },

  // 税后金额
  afterTaxAmount() {
    if (!this.revenueForm.confirmAmount || !this.revenueForm.taxRate) {
      return '0.00'
    }
    const amount = parseFloat(this.revenueForm.confirmAmount)
    const rate = parseFloat(this.revenueForm.taxRate) / 100
    return (amount / (1 + rate)).toFixed(2)
  }
},

methods: {
  // 打开收入确认弹窗
  handleConfirmRevenue(row) {
    this.revenueDialog = true

    // 获取项目详情
    getProject(row.projectId).then(response => {
      this.revenueForm = { ...response.data }

      // 如果没有税率，默认设置为6%
      if (!this.revenueForm.taxRate) {
        this.revenueForm.taxRate = 6
      }
    })
  },

  // 税率变化
  handleTaxRateChange() {
    // 税率变化时，自动重新计算不含税金额和税后金额
    // 由于使用了计算属性，会自动更新
  },

  // 确认金额变化
  handleConfirmAmountChange() {
    // 确认金额变化时，自动重新计算税后金额
    // 由于使用了计算属性，会自动更新
  },

  // 提交收入确认
  submitRevenueConfirm() {
    this.$refs.revenueFormRef.validate(valid => {
      if (valid) {
        // 计算税后金额并保存
        this.revenueForm.afterTaxAmount = this.afterTaxAmount

        request({
          url: '/project/project/confirmRevenue',
          method: 'put',
          data: this.revenueForm
        }).then(() => {
          this.$modal.msgSuccess('收入确认成功')
          this.revenueDialog = false
          this.getList()
        })
      }
    })
  }
}
```

---

## 实施检查清单

### 后端

- [ ] Project.java 添加扩展字段
- [ ] ProjectMapper.xml 更新 resultMap
- [ ] ProjectMapper.xml 增强 selectProjectList 查询
- [ ] ProjectMapper.xml 添加 selectProjectSummary 查询
- [ ] ProjectMapper.java 添加 selectProjectSummary 方法
- [ ] IProjectService.java 添加 getProjectSummary 方法
- [ ] ProjectServiceImpl.java 实现 getProjectSummary 方法
- [ ] ProjectController.java 添加 getSummary 接口

### 前端

- [ ] 查询条件：项目经理下拉选择
- [ ] 查询条件：市场经理下拉选择
- [ ] 查询条件：项目部门树形选择
- [ ] 查询条件：二级区域级联选择
- [ ] 列表字段：添加所有必需列
- [ ] 列表字段：格式化显示
- [ ] 汇总行：实现汇总统计
- [ ] 操作按钮：查看详情
- [ ] 操作按钮：编辑
- [ ] 操作按钮：收入确认
- [ ] 操作按钮：附件管理
- [ ] 操作按钮：删除
- [ ] 操作按钮：打印立项申请单
- [ ] 收入确认弹窗：布局实现
- [ ] 收入确认弹窗：税率计算
- [ ] 收入确认弹窗：提交逻辑

---

## 注意事项

1. **字符集排序规则**：新建表使用 `utf8mb4_0900_ai_ci`，系统表使用 `utf8mb4_unicode_ci`，JOIN 时需要显式指定排序规则
2. **性能优化**：项目列表查询关联了多张表，建议添加适当的索引
3. **数据权限**：如需要数据权限控制，在 Service 方法上添加 `@DataScope` 注解
4. **前端字典**：确保所有字典类型（sys_xmfl、sys_xmzt、sys_yszt、sys_spzt、sys_htzt、sys_ndgl、region）已在字典管理中配置
5. **合同关联**：确保 pm_project_contract_rel 表中正确维护了项目和合同的关联关系

---

**文档版本**：v1.0
**创建日期**：2026-02-05
**最后更新**：2026-02-05
