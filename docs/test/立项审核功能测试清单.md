# 立项审核功能测试清单

## 测试环境准备

### 1. 执行菜单 SQL
```bash
# 连接 MySQL 数据库
mysql -u root -p ry-vue

# 执行菜单 SQL（只执行立项审核部分）
source /Users/kongli/ws-claude/PM/newpm/pm-sql/init/02_menu_data.sql
```

**预期结果：**
- 在 `sys_menu` 表中新增"立项审核"菜单及其按钮权限
- 菜单挂在"项目管理"根目录下，order_num=3

### 2. 分配菜单权限
1. 登录系统（admin/admin123）
2. 进入"系统管理" → "角色管理"
3. 选择测试角色，点击"修改"
4. 在菜单权限树中勾选"项目管理" → "立项审核"及其子权限
5. 保存

**预期结果：**
- 角色成功分配"立项审核"菜单权限
- 该角色用户登录后可以看到"立项审核"菜单

---

## 功能测试

### 3. 测试查询功能

**测试步骤：**
1. 登录系统
2. 点击"项目管理" → "立项审核"
3. 测试各个查询条件：
   - 项目名称（模糊查询）
   - 项目部门（树形选择）
   - 项目分类（字典选择）
   - 一级区域（字典选择）
   - 二级区域（联动选择，依赖一级区域）
   - 项目经理（下拉选择）
   - 市场经理（下拉选择）
   - 项目阶段（字典选择）
4. 点击"搜索"按钮
5. 点击"重置"按钮

**预期结果：**
- ✅ 列表正确显示待审核项目（approval_status='0'）
- ✅ 各查询条件正常工作
- ✅ 一级区域变化时，二级区域选项联动更新
- ✅ 分页功能正常
- ✅ 重置按钮清空所有查询条件

### 4. 测试审核功能

#### 4.1 审核通过
**测试步骤：**
1. 在列表中点击某个项目的"审核"按钮
2. 查看项目详情（7个折叠面板）
3. 审核意见留空或填写内容
4. 点击"通过"按钮
5. 确认提示框

**预期结果：**
- ✅ 对话框正确显示项目完整信息
- ✅ 7个折叠面板默认全部展开
- ✅ 审核通过成功
- ✅ 列表自动刷新，已审核项目消失
- ✅ 数据库中 `approval_status` 更新为 '1'
- ✅ `approval_time` 和 `approver_id` 正确记录

#### 4.2 审核拒绝（审核意见必填）
**测试步骤：**
1. 点击某个项目的"审核"按钮
2. 审核意见留空
3. 点击"拒绝"按钮

**预期结果：**
- ✅ 提示"拒绝审核时必须填写审核意见"
- ✅ 审核操作未执行

**测试步骤：**
1. 填写审核意见（如："项目预算不合理，请重新评估"）
2. 点击"拒绝"按钮
3. 确认提示框

**预期结果：**
- ✅ 审核拒绝成功
- ✅ 列表自动刷新，已审核项目消失
- ✅ 数据库中 `approval_status` 更新为 '2'
- ✅ `approval_reason` 正确保存

#### 4.3 取消审核
**测试步骤：**
1. 点击某个项目的"审核"按钮
2. 点击"取消"按钮

**预期结果：**
- ✅ 对话框关闭
- ✅ 数据未修改

### 5. 测试权限控制

#### 5.1 菜单权限
**测试步骤：**
1. 使用没有"立项审核"菜单权限的用户登录
2. 查看左侧菜单

**预期结果：**
- ✅ 看不到"立项审核"菜单

#### 5.2 按钮权限
**测试步骤：**
1. 使用有菜单权限但没有 `project:review:approve` 权限的用户登录
2. 进入"立项审核"页面

**预期结果：**
- ✅ 可以看到列表
- ✅ "审核"按钮不显示或禁用

#### 5.3 数据权限（@DataScope）
**测试步骤：**
1. 使用团队负责人（tdfzr）岗位用户登录
2. 进入"立项审核"页面

**预期结果：**
- ✅ 只能看到自己部门的待审核项目
- ✅ 其他部门的项目不显示

### 6. 测试邮件通知

**前提条件：**
需要在 `application.yml` 中配置邮件服务：
```yaml
spring:
  mail:
    host: smtp.example.com
    port: 465
    username: your-email@example.com
    password: your-password
    properties:
      mail:
        smtp:
          auth: true
          starttls:
            enable: true
            required: true
```

**测试步骤：**
1. 确保项目创建人有邮箱地址
2. 审核某个项目（通过或拒绝）
3. 检查项目创建人的邮箱

**预期结果：**
- ✅ 项目创建人收到审核通知邮件
- ✅ 邮件标题：【项目立项审核】项目名称 - 审核通过/拒绝
- ✅ 邮件内容包含：项目名称、项目编码、审核结果、审核意见
- ✅ 邮件发送失败不影响审核流程（异步发送）

**注意：** 当前实现中邮件功能仅记录日志，需要配置 Spring Mail 才能实际发送邮件。

---

## 边界测试

### 7. 异常情况测试

#### 7.1 无待审核项目
**测试步骤：**
1. 审核完所有项目
2. 刷新列表

**预期结果：**
- ✅ 显示空列表
- ✅ 提示"暂无数据"

#### 7.2 并发审核
**测试步骤：**
1. 两个用户同时打开同一个项目的审核对话框
2. 用户A先审核通过
3. 用户B再审核

**预期结果：**
- ✅ 用户B审核时，项目已不在待审核列表
- ✅ 或者后端返回错误提示

#### 7.3 网络异常
**测试步骤：**
1. 打开审核对话框
2. 断开网络
3. 点击"通过"按钮

**预期结果：**
- ✅ 显示网络错误提示
- ✅ 数据未修改

---

## 性能测试

### 8. 大数据量测试

**测试步骤：**
1. 插入1000条待审核项目数据
2. 测试列表加载速度
3. 测试查询响应时间
4. 测试分页性能

**预期结果：**
- ✅ 列表加载时间 < 2秒
- ✅ 查询响应时间 < 1秒
- ✅ 分页切换流畅

---

## 验收标准

- [ ] 后端编译通过，无错误
- [ ] 前端编译通过，无错误
- [ ] 服务启动成功，无错误日志
- [ ] 查询功能正常，支持所有查询条件
- [ ] 列表展示正确，字段完整
- [ ] 审核对话框显示项目完整信息
- [ ] 审核通过功能正常，状态更新正确
- [ ] 审核拒绝功能正常，必填审核意见
- [ ] 审核后列表自动刷新，已审核项目消失
- [ ] 邮件通知发送成功，内容正确（可选）
- [ ] 菜单权限控制生效
- [ ] 按钮权限控制生效
- [ ] 部门数据权限生效，只能看到自己部门的项目

---

## 测试报告模板

**测试日期：** ____________________

**测试人员：** ____________________

**测试环境：**
- 数据库：MySQL 8.x
- 后端：Java 17 + Spring Boot 3.5.8
- 前端：Vue 3.5 + TypeScript 5.6

**测试结果：**

| 测试项 | 测试结果 | 备注 |
|--------|---------|------|
| 查询功能 | ☐ 通过 ☐ 失败 | |
| 审核通过 | ☐ 通过 ☐ 失败 | |
| 审核拒绝 | ☐ 通过 ☐ 失败 | |
| 权限控制 | ☐ 通过 ☐ 失败 | |
| 邮件通知 | ☐ 通过 ☐ 失败 ☐ 未测试 | |

**发现的问题：**

1.
2.
3.

**总体评价：** ☐ 通过 ☐ 不通过

**签名：** ____________________
