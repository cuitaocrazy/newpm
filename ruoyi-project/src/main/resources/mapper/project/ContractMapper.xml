<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.project.mapper.ContractMapper">
    
    <resultMap type="Contract" id="ContractResult">
        <result property="contractId"    column="contract_id"    />
        <result property="contractCode"    column="contract_code"    />
        <result property="contractName"    column="contract_name"    />
        <result property="customerId"    column="customer_id"    />
        <result property="deptId"    column="dept_id"    />
        <result property="contractType"    column="contract_type"    />
        <result property="contractStatus"    column="contract_status"    />
        <result property="contractSignDate"    column="contract_sign_date"    />
        <result property="contractPeriod"    column="contract_period"    />
        <result property="contractAmount"    column="contract_amount"    />
        <result property="taxRate"    column="tax_rate"    />
        <result property="amountNoTax"    column="amount_no_tax"    />
        <result property="taxAmount"    column="tax_amount"    />
        <result property="confirmAmount"    column="confirm_amount"    />
        <result property="confirmYear"    column="confirm_year"    />
        <result property="freeMaintenancePeriod"    column="free_maintenance_period"    />
        <result property="delFlag"    column="del_flag"    />
        <result property="createBy"    column="create_by"    />
        <result property="createTime"    column="create_time"    />
        <result property="updateBy"    column="update_by"    />
        <result property="updateTime"    column="update_time"    />
        <result property="remark"    column="remark"    />
        <result property="reservedField1"    column="reserved_field1"    />
        <result property="reservedField2"    column="reserved_field2"    />
        <result property="reservedField3"    column="reserved_field3"    />
        <result property="reservedField4"    column="reserved_field4"    />
        <result property="reservedField5"    column="reserved_field5"    />
        <result property="deptName"    column="dept_name"    />
        <result property="customerName"    column="customer_name"    />
        <result property="contractTypeName"    column="contract_type_name"    />
        <result property="contractStatusName"    column="contract_status_name"    />
        <result property="createByName"    column="create_by_name"    />
        <result property="updateByName"    column="update_by_name"    />
    </resultMap>

    <resultMap type="Contract" id="ContractWithPaymentsResult" extends="ContractResult">
        <collection property="paymentList" ofType="Payment">
            <result property="paymentId" column="payment_id" />
            <result property="contractId" column="contract_id" />
            <result property="paymentMethodName" column="payment_method_name" />
            <result property="paymentAmount" column="payment_amount" />
            <result property="hasPenalty" column="has_penalty" />
            <result property="penaltyAmount" column="penalty_amount" />
            <result property="paymentStatus" column="payment_status" />
            <result property="expectedQuarter" column="expected_quarter" />
            <result property="actualQuarter" column="actual_quarter" />
            <result property="submitAcceptanceDate" column="submit_acceptance_date" />
            <result property="actualPaymentDate" column="actual_payment_date" />
            <result property="confirmYear" column="payment_confirm_year" />
            <result property="createBy" column="payment_create_by" />
            <result property="createTime" column="payment_create_time" />
            <result property="updateBy" column="payment_update_by" />
            <result property="updateTime" column="payment_update_time" />
            <result property="createByName" column="payment_create_by_name" />
            <result property="updateByName" column="payment_update_by_name" />
        </collection>
    </resultMap>

    <sql id="selectContractVo">
        select contract_id, contract_code, contract_name, customer_id, dept_id, contract_type, contract_status, contract_sign_date, contract_period, contract_amount, tax_rate, amount_no_tax, tax_amount, confirm_amount, confirm_year, free_maintenance_period, del_flag, create_by, create_time, update_by, update_time, remark, reserved_field1, reserved_field2, reserved_field3, reserved_field4, reserved_field5 from pm_contract
    </sql>

    <select id="selectContractList" parameterType="Contract" resultMap="ContractResult">
        select
            c.contract_id, c.contract_code, c.contract_name, c.customer_id, c.dept_id,
            c.contract_type, c.contract_status, c.contract_sign_date, c.contract_period,
            c.contract_amount, c.tax_rate, c.amount_no_tax, c.tax_amount,
            c.confirm_amount, c.confirm_year, c.free_maintenance_period,
            c.create_by, c.create_time, c.update_by, c.update_time, c.remark,
            d.dept_name as dept_name,
            cust.customer_simple_name as customer_name,
            dict1.dict_label as contract_type_name,
            dict2.dict_label as contract_status_name,
            u1.nick_name as create_by_name,
            u2.nick_name as update_by_name
        from pm_contract c
        left join sys_dept d on c.dept_id = d.dept_id
        left join pm_customer cust on c.customer_id = cust.customer_id
        left join sys_dict_data dict1 on c.contract_type COLLATE utf8mb4_unicode_ci = dict1.dict_value and dict1.dict_type = 'sys_htlx'
        left join sys_dict_data dict2 on c.contract_status COLLATE utf8mb4_unicode_ci = dict2.dict_value and dict2.dict_type = 'sys_htzt'
        left join sys_user u1 on c.create_by COLLATE utf8mb4_unicode_ci = u1.user_name
        left join sys_user u2 on c.update_by COLLATE utf8mb4_unicode_ci = u2.user_name
        <where>
            c.del_flag = '0'
            <if test="contractCode != null  and contractCode != ''"> and c.contract_code = #{contractCode}</if>
            <if test="contractName != null  and contractName != ''"> and c.contract_name = #{contractName}</if>
            <if test="customerId != null "> and c.customer_id = #{customerId}</if>
            <if test="deptId != null "> and c.dept_id = #{deptId}</if>
            <if test="contractType != null  and contractType != ''"> and c.contract_type = #{contractType}</if>
            <if test="contractStatus != null  and contractStatus != ''"> and c.contract_status = #{contractStatus}</if>
            <if test="confirmYear != null  and confirmYear != ''"> and c.confirm_year = #{confirmYear}</if>
        </where>
        order by c.create_time desc
    </select>

    <select id="selectContractByContractId" parameterType="Long" resultMap="ContractResult">
        select
            c.contract_id, c.contract_code, c.contract_name, c.customer_id, c.dept_id,
            c.contract_type, c.contract_status, c.contract_sign_date, c.contract_period,
            c.contract_amount, c.tax_rate, c.amount_no_tax, c.tax_amount,
            c.confirm_amount, c.confirm_year, c.free_maintenance_period,
            c.create_by, c.create_time, c.update_by, c.update_time, c.remark,
            d.dept_name as dept_name,
            cust.customer_simple_name as customer_name,
            dict1.dict_label as contract_type_name,
            dict2.dict_label as contract_status_name,
            u1.nick_name as create_by_name,
            u2.nick_name as update_by_name
        from pm_contract c
        left join sys_dept d on c.dept_id = d.dept_id
        left join pm_customer cust on c.customer_id = cust.customer_id
        left join sys_dict_data dict1 on c.contract_type COLLATE utf8mb4_unicode_ci = dict1.dict_value and dict1.dict_type = 'sys_htlx'
        left join sys_dict_data dict2 on c.contract_status COLLATE utf8mb4_unicode_ci = dict2.dict_value and dict2.dict_type = 'sys_htzt'
        left join sys_user u1 on c.create_by COLLATE utf8mb4_unicode_ci = u1.user_name
        left join sys_user u2 on c.update_by COLLATE utf8mb4_unicode_ci = u2.user_name
        where c.contract_id = #{contractId}
    </select>

    <select id="selectContractSummary" parameterType="Contract" resultType="map">
        select
            IFNULL(SUM(c.contract_amount), 0) as contractAmountSum,
            IFNULL(SUM(c.amount_no_tax), 0) as amountNoTaxSum
        from pm_contract c
        <where>
            c.del_flag = '0'
            <if test="contractCode != null  and contractCode != ''"> and c.contract_code = #{contractCode}</if>
            <if test="contractName != null  and contractName != ''"> and c.contract_name = #{contractName}</if>
            <if test="customerId != null "> and c.customer_id = #{customerId}</if>
            <if test="deptId != null "> and c.dept_id = #{deptId}</if>
            <if test="contractType != null  and contractType != ''"> and c.contract_type = #{contractType}</if>
            <if test="contractStatus != null  and contractStatus != ''"> and c.contract_status = #{contractStatus}</if>
            <if test="confirmYear != null  and confirmYear != ''"> and c.confirm_year = #{confirmYear}</if>
        </where>
    </select>

    <insert id="insertContract" parameterType="Contract" useGeneratedKeys="true" keyProperty="contractId">
        insert into pm_contract
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="contractCode != null">contract_code,</if>
            <if test="contractName != null and contractName != ''">contract_name,</if>
            <if test="customerId != null">customer_id,</if>
            <if test="deptId != null">dept_id,</if>
            <if test="contractType != null and contractType != ''">contract_type,</if>
            <if test="contractStatus != null">contract_status,</if>
            <if test="contractSignDate != null">contract_sign_date,</if>
            <if test="contractPeriod != null">contract_period,</if>
            <if test="contractAmount != null">contract_amount,</if>
            <if test="taxRate != null">tax_rate,</if>
            <if test="amountNoTax != null">amount_no_tax,</if>
            <if test="taxAmount != null">tax_amount,</if>
            <if test="confirmAmount != null">confirm_amount,</if>
            <if test="confirmYear != null">confirm_year,</if>
            <if test="freeMaintenancePeriod != null">free_maintenance_period,</if>
            <if test="delFlag != null">del_flag,</if>
            <if test="createBy != null">create_by,</if>
            <if test="createTime != null">create_time,</if>
            <if test="updateBy != null">update_by,</if>
            <if test="updateTime != null">update_time,</if>
            <if test="remark != null">remark,</if>
            <if test="reservedField1 != null">reserved_field1,</if>
            <if test="reservedField2 != null">reserved_field2,</if>
            <if test="reservedField3 != null">reserved_field3,</if>
            <if test="reservedField4 != null">reserved_field4,</if>
            <if test="reservedField5 != null">reserved_field5,</if>
         </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="contractCode != null">#{contractCode},</if>
            <if test="contractName != null and contractName != ''">#{contractName},</if>
            <if test="customerId != null">#{customerId},</if>
            <if test="deptId != null">#{deptId},</if>
            <if test="contractType != null and contractType != ''">#{contractType},</if>
            <if test="contractStatus != null">#{contractStatus},</if>
            <if test="contractSignDate != null">#{contractSignDate},</if>
            <if test="contractPeriod != null">#{contractPeriod},</if>
            <if test="contractAmount != null">#{contractAmount},</if>
            <if test="taxRate != null">#{taxRate},</if>
            <if test="amountNoTax != null">#{amountNoTax},</if>
            <if test="taxAmount != null">#{taxAmount},</if>
            <if test="confirmAmount != null">#{confirmAmount},</if>
            <if test="confirmYear != null">#{confirmYear},</if>
            <if test="freeMaintenancePeriod != null">#{freeMaintenancePeriod},</if>
            <if test="delFlag != null">#{delFlag},</if>
            <if test="createBy != null">#{createBy},</if>
            <if test="createTime != null">#{createTime},</if>
            <if test="updateBy != null">#{updateBy},</if>
            <if test="updateTime != null">#{updateTime},</if>
            <if test="remark != null">#{remark},</if>
            <if test="reservedField1 != null">#{reservedField1},</if>
            <if test="reservedField2 != null">#{reservedField2},</if>
            <if test="reservedField3 != null">#{reservedField3},</if>
            <if test="reservedField4 != null">#{reservedField4},</if>
            <if test="reservedField5 != null">#{reservedField5},</if>
         </trim>
    </insert>

    <update id="updateContract" parameterType="Contract">
        update pm_contract
        <trim prefix="SET" suffixOverrides=",">
            <if test="contractCode != null">contract_code = #{contractCode},</if>
            <if test="contractName != null and contractName != ''">contract_name = #{contractName},</if>
            <if test="customerId != null">customer_id = #{customerId},</if>
            <if test="deptId != null">dept_id = #{deptId},</if>
            <if test="contractType != null and contractType != ''">contract_type = #{contractType},</if>
            <if test="contractStatus != null">contract_status = #{contractStatus},</if>
            <if test="contractSignDate != null">contract_sign_date = #{contractSignDate},</if>
            <if test="contractPeriod != null">contract_period = #{contractPeriod},</if>
            <if test="contractAmount != null">contract_amount = #{contractAmount},</if>
            <if test="taxRate != null">tax_rate = #{taxRate},</if>
            <if test="amountNoTax != null">amount_no_tax = #{amountNoTax},</if>
            <if test="taxAmount != null">tax_amount = #{taxAmount},</if>
            <if test="confirmAmount != null">confirm_amount = #{confirmAmount},</if>
            <if test="confirmYear != null">confirm_year = #{confirmYear},</if>
            <if test="freeMaintenancePeriod != null">free_maintenance_period = #{freeMaintenancePeriod},</if>
            <if test="delFlag != null">del_flag = #{delFlag},</if>
            <if test="createBy != null">create_by = #{createBy},</if>
            <if test="createTime != null">create_time = #{createTime},</if>
            <if test="updateBy != null">update_by = #{updateBy},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
            <if test="remark != null">remark = #{remark},</if>
            <if test="reservedField1 != null">reserved_field1 = #{reservedField1},</if>
            <if test="reservedField2 != null">reserved_field2 = #{reservedField2},</if>
            <if test="reservedField3 != null">reserved_field3 = #{reservedField3},</if>
            <if test="reservedField4 != null">reserved_field4 = #{reservedField4},</if>
            <if test="reservedField5 != null">reserved_field5 = #{reservedField5},</if>
        </trim>
        where contract_id = #{contractId}
    </update>

    <delete id="deleteContractByContractId" parameterType="Long">
        delete from pm_contract where contract_id = #{contractId}
    </delete>

    <delete id="deleteContractByContractIds" parameterType="String">
        delete from pm_contract where contract_id in
        <foreach item="contractId" collection="array" open="(" separator="," close=")">
            #{contractId}
        </foreach>
    </delete>

    <select id="searchContracts" parameterType="String" resultMap="ContractResult">
        select contract_id, contract_code, contract_name, contract_status, contract_amount
        from pm_contract
        where del_flag = '0'
        <if test="keyword != null and keyword != ''">
            and (contract_name like concat('%', #{keyword}, '%')
            or contract_code like concat('%', #{keyword}, '%'))
        </if>
        order by create_time desc
        limit 100
    </select>

    <select id="selectContractWithPaymentsList" parameterType="Contract" resultMap="ContractWithPaymentsResult">
        select
            c.contract_id, c.contract_code, c.contract_name, c.customer_id, c.dept_id,
            c.contract_type, c.contract_status, c.contract_sign_date, c.contract_period,
            c.contract_amount, c.tax_rate, c.amount_no_tax, c.tax_amount,
            c.confirm_amount, c.confirm_year, c.free_maintenance_period,
            c.create_by, c.create_time, c.update_by, c.update_time, c.remark,
            d.dept_name as dept_name,
            cust.customer_simple_name as customer_name,
            dict1.dict_label as contract_type_name,
            dict2.dict_label as contract_status_name,
            u1.nick_name as create_by_name,
            u2.nick_name as update_by_name,
            p.payment_id,
            p.payment_method_name,
            p.payment_amount,
            p.has_penalty,
            p.penalty_amount,
            p.payment_status,
            p.expected_quarter,
            p.actual_quarter,
            p.submit_acceptance_date,
            p.actual_payment_date,
            p.confirm_year as payment_confirm_year,
            p.create_by as payment_create_by,
            p.create_time as payment_create_time,
            p.update_by as payment_update_by,
            p.update_time as payment_update_time,
            u3.nick_name as payment_create_by_name,
            u4.nick_name as payment_update_by_name
        from pm_contract c
        left join sys_dept d on c.dept_id = d.dept_id
        left join pm_customer cust on c.customer_id = cust.customer_id
        left join sys_dict_data dict1 on c.contract_type COLLATE utf8mb4_unicode_ci = dict1.dict_value and dict1.dict_type = 'sys_htlx'
        left join sys_dict_data dict2 on c.contract_status COLLATE utf8mb4_unicode_ci = dict2.dict_value and dict2.dict_type = 'sys_htzt'
        left join sys_user u1 on c.create_by COLLATE utf8mb4_unicode_ci = u1.user_name
        left join sys_user u2 on c.update_by COLLATE utf8mb4_unicode_ci = u2.user_name
        left join pm_payment p on c.contract_id = p.contract_id and p.del_flag = '0'
        left join sys_user u3 on p.create_by COLLATE utf8mb4_unicode_ci = u3.user_name
        left join sys_user u4 on p.update_by COLLATE utf8mb4_unicode_ci = u4.user_name
        <where>
            c.del_flag = '0'
            <if test="contractCode != null and contractCode != ''"> and c.contract_code like concat('%', #{contractCode}, '%')</if>
            <if test="contractName != null and contractName != ''"> and c.contract_name like concat('%', #{contractName}, '%')</if>
            <if test="customerId != null"> and c.customer_id = #{customerId}</if>
            <if test="customerName != null and customerName != ''"> and cust.customer_simple_name like concat('%', #{customerName}, '%')</if>
            <if test="deptId != null"> and c.dept_id = #{deptId}</if>
            <if test="contractType != null and contractType != ''"> and c.contract_type = #{contractType}</if>
            <if test="contractStatus != null and contractStatus != ''"> and c.contract_status = #{contractStatus}</if>
            <if test="confirmYear != null and confirmYear != ''"> and c.confirm_year = #{confirmYear}</if>
            <if test="params.paymentMethodName != null and params.paymentMethodName != ''"> and p.payment_method_name like concat('%', #{params.paymentMethodName}, '%')</if>
            <if test="params.hasPenalty != null and params.hasPenalty != ''"> and p.has_penalty = #{params.hasPenalty}</if>
            <if test="params.paymentStatus != null and params.paymentStatus != ''"> and p.payment_status = #{params.paymentStatus}</if>
            <if test="params.expectedQuarter != null and params.expectedQuarter != ''"> and p.expected_quarter = #{params.expectedQuarter}</if>
            <if test="params.actualQuarter != null and params.actualQuarter != ''"> and p.actual_quarter = #{params.actualQuarter}</if>
            <if test="params.paymentConfirmYear != null and params.paymentConfirmYear != ''"> and p.confirm_year = #{params.paymentConfirmYear}</if>
            <if test="params.actualPaymentDateStart != null and params.actualPaymentDateStart != ''"> and p.actual_payment_date &gt;= #{params.actualPaymentDateStart}</if>
            <if test="params.actualPaymentDateEnd != null and params.actualPaymentDateEnd != ''"> and p.actual_payment_date &lt;= #{params.actualPaymentDateEnd}</if>
        </where>
        order by c.create_time desc, p.create_time asc
    </select>

    <!-- 统计付款里程碑总金额 -->
    <select id="sumPaymentAmount" parameterType="Contract" resultType="java.math.BigDecimal">
        select COALESCE(sum(p.payment_amount), 0)
        from pm_contract c
        left join pm_customer cust on c.customer_id = cust.customer_id
        left join pm_payment p on c.contract_id = p.contract_id and p.del_flag = '0'
        <where>
            c.del_flag = '0'
            <if test="contractCode != null and contractCode != ''"> and c.contract_code like concat('%', #{contractCode}, '%')</if>
            <if test="contractName != null and contractName != ''"> and c.contract_name like concat('%', #{contractName}, '%')</if>
            <if test="customerId != null"> and c.customer_id = #{customerId}</if>
            <if test="customerName != null and customerName != ''"> and cust.customer_simple_name like concat('%', #{customerName}, '%')</if>
            <if test="deptId != null"> and c.dept_id = #{deptId}</if>
            <if test="contractType != null and contractType != ''"> and c.contract_type = #{contractType}</if>
            <if test="contractStatus != null and contractStatus != ''"> and c.contract_status = #{contractStatus}</if>
            <if test="confirmYear != null and confirmYear != ''"> and c.confirm_year = #{confirmYear}</if>
            <if test="params.paymentMethodName != null and params.paymentMethodName != ''"> and p.payment_method_name like concat('%', #{params.paymentMethodName}, '%')</if>
            <if test="params.hasPenalty != null and params.hasPenalty != ''"> and p.has_penalty = #{params.hasPenalty}</if>
            <if test="params.paymentStatus != null and params.paymentStatus != ''"> and p.payment_status = #{params.paymentStatus}</if>
            <if test="params.expectedQuarter != null and params.expectedQuarter != ''"> and p.expected_quarter = #{params.expectedQuarter}</if>
            <if test="params.actualQuarter != null and params.actualQuarter != ''"> and p.actual_quarter = #{params.actualQuarter}</if>
            <if test="params.paymentConfirmYear != null and params.paymentConfirmYear != ''"> and p.confirm_year = #{params.paymentConfirmYear}</if>
            <if test="params.actualPaymentDateStart != null and params.actualPaymentDateStart != ''"> and p.actual_payment_date &gt;= #{params.actualPaymentDateStart}</if>
            <if test="params.actualPaymentDateEnd != null and params.actualPaymentDateEnd != ''"> and p.actual_payment_date &lt;= #{params.actualPaymentDateEnd}</if>
        </where>
    </select>
</mapper>