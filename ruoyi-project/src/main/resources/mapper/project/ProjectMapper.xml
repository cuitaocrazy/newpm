<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.project.mapper.ProjectMapper">
    
    <resultMap type="Project" id="ProjectResult">
        <result property="projectId"    column="project_id"    />
        <result property="projectCode"    column="project_code"    />
        <result property="projectName"    column="project_name"    />
        <result property="projectFullName"    column="project_full_name"    />
        <result property="industry"    column="industry"    />
        <result property="region"    column="region"    />
        <result property="shortName"    column="short_name"    />
        <result property="establishedYear"    column="established_year"    />
        <result property="projectCategory"    column="project_category"    />
        <result property="projectDept"    column="project_dept"    />
        <result property="projectStatus"    column="project_status"    />
        <result property="acceptanceStatus"    column="acceptance_status"    />
        <result property="estimatedWorkload"    column="estimated_workload"    />
        <result property="actualWorkload"    column="actual_workload"    />
        <result property="projectAddress"    column="project_address"    />
        <result property="projectPlan"    column="project_plan"    />
        <result property="projectDescription"    column="project_description"    />
        <result property="projectManagerId"    column="project_manager_id"    />
        <result property="marketManagerId"    column="market_manager_id"    />
        <result property="participants"    column="participants"    />
        <result property="salesManagerId"    column="sales_manager_id"    />
        <result property="salesContact"    column="sales_contact"    />
        <result property="teamLeaderId"    column="team_leader_id"    />
        <result property="customerId"    column="customer_id"    />
        <result property="customerContactId"    column="customer_contact_id"    />
        <result property="merchantContact"    column="merchant_contact"    />
        <result property="merchantPhone"    column="merchant_phone"    />
        <result property="startDate"    column="start_date"    />
        <result property="endDate"    column="end_date"    />
        <result property="productionDate"    column="production_date"    />
        <result property="acceptanceDate"    column="acceptance_date"    />
        <result property="projectBudget"    column="project_budget"    />
        <result property="projectCost"    column="project_cost"    />
        <result property="expenseBudget"    column="expense_budget"    />
        <result property="costBudget"    column="cost_budget"    />
        <result property="laborCost"    column="labor_cost"    />
        <result property="purchaseCost"    column="purchase_cost"    />
        <result property="approvalStatus"    column="approval_status"    />
        <result property="approvalReason"    column="approval_reason"    />
        <result property="industryCode"    column="industry_code"    />
        <result property="regionCode"    column="region_code"    />
        <result property="approvalTime"    column="approval_time"    />
        <result property="approverId"    column="approver_id"    />
        <result property="remark"    column="remark"    />
        <result property="taxRate"    column="tax_rate"    />
        <result property="confirmUserId"    column="confirm_user_id"    />
        <result property="confirmTime"    column="confirm_time"    />
        <result property="reservedField1"    column="reserved_field1"    />
        <result property="reservedField2"    column="reserved_field2"    />
        <result property="reservedField3"    column="reserved_field3"    />
        <result property="reservedField4"    column="reserved_field4"    />
        <result property="reservedField5"    column="reserved_field5"    />
        <result property="delFlag"    column="del_flag"    />
        <result property="createBy"    column="create_by"    />
        <result property="createTime"    column="create_time"    />
        <result property="updateBy"    column="update_by"    />
        <result property="updateTime"    column="update_time"    />
        <result property="revenueConfirmStatus"    column="revenue_confirm_status"    />
        <result property="revenueConfirmYear"    column="revenue_confirm_year"    />
        <result property="confirmAmount"    column="confirm_amount"    />
        <result property="afterTaxAmount"    column="after_tax_amount"    />
        <result property="companyRevenueConfirmedByName"    column="company_revenue_confirmed_by_name"    />
        <result property="contractAmount"    column="contract_amount"    />
        <result property="contractStatus"    column="contract_status"    />
        <result property="projectManagerName"    column="project_manager_name"    />
        <result property="marketManagerName"    column="market_manager_name"    />
        <result property="participantsNames"    column="participants_names"    />
        <result property="deptName"    column="dept_name"    />
    </resultMap>

    <resultMap id="ProjectProjectApprovalResult" type="Project" extends="ProjectResult">
        <collection property="projectApprovalList" ofType="ProjectApproval" column="project_id" select="selectProjectApprovalList" />
    </resultMap>

    <resultMap type="ProjectApproval" id="ProjectApprovalResult">
        <result property="approvalId"    column="approval_id"    />
        <result property="projectId"    column="project_id"    />
        <result property="approvalStatus"    column="approval_status"    />
        <result property="approvalReason"    column="approval_reason"    />
        <result property="approverId"    column="approver_id"    />
        <result property="approvalTime"    column="approval_time"    />
        <result property="delFlag"    column="del_flag"    />
        <result property="createBy"    column="create_by"    />
        <result property="createTime"    column="create_time"    />
        <result property="updateBy"    column="update_by"    />
        <result property="updateTime"    column="update_time"    />
        <result property="remark"    column="remark"    />
    </resultMap>

    <sql id="selectProjectVo">
        select project_id, project_code, project_name, project_full_name, industry, region, short_name, established_year, project_category, project_dept, project_status, acceptance_status, estimated_workload, actual_workload, project_address, project_plan, project_description, project_manager_id, market_manager_id, participants, sales_manager_id, sales_contact, team_leader_id, customer_id, customer_contact_id, merchant_contact, merchant_phone, start_date, end_date, production_date, acceptance_date, project_budget, project_cost, expense_budget, cost_budget, labor_cost, purchase_cost, approval_status, approval_reason, industry_code, region_code, approval_time, approver_id, remark, tax_rate, confirm_user_id, confirm_time, reserved_field1, reserved_field2, reserved_field3, reserved_field4, reserved_field5, del_flag, create_by, create_time, update_by, update_time, revenue_confirm_status, revenue_confirm_year, confirm_amount, after_tax_amount, company_revenue_confirmed_by_name from pm_project
    </sql>

    <select id="selectProjectList" parameterType="Project" resultMap="ProjectResult">
        SELECT
            p.project_id, p.project_code, p.project_name, p.project_full_name, p.industry, p.region,
            p.short_name, p.established_year, p.project_category, p.project_dept, p.project_status,
            p.acceptance_status, p.estimated_workload, p.actual_workload, p.project_address, p.project_plan,
            p.project_description, p.project_manager_id, p.market_manager_id, p.participants, p.sales_manager_id,
            p.sales_contact, p.team_leader_id, p.customer_id, p.customer_contact_id, p.merchant_contact,
            p.merchant_phone, p.start_date, p.end_date, p.production_date, p.acceptance_date, p.project_budget,
            p.project_cost, p.expense_budget, p.cost_budget, p.labor_cost, p.purchase_cost, p.approval_status,
            p.approval_reason, p.industry_code, p.region_code, p.approval_time, p.approver_id, p.remark,
            p.tax_rate, p.confirm_user_id, p.confirm_time, p.reserved_field1, p.reserved_field2, p.reserved_field3,
            p.reserved_field4, p.reserved_field5, p.del_flag, p.create_by, p.create_time, p.update_by, p.update_time,
            p.revenue_confirm_status, p.revenue_confirm_year, p.confirm_amount, p.after_tax_amount,
            p.company_revenue_confirmed_by_name,
            c.contract_amount,
            c.contract_status,
            pm.nick_name AS project_manager_name,
            mm.nick_name AS market_manager_name,
            d.dept_name
        FROM pm_project p
        LEFT JOIN pm_project_contract_rel pcr ON p.project_id = pcr.project_id AND pcr.del_flag = '0'
        LEFT JOIN pm_contract c ON pcr.contract_id = c.contract_id
        LEFT JOIN sys_user pm ON p.project_manager_id = pm.user_id
        LEFT JOIN sys_user mm ON p.market_manager_id = mm.user_id
        LEFT JOIN sys_dept d ON p.project_dept = CAST(d.dept_id AS CHAR) COLLATE utf8mb4_unicode_ci
        <where>
            <if test="projectName != null  and projectName != ''"> and p.project_name like concat('%', #{projectName}, '%')</if>
            <if test="region != null  and region != ''"> and p.region = #{region}</if>
            <if test="establishedYear != null "> and p.established_year = #{establishedYear}</if>
            <if test="projectCategory != null  and projectCategory != ''"> and p.project_category = #{projectCategory}</if>
            <if test="projectDept != null  and projectDept != ''"> and p.project_dept = #{projectDept}</if>
            <if test="projectStatus != null  and projectStatus != ''"> and p.project_status = #{projectStatus}</if>
            <if test="acceptanceStatus != null  and acceptanceStatus != ''"> and p.acceptance_status = #{acceptanceStatus}</if>
            <if test="projectManagerId != null "> and p.project_manager_id = #{projectManagerId}</if>
            <if test="marketManagerId != null "> and p.market_manager_id = #{marketManagerId}</if>
            <if test="approvalStatus != null  and approvalStatus != ''"> and p.approval_status = #{approvalStatus}</if>
            <if test="regionCode != null  and regionCode != ''"> and p.region_code = #{regionCode}</if>
            <if test="revenueConfirmStatus != null  and revenueConfirmStatus != ''"> and p.revenue_confirm_status = #{revenueConfirmStatus}</if>
            <if test="revenueConfirmYear != null  and revenueConfirmYear != ''"> and p.revenue_confirm_year = #{revenueConfirmYear}</if>
        </where>
    </select>
    
    <select id="selectProjectByProjectId" parameterType="Long" resultMap="ProjectProjectApprovalResult">
        select project_id, project_code, project_name, project_full_name, industry, region, short_name, established_year, project_category, project_dept, project_status, acceptance_status, estimated_workload, actual_workload, project_address, project_plan, project_description, project_manager_id, market_manager_id, participants, sales_manager_id, sales_contact, team_leader_id, customer_id, customer_contact_id, merchant_contact, merchant_phone, start_date, end_date, production_date, acceptance_date, project_budget, project_cost, expense_budget, cost_budget, labor_cost, purchase_cost, approval_status, approval_reason, industry_code, region_code, approval_time, approver_id, remark, tax_rate, confirm_user_id, confirm_time, reserved_field1, reserved_field2, reserved_field3, reserved_field4, reserved_field5, del_flag, create_by, create_time, update_by, update_time, revenue_confirm_status, revenue_confirm_year, confirm_amount, after_tax_amount, company_revenue_confirmed_by_name
        from pm_project
        where project_id = #{projectId}
    </select>

    <select id="selectProjectApprovalList" resultMap="ProjectApprovalResult">
        select approval_id, project_id, approval_status, approval_reason, approver_id, approval_time, del_flag, create_by, create_time, update_by, update_time, remark
        from pm_project_approval
        where project_id = #{project_id}
    </select>

    <insert id="insertProject" parameterType="Project" useGeneratedKeys="true" keyProperty="projectId">
        insert into pm_project
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="projectCode != null and projectCode != ''">project_code,</if>
            <if test="projectName != null and projectName != ''">project_name,</if>
            <if test="projectFullName != null">project_full_name,</if>
            <if test="industry != null and industry != ''">industry,</if>
            <if test="region != null and region != ''">region,</if>
            <if test="shortName != null">short_name,</if>
            <if test="establishedYear != null">established_year,</if>
            <if test="projectCategory != null and projectCategory != ''">project_category,</if>
            <if test="projectDept != null and projectDept != ''">project_dept,</if>
            <if test="projectStatus != null and projectStatus != ''">project_status,</if>
            <if test="acceptanceStatus != null and acceptanceStatus != ''">acceptance_status,</if>
            <if test="estimatedWorkload != null">estimated_workload,</if>
            <if test="actualWorkload != null">actual_workload,</if>
            <if test="projectAddress != null and projectAddress != ''">project_address,</if>
            <if test="projectPlan != null and projectPlan != ''">project_plan,</if>
            <if test="projectDescription != null and projectDescription != ''">project_description,</if>
            <if test="projectManagerId != null">project_manager_id,</if>
            <if test="marketManagerId != null">market_manager_id,</if>
            <if test="participants != null and participants != ''">participants,</if>
            <if test="salesManagerId != null">sales_manager_id,</if>
            <if test="salesContact != null and salesContact != ''">sales_contact,</if>
            <if test="teamLeaderId != null">team_leader_id,</if>
            <if test="customerId != null">customer_id,</if>
            <if test="customerContactId != null">customer_contact_id,</if>
            <if test="merchantContact != null">merchant_contact,</if>
            <if test="merchantPhone != null">merchant_phone,</if>
            <if test="startDate != null">start_date,</if>
            <if test="endDate != null">end_date,</if>
            <if test="productionDate != null">production_date,</if>
            <if test="acceptanceDate != null">acceptance_date,</if>
            <if test="projectBudget != null">project_budget,</if>
            <if test="projectCost != null">project_cost,</if>
            <if test="expenseBudget != null">expense_budget,</if>
            <if test="costBudget != null">cost_budget,</if>
            <if test="laborCost != null">labor_cost,</if>
            <if test="purchaseCost != null">purchase_cost,</if>
            <if test="approvalStatus != null">approval_status,</if>
            <if test="approvalReason != null">approval_reason,</if>
            <if test="industryCode != null">industry_code,</if>
            <if test="regionCode != null">region_code,</if>
            <if test="approvalTime != null">approval_time,</if>
            <if test="approverId != null">approver_id,</if>
            <if test="remark != null">remark,</if>
            <if test="taxRate != null">tax_rate,</if>
            <if test="confirmUserId != null">confirm_user_id,</if>
            <if test="confirmTime != null">confirm_time,</if>
            <if test="reservedField1 != null">reserved_field1,</if>
            <if test="reservedField2 != null">reserved_field2,</if>
            <if test="reservedField3 != null">reserved_field3,</if>
            <if test="reservedField4 != null">reserved_field4,</if>
            <if test="reservedField5 != null">reserved_field5,</if>
            <if test="delFlag != null">del_flag,</if>
            <if test="createBy != null">create_by,</if>
            <if test="createTime != null">create_time,</if>
            <if test="updateBy != null">update_by,</if>
            <if test="updateTime != null">update_time,</if>
            <if test="revenueConfirmStatus != null">revenue_confirm_status,</if>
            <if test="revenueConfirmYear != null">revenue_confirm_year,</if>
            <if test="confirmAmount != null">confirm_amount,</if>
            <if test="afterTaxAmount != null">after_tax_amount,</if>
            <if test="companyRevenueConfirmedByName != null">company_revenue_confirmed_by_name,</if>
         </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="projectCode != null and projectCode != ''">#{projectCode},</if>
            <if test="projectName != null and projectName != ''">#{projectName},</if>
            <if test="projectFullName != null">#{projectFullName},</if>
            <if test="industry != null and industry != ''">#{industry},</if>
            <if test="region != null and region != ''">#{region},</if>
            <if test="shortName != null">#{shortName},</if>
            <if test="establishedYear != null">#{establishedYear},</if>
            <if test="projectCategory != null and projectCategory != ''">#{projectCategory},</if>
            <if test="projectDept != null and projectDept != ''">#{projectDept},</if>
            <if test="projectStatus != null and projectStatus != ''">#{projectStatus},</if>
            <if test="acceptanceStatus != null and acceptanceStatus != ''">#{acceptanceStatus},</if>
            <if test="estimatedWorkload != null">#{estimatedWorkload},</if>
            <if test="actualWorkload != null">#{actualWorkload},</if>
            <if test="projectAddress != null and projectAddress != ''">#{projectAddress},</if>
            <if test="projectPlan != null and projectPlan != ''">#{projectPlan},</if>
            <if test="projectDescription != null and projectDescription != ''">#{projectDescription},</if>
            <if test="projectManagerId != null">#{projectManagerId},</if>
            <if test="marketManagerId != null">#{marketManagerId},</if>
            <if test="participants != null and participants != ''">#{participants},</if>
            <if test="salesManagerId != null">#{salesManagerId},</if>
            <if test="salesContact != null and salesContact != ''">#{salesContact},</if>
            <if test="teamLeaderId != null">#{teamLeaderId},</if>
            <if test="customerId != null">#{customerId},</if>
            <if test="customerContactId != null">#{customerContactId},</if>
            <if test="merchantContact != null">#{merchantContact},</if>
            <if test="merchantPhone != null">#{merchantPhone},</if>
            <if test="startDate != null">#{startDate},</if>
            <if test="endDate != null">#{endDate},</if>
            <if test="productionDate != null">#{productionDate},</if>
            <if test="acceptanceDate != null">#{acceptanceDate},</if>
            <if test="projectBudget != null">#{projectBudget},</if>
            <if test="projectCost != null">#{projectCost},</if>
            <if test="expenseBudget != null">#{expenseBudget},</if>
            <if test="costBudget != null">#{costBudget},</if>
            <if test="laborCost != null">#{laborCost},</if>
            <if test="purchaseCost != null">#{purchaseCost},</if>
            <if test="approvalStatus != null">#{approvalStatus},</if>
            <if test="approvalReason != null">#{approvalReason},</if>
            <if test="industryCode != null">#{industryCode},</if>
            <if test="regionCode != null">#{regionCode},</if>
            <if test="approvalTime != null">#{approvalTime},</if>
            <if test="approverId != null">#{approverId},</if>
            <if test="remark != null">#{remark},</if>
            <if test="taxRate != null">#{taxRate},</if>
            <if test="confirmUserId != null">#{confirmUserId},</if>
            <if test="confirmTime != null">#{confirmTime},</if>
            <if test="reservedField1 != null">#{reservedField1},</if>
            <if test="reservedField2 != null">#{reservedField2},</if>
            <if test="reservedField3 != null">#{reservedField3},</if>
            <if test="reservedField4 != null">#{reservedField4},</if>
            <if test="reservedField5 != null">#{reservedField5},</if>
            <if test="delFlag != null">#{delFlag},</if>
            <if test="createBy != null">#{createBy},</if>
            <if test="createTime != null">#{createTime},</if>
            <if test="updateBy != null">#{updateBy},</if>
            <if test="updateTime != null">#{updateTime},</if>
            <if test="revenueConfirmStatus != null">#{revenueConfirmStatus},</if>
            <if test="revenueConfirmYear != null">#{revenueConfirmYear},</if>
            <if test="confirmAmount != null">#{confirmAmount},</if>
            <if test="afterTaxAmount != null">#{afterTaxAmount},</if>
            <if test="companyRevenueConfirmedByName != null">#{companyRevenueConfirmedByName},</if>
         </trim>
    </insert>

    <update id="updateProject" parameterType="Project">
        update pm_project
        <trim prefix="SET" suffixOverrides=",">
            <if test="projectCode != null and projectCode != ''">project_code = #{projectCode},</if>
            <if test="projectName != null and projectName != ''">project_name = #{projectName},</if>
            <if test="projectFullName != null">project_full_name = #{projectFullName},</if>
            <if test="industry != null and industry != ''">industry = #{industry},</if>
            <if test="region != null and region != ''">region = #{region},</if>
            <if test="shortName != null">short_name = #{shortName},</if>
            <if test="establishedYear != null">established_year = #{establishedYear},</if>
            <if test="projectCategory != null and projectCategory != ''">project_category = #{projectCategory},</if>
            <if test="projectDept != null and projectDept != ''">project_dept = #{projectDept},</if>
            <if test="projectStatus != null and projectStatus != ''">project_status = #{projectStatus},</if>
            <if test="acceptanceStatus != null and acceptanceStatus != ''">acceptance_status = #{acceptanceStatus},</if>
            <if test="estimatedWorkload != null">estimated_workload = #{estimatedWorkload},</if>
            <if test="actualWorkload != null">actual_workload = #{actualWorkload},</if>
            <if test="projectAddress != null and projectAddress != ''">project_address = #{projectAddress},</if>
            <if test="projectPlan != null and projectPlan != ''">project_plan = #{projectPlan},</if>
            <if test="projectDescription != null and projectDescription != ''">project_description = #{projectDescription},</if>
            <if test="projectManagerId != null">project_manager_id = #{projectManagerId},</if>
            <if test="marketManagerId != null">market_manager_id = #{marketManagerId},</if>
            <if test="participants != null and participants != ''">participants = #{participants},</if>
            <if test="salesManagerId != null">sales_manager_id = #{salesManagerId},</if>
            <if test="salesContact != null and salesContact != ''">sales_contact = #{salesContact},</if>
            <if test="teamLeaderId != null">team_leader_id = #{teamLeaderId},</if>
            <if test="customerId != null">customer_id = #{customerId},</if>
            <if test="customerContactId != null">customer_contact_id = #{customerContactId},</if>
            <if test="merchantContact != null">merchant_contact = #{merchantContact},</if>
            <if test="merchantPhone != null">merchant_phone = #{merchantPhone},</if>
            <if test="startDate != null">start_date = #{startDate},</if>
            <if test="endDate != null">end_date = #{endDate},</if>
            <if test="productionDate != null">production_date = #{productionDate},</if>
            <if test="acceptanceDate != null">acceptance_date = #{acceptanceDate},</if>
            <if test="projectBudget != null">project_budget = #{projectBudget},</if>
            <if test="projectCost != null">project_cost = #{projectCost},</if>
            <if test="expenseBudget != null">expense_budget = #{expenseBudget},</if>
            <if test="costBudget != null">cost_budget = #{costBudget},</if>
            <if test="laborCost != null">labor_cost = #{laborCost},</if>
            <if test="purchaseCost != null">purchase_cost = #{purchaseCost},</if>
            <if test="approvalStatus != null">approval_status = #{approvalStatus},</if>
            <if test="approvalReason != null">approval_reason = #{approvalReason},</if>
            <if test="industryCode != null">industry_code = #{industryCode},</if>
            <if test="regionCode != null">region_code = #{regionCode},</if>
            <if test="approvalTime != null">approval_time = #{approvalTime},</if>
            <if test="approverId != null">approver_id = #{approverId},</if>
            <if test="remark != null">remark = #{remark},</if>
            <if test="taxRate != null">tax_rate = #{taxRate},</if>
            <if test="confirmUserId != null">confirm_user_id = #{confirmUserId},</if>
            <if test="confirmTime != null">confirm_time = #{confirmTime},</if>
            <if test="reservedField1 != null">reserved_field1 = #{reservedField1},</if>
            <if test="reservedField2 != null">reserved_field2 = #{reservedField2},</if>
            <if test="reservedField3 != null">reserved_field3 = #{reservedField3},</if>
            <if test="reservedField4 != null">reserved_field4 = #{reservedField4},</if>
            <if test="reservedField5 != null">reserved_field5 = #{reservedField5},</if>
            <if test="delFlag != null">del_flag = #{delFlag},</if>
            <if test="createBy != null">create_by = #{createBy},</if>
            <if test="createTime != null">create_time = #{createTime},</if>
            <if test="updateBy != null">update_by = #{updateBy},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
            <if test="revenueConfirmStatus != null">revenue_confirm_status = #{revenueConfirmStatus},</if>
            <if test="revenueConfirmYear != null">revenue_confirm_year = #{revenueConfirmYear},</if>
            <if test="confirmAmount != null">confirm_amount = #{confirmAmount},</if>
            <if test="afterTaxAmount != null">after_tax_amount = #{afterTaxAmount},</if>
            <if test="companyRevenueConfirmedByName != null">company_revenue_confirmed_by_name = #{companyRevenueConfirmedByName},</if>
        </trim>
        where project_id = #{projectId}
    </update>

    <delete id="deleteProjectByProjectId" parameterType="Long">
        delete from pm_project where project_id = #{projectId}
    </delete>

    <delete id="deleteProjectByProjectIds" parameterType="String">
        delete from pm_project where project_id in 
        <foreach item="projectId" collection="array" open="(" separator="," close=")">
            #{projectId}
        </foreach>
    </delete>
    
    <delete id="deleteProjectApprovalByProjectIds" parameterType="String">
        delete from pm_project_approval where project_id in 
        <foreach item="projectId" collection="array" open="(" separator="," close=")">
            #{projectId}
        </foreach>
    </delete>

    <delete id="deleteProjectApprovalByProjectId" parameterType="Long">
        delete from pm_project_approval where project_id = #{projectId}
    </delete>

    <insert id="batchProjectApproval">
        insert into pm_project_approval( approval_id, project_id, approval_status, approval_reason, approver_id, approval_time, del_flag, create_by, create_time, update_by, update_time, remark) values
        <foreach item="item" index="index" collection="list" separator=",">
            ( #{item.approvalId}, #{item.projectId}, #{item.approvalStatus}, #{item.approvalReason}, #{item.approverId}, #{item.approvalTime}, #{item.delFlag}, #{item.createBy}, #{item.createTime}, #{item.updateBy}, #{item.updateTime}, #{item.remark})
        </foreach>
    </insert>

    <select id="selectProjectListByContractId" parameterType="Long" resultMap="ProjectResult">
        SELECT
            p.project_id, p.project_code, p.project_name, p.project_full_name,
            p.industry, p.region, p.short_name, p.established_year,
            p.project_category, p.project_dept, p.project_status, p.acceptance_status,
            p.project_manager_id, p.market_manager_id,
            pm.nick_name AS project_manager_name,
            mm.nick_name AS market_manager_name
        FROM pm_project p
        INNER JOIN pm_project_contract_rel pcr ON p.project_id = pcr.project_id
        LEFT JOIN sys_user pm ON p.project_manager_id = pm.user_id
        LEFT JOIN sys_user mm ON p.market_manager_id = mm.user_id
        WHERE pcr.contract_id = #{contractId}
        AND pcr.del_flag = '0'
        AND p.del_flag = '0'
        ORDER BY p.create_time DESC
    </select>

    <select id="selectProjectListByDept" resultMap="ProjectResult">
        SELECT
            p.project_id, p.project_code, p.project_name, p.project_budget,
            p.estimated_workload, p.actual_workload, p.project_dept
        FROM pm_project p
        WHERE p.del_flag = '0'
        <if test="deptId != null">
            AND (
                p.project_dept = CAST(#{deptId} AS CHAR)
                OR p.project_dept IN (
                    SELECT dept_id FROM sys_dept
                    WHERE del_flag = '0'
                    AND FIND_IN_SET(#{deptId}, ancestors)
                )
            )
        </if>
        AND (
            p.project_id NOT IN (
                SELECT project_id FROM pm_project_contract_rel
                WHERE del_flag = '0'
            )
            <if test="excludeContractId != null">
                OR p.project_id IN (
                    SELECT project_id FROM pm_project_contract_rel
                    WHERE del_flag = '0'
                    AND contract_id = #{excludeContractId}
                )
            </if>
        )
        ORDER BY p.create_time DESC
    </select>

    <select id="selectProjectNameList" parameterType="String" resultType="String">
        SELECT DISTINCT project_name
        FROM pm_project
        WHERE del_flag = '0'
        <if test="projectName != null and projectName != ''">
            AND project_name LIKE CONCAT('%', #{projectName}, '%')
        </if>
        ORDER BY project_name
        LIMIT 10
    </select>

    <select id="selectProjectCodeList" parameterType="String" resultType="String">
        SELECT DISTINCT project_code
        FROM pm_project
        WHERE del_flag = '0'
        <if test="projectCode != null and projectCode != ''">
            AND project_code LIKE CONCAT('%', #{projectCode}, '%')
        </if>
        ORDER BY project_code
        LIMIT 10
    </select>

    <select id="selectProjectSummary" parameterType="Project" resultType="map">
        SELECT
            IFNULL(SUM(p.project_budget), 0) as projectBudgetSum,
            IFNULL(SUM(p.project_cost), 0) as projectCostSum
        FROM pm_project p
        <where>
            p.del_flag = '0'
            <if test="projectName != null and projectName != ''">
                AND p.project_name LIKE CONCAT('%', #{projectName}, '%')
            </if>
            <if test="region != null and region != ''">
                AND p.region = #{region}
            </if>
            <if test="establishedYear != null">
                AND p.established_year = #{establishedYear}
            </if>
            <if test="projectCategory != null and projectCategory != ''">
                AND p.project_category = #{projectCategory}
            </if>
            <if test="projectDept != null and projectDept != ''">
                AND p.project_dept = #{projectDept}
            </if>
            <if test="projectStatus != null and projectStatus != ''">
                AND p.project_status = #{projectStatus}
            </if>
            <if test="acceptanceStatus != null and acceptanceStatus != ''">
                AND p.acceptance_status = #{acceptanceStatus}
            </if>
            <if test="projectManagerId != null">
                AND p.project_manager_id = #{projectManagerId}
            </if>
            <if test="marketManagerId != null">
                AND p.market_manager_id = #{marketManagerId}
            </if>
            <if test="approvalStatus != null and approvalStatus != ''">
                AND p.approval_status = #{approvalStatus}
            </if>
            <if test="regionCode != null and regionCode != ''">
                AND p.region_code = #{regionCode}
            </if>
            <if test="revenueConfirmStatus != null and revenueConfirmStatus != ''">
                AND p.revenue_confirm_status = #{revenueConfirmStatus}
            </if>
            <if test="revenueConfirmYear != null and revenueConfirmYear != ''">
                AND p.revenue_confirm_year = #{revenueConfirmYear}
            </if>
        </where>
    </select>
</mapper>