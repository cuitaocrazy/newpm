<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.project.mapper.ProjectMapper">
    
    <resultMap type="Project" id="ProjectResult">
        <result property="projectId"    column="project_id"    />
        <result property="projectCode"    column="project_code"    />
        <result property="projectName"    column="project_name"    />
        <result property="industry"    column="industry"    />
        <result property="region"    column="region"    />
        <result property="regionId"    column="region_id"    />
        <result property="regionName"    column="region_name"    />
        <result property="shortName"    column="short_name"    />
        <result property="establishedYear"    column="established_year"    />
        <result property="projectCategory"    column="project_category"    />
        <result property="projectDept"    column="project_dept"    />
        <result property="projectStage"    column="project_stage"    />
        <result property="acceptanceStatus"    column="acceptance_status"    />
        <result property="estimatedWorkload"    column="estimated_workload"    />
        <result property="actualWorkload"    column="actual_workload"    />
        <result property="projectAddress"    column="project_address"    />
        <result property="projectPlan"    column="project_plan"    />
        <result property="projectDescription"    column="project_description"    />
        <result property="projectManagerId"    column="project_manager_id"    />
        <result property="marketManagerId"    column="market_manager_id"    />
        <result property="participants"    column="participants"    />
        <result property="salesManagerId"    column="sales_manager_id"    />
        <result property="salesContact"    column="sales_contact"    />
        <result property="teamLeaderId"    column="team_leader_id"    />
        <result property="customerId"    column="customer_id"    />
        <result property="customerContactId"    column="customer_contact_id"    />
        <result property="merchantContact"    column="merchant_contact"    />
        <result property="merchantPhone"    column="merchant_phone"    />
        <result property="startDate"    column="start_date"    />
        <result property="endDate"    column="end_date"    />
        <result property="productionDate"    column="production_date"    />
        <result property="acceptanceDate"    column="acceptance_date"    />
        <result property="projectBudget"    column="project_budget"    />
        <result property="projectCost"    column="project_cost"    />
        <result property="expenseBudget"    column="expense_budget"    />
        <result property="costBudget"    column="cost_budget"    />
        <result property="laborCost"    column="labor_cost"    />
        <result property="purchaseCost"    column="purchase_cost"    />
        <result property="approvalStatus"    column="approval_status"    />
        <result property="approvalReason"    column="approval_reason"    />
        <result property="approvalTime"    column="approval_time"    />
        <result property="approverId"    column="approver_id"    />
        <result property="industryCode"    column="industry_code"    />
        <result property="regionCode"    column="region_code"    />
        <result property="remark"    column="remark"    />
        <result property="taxRate"    column="tax_rate"    />
        <result property="confirmUserId"    column="confirm_user_id"    />
        <result property="confirmTime"    column="confirm_time"    />
        <result property="reservedField1"    column="reserved_field1"    />
        <result property="reservedField2"    column="reserved_field2"    />
        <result property="reservedField3"    column="reserved_field3"    />
        <result property="reservedField4"    column="reserved_field4"    />
        <result property="reservedField5"    column="reserved_field5"    />
        <result property="delFlag"    column="del_flag"    />
        <result property="createBy"    column="create_by"    />
        <result property="createTime"    column="create_time"    />
        <result property="updateBy"    column="update_by"    />
        <result property="updateTime"    column="update_time"    />
        <result property="revenueConfirmStatus"    column="revenue_confirm_status"    />
        <result property="revenueConfirmYear"    column="revenue_confirm_year"    />
        <result property="confirmAmount"    column="confirm_amount"    />
        <result property="afterTaxAmount"    column="after_tax_amount"    />
        <result property="companyRevenueConfirmedBy"    column="company_revenue_confirmed_by"    />
        <result property="companyRevenueConfirmedTime"    column="company_revenue_confirmed_time"    />
        <!-- 关联字段 -->
        <result property="contractAmount"    column="contract_amount"    />
        <result property="contractStatus"    column="contract_status"    />
        <result property="deptName"    column="dept_name"    />
        <result property="projectManagerName"    column="project_manager_name"    />
        <result property="marketManagerName"    column="market_manager_name"    />
        <result property="salesManagerName"    column="sales_manager_name"    />
        <result property="customerName"    column="customer_name"    />
        <result property="customerContactName"    column="customer_contact_name"    />
        <result property="customerContactPhone"    column="customer_contact_phone"    />
    </resultMap>

    <sql id="selectProjectVo">
        select project_id, project_code, project_name, industry, region, region_id, short_name,
               established_year, project_category, project_dept, project_stage, acceptance_status,
               estimated_workload, actual_workload, project_address, project_plan, project_description,
               project_manager_id, market_manager_id, participants, sales_manager_id, sales_contact,
               team_leader_id, customer_id, customer_contact_id, merchant_contact, merchant_phone,
               start_date, end_date, production_date, acceptance_date, project_budget, project_cost,
               expense_budget, cost_budget, labor_cost, purchase_cost, approval_status, approval_reason,
               approval_time, approver_id, industry_code, region_code, remark, tax_rate, confirm_user_id, confirm_time,
               reserved_field1, reserved_field2, reserved_field3, reserved_field4, reserved_field5,
               del_flag, create_by, create_time, update_by, update_time, revenue_confirm_status,
               revenue_confirm_year, confirm_amount, after_tax_amount, company_revenue_confirmed_by,
               company_revenue_confirmed_time
        from pm_project
    </sql>

    <select id="selectProjectList" parameterType="Project" resultMap="ProjectResult">
        SELECT p.project_id, p.project_code, p.project_name, p.industry, p.region, p.region_id, p.short_name,
               p.established_year, p.project_category, p.project_dept, p.project_stage, p.acceptance_status,
               p.estimated_workload, p.actual_workload, p.project_address, p.project_plan, p.project_description,
               p.project_manager_id, p.market_manager_id, p.participants, p.sales_manager_id, p.sales_contact,
               p.team_leader_id, p.customer_id, p.customer_contact_id, p.merchant_contact, p.merchant_phone,
               p.start_date, p.end_date, p.production_date, p.acceptance_date, p.project_budget, p.project_cost,
               p.expense_budget, p.cost_budget, p.labor_cost, p.purchase_cost, p.approval_status, p.approval_reason,
               p.industry_code, p.region_code, p.remark, p.tax_rate, p.confirm_user_id, p.confirm_time,
               p.reserved_field1, p.reserved_field2, p.reserved_field3, p.reserved_field4, p.reserved_field5,
               p.del_flag, p.create_by, p.create_time, p.update_by, p.update_time, p.revenue_confirm_status,
               p.revenue_confirm_year, p.confirm_amount, p.after_tax_amount, p.company_revenue_confirmed_by,
               p.company_revenue_confirmed_time,
               sr.region_name,
               pcr.contract_id as contractId,
               c.contract_amount, c.contract_status
        FROM pm_project p
        LEFT JOIN pm_secondary_region sr ON p.region_id = sr.region_id
        LEFT JOIN pm_project_contract_rel pcr ON p.project_id = pcr.project_id
        LEFT JOIN pm_contract c ON pcr.contract_id = c.contract_id
        <where>
            p.del_flag = '0'
            <if test="projectCode != null  and projectCode != ''"> and p.project_code = #{projectCode}</if>
            <if test="projectName != null  and projectName != ''"> and p.project_name like concat('%', #{projectName}, '%')</if>
            <if test="industry != null  and industry != ''"> and p.industry = #{industry}</if>
            <if test="region != null  and region != ''"> and p.region = #{region}</if>
            <if test="regionId != null "> and p.region_id = #{regionId}</if>
            <if test="shortName != null  and shortName != ''"> and p.short_name like concat('%', #{shortName}, '%')</if>
            <if test="establishedYear != null "> and p.established_year = #{establishedYear}</if>
            <if test="projectCategory != null  and projectCategory != ''"> and p.project_category = #{projectCategory}</if>
            <if test="projectDept != null  and projectDept != ''"> and p.project_dept = #{projectDept}</if>
            <if test="projectStage != null  and projectStage != ''"> and p.project_stage = #{projectStage}</if>
            <if test="acceptanceStatus != null  and acceptanceStatus != ''"> and p.acceptance_status = #{acceptanceStatus}</if>
            <if test="estimatedWorkload != null "> and p.estimated_workload = #{estimatedWorkload}</if>
            <if test="actualWorkload != null "> and p.actual_workload = #{actualWorkload}</if>
            <if test="projectAddress != null  and projectAddress != ''"> and p.project_address = #{projectAddress}</if>
            <if test="projectPlan != null  and projectPlan != ''"> and p.project_plan = #{projectPlan}</if>
            <if test="projectDescription != null  and projectDescription != ''"> and p.project_description = #{projectDescription}</if>
            <if test="projectManagerId != null "> and p.project_manager_id = #{projectManagerId}</if>
            <if test="marketManagerId != null "> and p.market_manager_id = #{marketManagerId}</if>
            <if test="participants != null  and participants != ''"> and p.participants = #{participants}</if>
            <if test="salesManagerId != null "> and p.sales_manager_id = #{salesManagerId}</if>
            <if test="salesContact != null  and salesContact != ''"> and p.sales_contact = #{salesContact}</if>
            <if test="teamLeaderId != null "> and p.team_leader_id = #{teamLeaderId}</if>
            <if test="customerId != null "> and p.customer_id = #{customerId}</if>
            <if test="customerContactId != null "> and p.customer_contact_id = #{customerContactId}</if>
            <if test="merchantContact != null  and merchantContact != ''"> and p.merchant_contact = #{merchantContact}</if>
            <if test="merchantPhone != null  and merchantPhone != ''"> and p.merchant_phone = #{merchantPhone}</if>
            <if test="startDate != null "> and p.start_date = #{startDate}</if>
            <if test="endDate != null "> and p.end_date = #{endDate}</if>
            <if test="productionDate != null "> and p.production_date = #{productionDate}</if>
            <if test="acceptanceDate != null "> and p.acceptance_date = #{acceptanceDate}</if>
            <if test="projectBudget != null "> and p.project_budget = #{projectBudget}</if>
            <if test="projectCost != null "> and p.project_cost = #{projectCost}</if>
            <if test="expenseBudget != null "> and p.expense_budget = #{expenseBudget}</if>
            <if test="costBudget != null "> and p.cost_budget = #{costBudget}</if>
            <if test="laborCost != null "> and p.labor_cost = #{laborCost}</if>
            <if test="purchaseCost != null "> and p.purchase_cost = #{purchaseCost}</if>
            <if test="approvalStatus != null  and approvalStatus != ''"> and p.approval_status = #{approvalStatus}</if>
            <if test="approvalReason != null  and approvalReason != ''"> and p.approval_reason = #{approvalReason}</if>
            <if test="industryCode != null  and industryCode != ''"> and p.industry_code = #{industryCode}</if>
            <if test="regionCode != null  and regionCode != ''"> and p.region_code = #{regionCode}</if>
            <if test="taxRate != null "> and p.tax_rate = #{taxRate}</if>
            <if test="confirmUserId != null "> and p.confirm_user_id = #{confirmUserId}</if>
            <if test="confirmTime != null "> and p.confirm_time = #{confirmTime}</if>
            <if test="reservedField1 != null  and reservedField1 != ''"> and p.reserved_field1 = #{reservedField1}</if>
            <if test="reservedField2 != null  and reservedField2 != ''"> and p.reserved_field2 = #{reservedField2}</if>
            <if test="reservedField3 != null  and reservedField3 != ''"> and p.reserved_field3 = #{reservedField3}</if>
            <if test="reservedField4 != null  and reservedField4 != ''"> and p.reserved_field4 = #{reservedField4}</if>
            <if test="reservedField5 != null  and reservedField5 != ''"> and p.reserved_field5 = #{reservedField5}</if>
            <if test="revenueConfirmStatus != null  and revenueConfirmStatus != ''"> and p.revenue_confirm_status = #{revenueConfirmStatus}</if>
            <if test="revenueConfirmYear != null  and revenueConfirmYear != ''"> and p.revenue_confirm_year = #{revenueConfirmYear}</if>
            <if test="confirmAmount != null "> and p.confirm_amount = #{confirmAmount}</if>
            <if test="afterTaxAmount != null "> and p.after_tax_amount = #{afterTaxAmount}</if>
            <if test="companyRevenueConfirmedBy != null  and companyRevenueConfirmedBy != ''"> and p.company_revenue_confirmed_by = #{companyRevenueConfirmedBy}</if>
            <if test="companyRevenueConfirmedTime != null "> and p.company_revenue_confirmed_time = #{companyRevenueConfirmedTime}</if>
        </where>
    </select>

    <select id="selectProjectByProjectId" parameterType="Long" resultMap="ProjectResult">
        SELECT p.project_id, p.project_code, p.project_name, p.industry, p.region, p.region_id, p.short_name,
               p.established_year, p.project_category, p.project_dept, p.project_stage, p.acceptance_status,
               p.estimated_workload, p.actual_workload, p.project_address, p.project_plan, p.project_description,
               p.project_manager_id, p.market_manager_id, p.participants, p.sales_manager_id, p.sales_contact,
               p.team_leader_id, p.customer_id, p.customer_contact_id, p.merchant_contact, p.merchant_phone,
               p.start_date, p.end_date, p.production_date, p.acceptance_date, p.project_budget, p.project_cost,
               p.expense_budget, p.cost_budget, p.labor_cost, p.purchase_cost, p.approval_status, p.approval_reason,
               p.approval_time, p.approver_id, p.industry_code, p.region_code, p.remark, p.tax_rate, p.confirm_user_id, p.confirm_time,
               p.reserved_field1, p.reserved_field2, p.reserved_field3, p.reserved_field4, p.reserved_field5,
               p.del_flag, p.create_by, p.create_time, p.update_by, p.update_time, p.revenue_confirm_status,
               p.revenue_confirm_year, p.confirm_amount, p.after_tax_amount, p.company_revenue_confirmed_by,
               p.company_revenue_confirmed_time,
               d.dept_name AS dept_name,
               sr.region_name AS region_name,
               u1.nick_name AS project_manager_name,
               u2.nick_name AS market_manager_name,
               u3.nick_name AS sales_manager_name,
               c.customer_simple_name AS customer_name,
               cc.contact_name AS customer_contact_name,
               cc.contact_phone AS customer_contact_phone
        FROM pm_project p
        LEFT JOIN sys_dept d ON CAST(p.project_dept AS CHAR) COLLATE utf8mb4_unicode_ci = CAST(d.dept_id AS CHAR)
        LEFT JOIN pm_secondary_region sr ON p.region_id = sr.region_id
        LEFT JOIN sys_user u1 ON p.project_manager_id = u1.user_id
        LEFT JOIN sys_user u2 ON p.market_manager_id = u2.user_id
        LEFT JOIN sys_user u3 ON p.sales_manager_id = u3.user_id
        LEFT JOIN pm_customer c ON p.customer_id = c.customer_id
        LEFT JOIN pm_customer_contact cc ON p.customer_contact_id = cc.contact_id
        WHERE p.project_id = #{projectId} AND p.del_flag = '0'
    </select>

    <insert id="insertProject" parameterType="Project" useGeneratedKeys="true" keyProperty="projectId">
        insert into pm_project
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="projectCode != null and projectCode != ''">project_code,</if>
            <if test="projectName != null and projectName != ''">project_name,</if>
            <if test="industry != null">industry,</if>
            <if test="region != null">region,</if>
            <if test="regionId != null">region_id,</if>
            <if test="shortName != null">short_name,</if>
            <if test="establishedYear != null">established_year,</if>
            <if test="projectCategory != null">project_category,</if>
            <if test="projectDept != null">project_dept,</if>
            <if test="projectStage != null">project_stage,</if>
            <if test="acceptanceStatus != null">acceptance_status,</if>
            <if test="estimatedWorkload != null">estimated_workload,</if>
            <if test="actualWorkload != null">actual_workload,</if>
            <if test="projectAddress != null">project_address,</if>
            <if test="projectPlan != null">project_plan,</if>
            <if test="projectDescription != null">project_description,</if>
            <if test="projectManagerId != null">project_manager_id,</if>
            <if test="marketManagerId != null">market_manager_id,</if>
            <if test="participants != null">participants,</if>
            <if test="salesManagerId != null">sales_manager_id,</if>
            <if test="salesContact != null">sales_contact,</if>
            <if test="teamLeaderId != null">team_leader_id,</if>
            <if test="customerId != null">customer_id,</if>
            <if test="customerContactId != null">customer_contact_id,</if>
            <if test="merchantContact != null">merchant_contact,</if>
            <if test="merchantPhone != null">merchant_phone,</if>
            <if test="startDate != null">start_date,</if>
            <if test="endDate != null">end_date,</if>
            <if test="productionDate != null">production_date,</if>
            <if test="acceptanceDate != null">acceptance_date,</if>
            <if test="projectBudget != null">project_budget,</if>
            <if test="projectCost != null">project_cost,</if>
            <if test="expenseBudget != null">expense_budget,</if>
            <if test="costBudget != null">cost_budget,</if>
            <if test="laborCost != null">labor_cost,</if>
            <if test="purchaseCost != null">purchase_cost,</if>
            <if test="approvalStatus != null">approval_status,</if>
            <if test="approvalReason != null">approval_reason,</if>
            <if test="industryCode != null">industry_code,</if>
            <if test="regionCode != null">region_code,</if>
            <if test="remark != null">remark,</if>
            <if test="taxRate != null">tax_rate,</if>
            <if test="confirmUserId != null">confirm_user_id,</if>
            <if test="confirmTime != null">confirm_time,</if>
            <if test="reservedField1 != null">reserved_field1,</if>
            <if test="reservedField2 != null">reserved_field2,</if>
            <if test="reservedField3 != null">reserved_field3,</if>
            <if test="reservedField4 != null">reserved_field4,</if>
            <if test="reservedField5 != null">reserved_field5,</if>
            <if test="delFlag != null">del_flag,</if>
            <if test="createBy != null">create_by,</if>
            <if test="createTime != null">create_time,</if>
            <if test="updateBy != null">update_by,</if>
            <if test="updateTime != null">update_time,</if>
            <if test="revenueConfirmStatus != null">revenue_confirm_status,</if>
            <if test="revenueConfirmYear != null">revenue_confirm_year,</if>
            <if test="confirmAmount != null">confirm_amount,</if>
            <if test="afterTaxAmount != null">after_tax_amount,</if>
            <if test="companyRevenueConfirmedBy != null">company_revenue_confirmed_by,</if>
            <if test="companyRevenueConfirmedTime != null">company_revenue_confirmed_time,</if>
         </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="projectCode != null and projectCode != ''">#{projectCode},</if>
            <if test="projectName != null and projectName != ''">#{projectName},</if>
            <if test="industry != null">#{industry},</if>
            <if test="region != null">#{region},</if>
            <if test="regionId != null">#{regionId},</if>
            <if test="shortName != null">#{shortName},</if>
            <if test="establishedYear != null">#{establishedYear},</if>
            <if test="projectCategory != null">#{projectCategory},</if>
            <if test="projectDept != null">#{projectDept},</if>
            <if test="projectStage != null">#{projectStage},</if>
            <if test="acceptanceStatus != null">#{acceptanceStatus},</if>
            <if test="estimatedWorkload != null">#{estimatedWorkload},</if>
            <if test="actualWorkload != null">#{actualWorkload},</if>
            <if test="projectAddress != null">#{projectAddress},</if>
            <if test="projectPlan != null">#{projectPlan},</if>
            <if test="projectDescription != null">#{projectDescription},</if>
            <if test="projectManagerId != null">#{projectManagerId},</if>
            <if test="marketManagerId != null">#{marketManagerId},</if>
            <if test="participants != null">#{participants},</if>
            <if test="salesManagerId != null">#{salesManagerId},</if>
            <if test="salesContact != null">#{salesContact},</if>
            <if test="teamLeaderId != null">#{teamLeaderId},</if>
            <if test="customerId != null">#{customerId},</if>
            <if test="customerContactId != null">#{customerContactId},</if>
            <if test="merchantContact != null">#{merchantContact},</if>
            <if test="merchantPhone != null">#{merchantPhone},</if>
            <if test="startDate != null">#{startDate},</if>
            <if test="endDate != null">#{endDate},</if>
            <if test="productionDate != null">#{productionDate},</if>
            <if test="acceptanceDate != null">#{acceptanceDate},</if>
            <if test="projectBudget != null">#{projectBudget},</if>
            <if test="projectCost != null">#{projectCost},</if>
            <if test="expenseBudget != null">#{expenseBudget},</if>
            <if test="costBudget != null">#{costBudget},</if>
            <if test="laborCost != null">#{laborCost},</if>
            <if test="purchaseCost != null">#{purchaseCost},</if>
            <if test="approvalStatus != null">#{approvalStatus},</if>
            <if test="approvalReason != null">#{approvalReason},</if>
            <if test="industryCode != null">#{industryCode},</if>
            <if test="regionCode != null">#{regionCode},</if>
            <if test="remark != null">#{remark},</if>
            <if test="taxRate != null">#{taxRate},</if>
            <if test="confirmUserId != null">#{confirmUserId},</if>
            <if test="confirmTime != null">#{confirmTime},</if>
            <if test="reservedField1 != null">#{reservedField1},</if>
            <if test="reservedField2 != null">#{reservedField2},</if>
            <if test="reservedField3 != null">#{reservedField3},</if>
            <if test="reservedField4 != null">#{reservedField4},</if>
            <if test="reservedField5 != null">#{reservedField5},</if>
            <if test="delFlag != null">#{delFlag},</if>
            <if test="createBy != null">#{createBy},</if>
            <if test="createTime != null">#{createTime},</if>
            <if test="updateBy != null">#{updateBy},</if>
            <if test="updateTime != null">#{updateTime},</if>
            <if test="revenueConfirmStatus != null">#{revenueConfirmStatus},</if>
            <if test="revenueConfirmYear != null">#{revenueConfirmYear},</if>
            <if test="confirmAmount != null">#{confirmAmount},</if>
            <if test="afterTaxAmount != null">#{afterTaxAmount},</if>
            <if test="companyRevenueConfirmedBy != null">#{companyRevenueConfirmedBy},</if>
            <if test="companyRevenueConfirmedTime != null">#{companyRevenueConfirmedTime},</if>
         </trim>
    </insert>

    <update id="updateProject" parameterType="Project">
        update pm_project
        <trim prefix="SET" suffixOverrides=",">
            <if test="projectCode != null and projectCode != ''">project_code = #{projectCode},</if>
            <if test="projectName != null and projectName != ''">project_name = #{projectName},</if>
            <if test="industry != null">industry = #{industry},</if>
            <if test="region != null">region = #{region},</if>
            <if test="regionId != null">region_id = #{regionId},</if>
            <if test="shortName != null">short_name = #{shortName},</if>
            <if test="establishedYear != null">established_year = #{establishedYear},</if>
            <if test="projectCategory != null">project_category = #{projectCategory},</if>
            <if test="projectDept != null">project_dept = #{projectDept},</if>
            <if test="projectStage != null">project_stage = #{projectStage},</if>
            <if test="acceptanceStatus != null">acceptance_status = #{acceptanceStatus},</if>
            <if test="estimatedWorkload != null">estimated_workload = #{estimatedWorkload},</if>
            <if test="actualWorkload != null">actual_workload = #{actualWorkload},</if>
            <if test="projectAddress != null">project_address = #{projectAddress},</if>
            <if test="projectPlan != null">project_plan = #{projectPlan},</if>
            <if test="projectDescription != null">project_description = #{projectDescription},</if>
            <if test="projectManagerId != null">project_manager_id = #{projectManagerId},</if>
            <if test="marketManagerId != null">market_manager_id = #{marketManagerId},</if>
            <if test="participants != null">participants = #{participants},</if>
            <if test="salesManagerId != null">sales_manager_id = #{salesManagerId},</if>
            <if test="salesContact != null">sales_contact = #{salesContact},</if>
            <if test="teamLeaderId != null">team_leader_id = #{teamLeaderId},</if>
            <if test="customerId != null">customer_id = #{customerId},</if>
            <if test="customerContactId != null">customer_contact_id = #{customerContactId},</if>
            <if test="merchantContact != null">merchant_contact = #{merchantContact},</if>
            <if test="merchantPhone != null">merchant_phone = #{merchantPhone},</if>
            <if test="startDate != null">start_date = #{startDate},</if>
            <if test="endDate != null">end_date = #{endDate},</if>
            <if test="productionDate != null">production_date = #{productionDate},</if>
            <if test="acceptanceDate != null">acceptance_date = #{acceptanceDate},</if>
            <if test="projectBudget != null">project_budget = #{projectBudget},</if>
            <if test="projectCost != null">project_cost = #{projectCost},</if>
            <if test="expenseBudget != null">expense_budget = #{expenseBudget},</if>
            <if test="costBudget != null">cost_budget = #{costBudget},</if>
            <if test="laborCost != null">labor_cost = #{laborCost},</if>
            <if test="purchaseCost != null">purchase_cost = #{purchaseCost},</if>
            <if test="approvalStatus != null">approval_status = #{approvalStatus},</if>
            <if test="approvalReason != null">approval_reason = #{approvalReason},</if>
            <if test="industryCode != null">industry_code = #{industryCode},</if>
            <if test="regionCode != null">region_code = #{regionCode},</if>
            <if test="remark != null">remark = #{remark},</if>
            <if test="taxRate != null">tax_rate = #{taxRate},</if>
            <if test="confirmUserId != null">confirm_user_id = #{confirmUserId},</if>
            <if test="confirmTime != null">confirm_time = #{confirmTime},</if>
            <if test="reservedField1 != null">reserved_field1 = #{reservedField1},</if>
            <if test="reservedField2 != null">reserved_field2 = #{reservedField2},</if>
            <if test="reservedField3 != null">reserved_field3 = #{reservedField3},</if>
            <if test="reservedField4 != null">reserved_field4 = #{reservedField4},</if>
            <if test="reservedField5 != null">reserved_field5 = #{reservedField5},</if>
            <if test="delFlag != null">del_flag = #{delFlag},</if>
            <if test="createBy != null">create_by = #{createBy},</if>
            <if test="createTime != null">create_time = #{createTime},</if>
            <if test="updateBy != null">update_by = #{updateBy},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
            <if test="revenueConfirmStatus != null">revenue_confirm_status = #{revenueConfirmStatus},</if>
            <if test="revenueConfirmYear != null">revenue_confirm_year = #{revenueConfirmYear},</if>
            <if test="confirmAmount != null">confirm_amount = #{confirmAmount},</if>
            <if test="afterTaxAmount != null">after_tax_amount = #{afterTaxAmount},</if>
            <if test="companyRevenueConfirmedBy != null">company_revenue_confirmed_by = #{companyRevenueConfirmedBy},</if>
            <if test="companyRevenueConfirmedTime != null">company_revenue_confirmed_time = #{companyRevenueConfirmedTime},</if>
        </trim>
        where project_id = #{projectId}
    </update>

    <update id="deleteProjectByProjectId" parameterType="Long">
        update pm_project set del_flag = '1' where project_id = #{projectId}
    </update>

    <update id="deleteProjectByProjectIds" parameterType="String">
        update pm_project set del_flag = '1' where project_id in
        <foreach item="projectId" collection="array" open="(" separator="," close=")">
            #{projectId}
        </foreach>
    </update>

    <!-- 获取用户列表（按岗位过滤） -->
    <select id="selectUsersByPost" resultType="map">
        SELECT DISTINCT
            u.user_id AS userId,
            u.nick_name AS nickName,
            u.phonenumber AS phonenumber
        FROM sys_user u
        LEFT JOIN sys_user_post up ON u.user_id = up.user_id
        LEFT JOIN sys_post p ON up.post_id = p.post_id
        WHERE u.del_flag = '0'
        <if test="postCode != null and postCode != ''">
            AND p.post_code = #{postCode}
        </if>
        ORDER BY u.user_id
    </select>

    <!-- 获取二级区域列表（根据一级区域） -->
    <select id="selectSecondaryRegionsByRegion" resultType="map">
        SELECT
            region_id AS regionId,
            region_name AS regionName,
            region_code AS regionCode
        FROM pm_secondary_region
        WHERE region_dict_value = #{regionDictValue}
        AND del_flag = '0'
        ORDER BY region_id
    </select>

    <!-- 获取客户列表（支持搜索） -->
    <select id="selectCustomers" resultType="map">
        SELECT
            customer_id AS customerId,
            customer_simple_name AS customerSimpleName,
            customer_full_name AS customerFullName
        FROM pm_customer
        WHERE del_flag = '0'
        <if test="customerSimpleName != null and customerSimpleName != ''">
            AND customer_simple_name LIKE CONCAT('%', #{customerSimpleName}, '%')
        </if>
        ORDER BY customer_id
    </select>

    <!-- 获取客户联系人列表（根据客户ID） -->
    <select id="selectCustomerContacts" resultType="map">
        SELECT
            contact_id AS contactId,
            contact_name AS contactName,
            contact_phone AS contactPhone,
            contact_email AS contactEmail
        FROM pm_customer_contact
        WHERE customer_id = #{customerId}
        AND del_flag = '0'
        ORDER BY contact_id
    </select>

    <!-- 获取部门树（返回所有部门,前端过滤三级及以下用于选择） -->
    <select id="selectDeptTree" resultType="map">
        SELECT
            dept_id AS deptId,
            parent_id AS parentId,
            dept_name AS deptName,
            ancestors,
            order_num AS orderNum
        FROM sys_dept
        WHERE del_flag = '0'
        AND status = '0'
        ORDER BY parent_id, order_num
    </select>

    <!-- 查询待审核项目列表 -->
    <select id="selectReviewList" parameterType="Project" resultMap="ProjectResult">
        SELECT p.project_id, p.project_code, p.project_name, p.industry, p.region, p.region_id, p.short_name,
               p.established_year, p.project_category, p.project_dept, p.project_stage, p.acceptance_status,
               p.estimated_workload, p.actual_workload, p.project_address, p.project_plan, p.project_description,
               p.project_manager_id, p.market_manager_id, p.participants, p.sales_manager_id, p.sales_contact,
               p.team_leader_id, p.customer_id, p.customer_contact_id, p.merchant_contact, p.merchant_phone,
               p.start_date, p.end_date, p.production_date, p.acceptance_date, p.project_budget, p.project_cost,
               p.expense_budget, p.cost_budget, p.labor_cost, p.purchase_cost, p.approval_status, p.approval_reason,
               p.industry_code, p.region_code, p.remark, p.tax_rate, p.confirm_user_id, p.confirm_time,
               p.reserved_field1, p.reserved_field2, p.reserved_field3, p.reserved_field4, p.reserved_field5,
               p.del_flag, p.create_by, p.create_time, p.update_by, p.update_time, p.revenue_confirm_status,
               p.revenue_confirm_year, p.confirm_amount, p.after_tax_amount, p.company_revenue_confirmed_by,
               p.company_revenue_confirmed_time,
               d.dept_name AS dept_name,
               sr.region_name AS region_name,
               u2.nick_name AS project_manager_name,
               u3.nick_name AS market_manager_name
        FROM pm_project p
        LEFT JOIN sys_dept d ON CAST(p.project_dept AS CHAR) COLLATE utf8mb4_unicode_ci = CAST(d.dept_id AS CHAR)
        LEFT JOIN sys_user u1 ON p.create_by COLLATE utf8mb4_unicode_ci = u1.user_name
        LEFT JOIN sys_user u2 ON p.project_manager_id = u2.user_id
        LEFT JOIN sys_user u3 ON p.market_manager_id = u3.user_id
        LEFT JOIN pm_secondary_region sr ON p.region_id = sr.region_id
        WHERE p.del_flag = '0'
        AND (p.approval_status = '0' OR p.approval_status IS NULL)
        <if test="projectName != null and projectName != ''">
            AND p.project_name LIKE CONCAT('%', #{projectName}, '%')
        </if>
        <if test="projectCode != null and projectCode != ''">
            AND p.project_code LIKE CONCAT('%', #{projectCode}, '%')
        </if>
        <if test="projectCategory != null and projectCategory != ''">
            AND p.project_category = #{projectCategory}
        </if>
        <if test="projectDept != null">
            AND p.project_dept = #{projectDept}
        </if>
        <if test="region != null and region != ''">
            AND p.region = #{region}
        </if>
        <if test="regionId != null">
            AND p.region_id = #{regionId}
        </if>
        <if test="projectManagerId != null">
            AND p.project_manager_id = #{projectManagerId}
        </if>
        <if test="marketManagerId != null">
            AND p.market_manager_id = #{marketManagerId}
        </if>
        <if test="establishedYear != null">
            AND p.established_year = #{establishedYear}
        </if>
        ${params.dataScope}
        ORDER BY p.create_time DESC
    </select>

    <!-- 根据部门查询项目列表（用于合同关联，可排除已关联的项目） -->
    <select id="selectProjectListByDept" resultMap="ProjectResult">
        SELECT
            p.project_id,
            p.project_name,
            p.project_code,
            p.project_budget,
            p.estimated_workload
        FROM pm_project p
        WHERE p.del_flag = '0'
          AND p.project_dept = #{deptId}
          AND p.approval_status = '1'
          <if test="excludeContractId != null">
              AND p.project_id NOT IN (
                  SELECT DISTINCT rel.project_id
                  FROM pm_project_contract_rel rel
                  WHERE rel.contract_id != #{excludeContractId}
              )
          </if>
          <if test="excludeContractId == null">
              AND p.project_id NOT IN (
                  SELECT DISTINCT rel.project_id
                  FROM pm_project_contract_rel rel
              )
          </if>
        ORDER BY p.create_time DESC
    </select>

    <!-- 根据合同ID查询关联的项目列表 -->
    <select id="selectProjectListByContractId" resultMap="ProjectResult">
        SELECT
            p.project_id,
            p.project_code,
            p.project_name,
            p.industry,
            p.region,
            p.region_id,
            p.short_name,
            p.established_year,
            p.project_category,
            p.project_dept,
            p.project_stage,
            p.acceptance_status,
            p.estimated_workload,
            p.actual_workload,
            p.project_address,
            p.project_plan,
            p.project_description,
            p.project_manager_id,
            p.market_manager_id,
            p.participants,
            p.sales_manager_id,
            p.sales_contact,
            p.team_leader_id,
            p.customer_id,
            p.customer_contact_id,
            p.merchant_contact,
            p.merchant_phone,
            p.start_date,
            p.end_date,
            p.production_date,
            p.acceptance_date,
            p.project_budget,
            p.project_cost,
            p.expense_budget,
            p.cost_budget,
            p.labor_cost,
            p.purchase_cost,
            p.approval_status,
            p.approval_reason,
            p.approval_time,
            p.approver_id,
            p.del_flag,
            p.create_by,
            p.create_time,
            p.update_by,
            p.update_time,
            p.remark
        FROM pm_project p
        INNER JOIN pm_project_contract_rel rel ON p.project_id = rel.project_id
        WHERE rel.contract_id = #{contractId}
          AND p.del_flag = '0'
          AND rel.del_flag = '0'
        ORDER BY p.create_time DESC
    </select>

    <!-- 项目搜索（轻量接口，用于 autocomplete） -->
    <select id="searchProjectsByName" resultType="java.util.Map">
        SELECT
            project_id as projectId,
            project_name as projectName,
            project_code as projectCode
        FROM pm_project
        WHERE del_flag = '0'
        <if test="projectName != null and projectName != ''">
            AND project_name LIKE CONCAT('%', #{projectName}, '%')
        </if>
        ORDER BY create_time DESC
        LIMIT 20
    </select>

</mapper>